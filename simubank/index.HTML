<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Simubank - Sistema de Gesti√≥n Bancaria</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
body {
  background: linear-gradient(135deg, #e6f0fa 0%, #f0f7ff 100%);
  color: #333;
  min-height: 100vh;
  margin: 0;
  font-family: 'Segoe UI', Arial, sans-serif;
}

.container {
  max-width: 1200px;
  margin: 20px auto;
  padding: 20px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
}
    #login-screen {
      background-color: #d4edf9;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    header {
      background: #003366;
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 8px 8px 0 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .logo {
      font-size: 1.5em;
      font-weight: bold;
      color: #fff;
    }
    .logout-btn {
      background: #d9534f;
      color: white;
      border: none;
      padding: 4px 8px;
      font-size: 0.8em;
      border-radius: 4px;
      cursor: pointer;
      min-width: 70px;
    }
    .logout-btn:hover {
      background: #c9302c;
    }
    .main-menu {
      display: flex;
      gap: 10px;
      margin: 20px 0;
    }
    .btn {
      padding: 12px 16px;
      background: #0056b3;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .btn:hover {
      background: #004085;
    }
    .module {
      display: none;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-top: 10px;
    }
    .active {
      display: block;
    }
    .card {
      background: #f8f9fa;
      padding: 15px;
      margin: 10px 0;
      border-left: 5px solid #0056b3;
      border-radius: 5px;
    }
      .grid-1 {
      display: grid;
      gap: 15px;
      grid-template-columns: 1fr;
    }
    .grid-2, .grid-3 {
      display: grid;
      gap: 15px;
    }
    .grid-2 { grid-template-columns: 1fr 1fr; }
    .grid-3 { grid-template-columns: 1fr 1fr 1fr; }
    input, select, button {
      padding: 10px;
      margin: 5px 0;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
    }
    table th, table td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    table th {
      background: #f1f1f1;
    }
    .transaccion-deposito {
      background-color: #d4edda;
    }
    .transaccion-retiro {
      background-color: #f8d7da;
    }
    .transaccion-pago {
      background-color: #cce5ff;
      color: #004085;
    }
    .transaccion-pago td {
      color: inherit;
    }
    .transaccion-cambio {
      background-color: #fff3cd;
      color: #856404;
    }
    .transaccion-cobro {
      background-color: #e2e3e5;
    }
    .alert {
      background: #f8d7da;
      color: #721c24;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    .success {
      background: #d4edda;
      color: #155724;
    }
    .warning {
      background: #fff3cd;
      color: #856404;
    }
    .hidden {
      display: none;
    }
    .balance-item {
      font-weight: bold;
      font-size: 1.2em;
      color: #003366;
    }
    footer {
      text-align: center;
      margin-top: 30px;
      color: #666;
      font-size: 0.9em;
    }
    .tarjeta {
      width: 320px;
      height: 200px;
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      color: white;
      border-radius: 15px;
      padding: 20px;
      margin: 20px auto;
      position: relative;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      font-size: 14px;
    }
    .tarjeta h3 {
      margin-bottom: 10px;
      font-size: 1.2em;
    }
    .tarjeta-numero {
      letter-spacing: 2px;
      font-family: monospace;
      font-size: 1.4em;
      margin: 10px 0;
    }
    .tarjeta-info {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
      font-size: 0.9em;
    }
    .chip {
      width: 50px;
      height: 40px;
      background: #ccc;
      border-radius: 8px;
      float: right;
    }
    .logo-tarjeta {
      position: absolute;
      bottom: 20px;
      right: 20px;
      font-weight: bold;
      font-size: 1.5em;
      color: rgba(255,255,255,0.8);
    }
    .productos-cliente {
      margin-top: 15px;
      padding: 15px;
      background: #f1f8ff;
      border-radius: 8px;
      border: 1px solid #cce5ff;
    }
.producto-item {
    margin: 12px 0;
    padding: 15px;
    background: white;
    border-left: 4px solid #0056b3;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.producto-item:nth-child(even) {
    border-left-color: #28a745;
}

.producto-item:nth-child(odd) {
    border-left-color: #dc3545;
}

.producto-titulo {
    font-weight: bold;
    color: #003366;
    font-size: 1.1em;
    margin-bottom: 8px;
}

.producto-info {
    font-size: 0.9em;
    color: #555;
    line-height: 1.5;
}

.productos-cliente {
    margin-top: 20px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}
    .producto-item {
      margin: 10px 0;
      padding: 10px;
      background: white;
      border-left: 4px solid #0056b3;
      border-radius: 4px;
    }
    .producto-titulo {
      font-weight: bold;
      color: #003366;
    }
    .producto-info {
      font-size: 0.9em;
      color: #555;
    }
    .tabs {
      display: flex;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
    }
    .tab-btn {
      padding: 10px 15px;
      background: #f1f1f1;
      border: none;
      cursor: pointer;
      border-radius: 5px 5px 0 0;
      margin-right: 5px;
    }
    .tab-btn.active {
      background: #0056b3;
      color: white;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .cuota-item {
      padding: 10px;
      margin: 5px 0;
      background: #f8f9fa;
      border-left: 4px solid #007bff;
      border-radius: 5px;
    }
    .cuota-pagada {
      background: #d4edda;
      border-left-color: #28a745;
      opacity: 0.7;
    }
    .cuota-actual {
      border-left-color: #dc3545;
      font-weight: bold;
    }
    /* Modal de balance */
    #modal-balance {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #modal-balance .modal-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      width: 400px;
      max-width: 90%;
    }
    /* Estilos para la nueva pesta√±a de consulta */
    .prestamo-item {
      padding: 15px;
      margin: 10px 0;
      background: #f8f9fa;
      border-left: 4px solid #0056b3;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .prestamo-item:hover {
      background: #e9ecef;
    }
    .prestamo-item h4 {
      margin: 0 0 5px 0;
      color: #003366;
    }
    .prestamo-item p {
      margin: 3px 0;
      font-size: 0.9em;
      color: #555;
    }
    .pagos-container {
      margin-top: 15px;
      padding: 15px;
      background: #f1f8ff;
      border-radius: 8px;
      border: 1px solid #007bff;
    }
    .pago-item {
      padding: 10px;
      margin: 5px 0;
      background: white;
      border-left: 3px solid #28a745;
      border-radius: 4px;
    }
    .pago-item strong {
      color: #003366;
    }
    /* Estilos para el m√≥dulo de Tasas de Cambio */
    .tasas-container {
      margin-top: 20px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }
    .tasa-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.1);
    }
    .tasa-card h4 {
      color: #003366;
      margin-bottom: 10px;
    }
    .tasa-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      align-items: center;
    }
    .tasa-row label {
      min-width: 120px;
      font-weight: bold;
    }
    .tasa-row input {
      flex: 1;
    }
    .tasa-update-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    .tasa-update-btn:hover {
      background: #218838;
    }
    .tasa-alert {
      margin: 15px 0;
      padding: 10px;
      border-radius: 5px;
    }
    .tasa-alert.success {
      background: #d4edda;
      color: #155724;
    }
    .tasa-alert.error {
      background: #f8d7da;
      color: #721c24;
    }
    .tasa-alert.warning {
      background: #fff3cd;
      color: #856404;
    }
.tarjeta.clasica {
  background: linear-gradient(135deg, #1e3c72, #2a5298); /* Azul */
}
.tarjeta.oro {
  background: linear-gradient(135deg, #d4af37, #f9d71c); /* Amarillo oro */
  color: #1a1a1a;
}
.tarjeta.platino {
  background: linear-gradient(135deg, #c0c0c0, #e6e6e6); /* Plata/dorado claro */
  color: #1a1a1a;
}
.tarjeta.oro .logo-tarjeta,
.tarjeta.platino .logo-tarjeta {
  color: rgba(0,0,0,0.7);
}

.main-menu .btn {
  padding: 12px 16px;
  background: #0056b3;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
}
.main-menu .btn:hover {
  background: #003f88; /* Azul ligeramente m√°s oscuro */
  transform: translateY(-3px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}
/* Ajuste espec√≠fico para los montos del Dashboard */
#dashboard .grid-3 {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  justify-content: center;
  margin-bottom: 20px;
}

#dashboard .grid-3 .card {
  flex: 1 1 calc(33% - 20px);
  min-width: 200px;
  max-width: 300px;
  padding: 15px;
  text-align: center;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  background: #fafafa;
}

#dashboard .grid-3 .card strong {
  display: block;
  font-size: 1em;
  margin-bottom: 8px;
  color: #333;
}

#dashboard .grid-3 .card div {
  font-size: 1.4em;
  font-weight: bold;
}
.tasas-header {
  text-align: center;
  font-size: 0.8em;
  color: #cce6ff;
  white-space: nowrap;
  max-width: 500px;
}
.tasas-header span {
  margin: 0 4px;
}
.tasas-header .moneda {
  font-weight: bold;
  color: #66b3ff;
}
.tasas-header .inversion {
  color: #aaffaa;
  font-weight: bold;
}
.tasas-header .euro {
  color: #ff9900; /* Naranja o cualquier color que desees */
  font-weight: bold;
}
  </style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
  <div class="container">
    <!-- PANTALLA DE INICIO DE SESI√ìN -->
    <div id="login-screen">
      <h2>Bienvenido a <strong>Simubank</strong></h2>
      <p style="text-align: center; margin: 10px 0;">Sistema de Gesti√≥n Bancaria Interna</p>
      <div id="login-form" style="max-width: 500px; margin: 30px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <h3>Iniciar Sesi√≥n</h3>
        <label>Usuario:</label>
        <input type="text" id="cajero-usuario" placeholder="Ingrese su usuario" />
        <label>Contrase√±a:</label>
        <input type="password" id="cajero-password" placeholder="Ingrese su contrase√±a" />
        <button onclick="iniciarSesion()" style="margin-top: 20px; width: 100%;">Iniciar Turno</button>
      </div>
      <div id="registro-form" style="max-width: 500px; margin: 30px auto; background: #f8f9fa; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: none;">
        <h3>Crear Nuevo Cajero</h3>
        <label>Nombre Completo:</label>
        <input type="text" id="nombre-completo" placeholder="Nombre del cajero" required />
        <label>Usuario:</label>
        <input type="text" id="nuevo-usuario" placeholder="Nuevo usuario" required />
        <label>Contrase√±a:</label>
        <input type="password" id="nueva-password" placeholder="Contrase√±a" required />
        <label>Sucursal:</label>
        <select id="sucursal">
          <option value="Bani">Ban√≠</option>
          <option value="Yaguate">Yaguate</option>
          <option value="San Cristobal">San Crist√≥bal</option>
          <option value="Azua">Azua</option>
        </select>
        <div class="grid-3">
          <input type="number" id="balance-rd" placeholder="Balance RD$" step="0.01" required />
          <input type="number" id="balance-usd" placeholder="Balance USD" step="0.01" required />
          <input type="number" id="balance-eur" placeholder="Balance EUR" step="0.01" required />
        </div>
        <h3>Tasas de Cambio del D√≠a (RD$)</h3>
        <div class="grid-2">
          <div>
            <label>USD Compra:</label>
            <input type="number" id="tasa-usd-compra" placeholder="Ej: 58.50" step="0.01" required />
          </div>
          <div>
            <label>USD Venta:</label>
            <input type="number" id="tasa-usd-venta" placeholder="Ej: 59.00" step="0.01" required />
          </div>
          <div>
            <label>EUR Compra:</label>
            <input type="number" id="tasa-eur-compra" placeholder="Ej: 65.00" step="0.01" required />
          </div>
          <div>
            <label>EUR Venta:</label>
            <input type="number" id="tasa-eur-venta" placeholder="Ej: 66.00" step="0.01" required />
          </div>
        </div>
        <button onclick="registrarCajero()" style="margin-top: 20px; width: 100%;">Registrar Cajero</button>
        <button onclick="mostrarLogin()" style="margin-top: 10px; width: 100%; background: #6c757d;">Volver al Inicio de Sesi√≥n</button>
      </div>
      <div style="text-align: center; margin-top: 15px;">
        <button onclick="mostrarRegistro()" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 5px;">Crear Cajero</button>
      </div>
    </div>
    <!-- P√ÅGINA PRINCIPAL -->
    <div id="main-page" class="hidden">
<header>
  <div class="logo">
    <div>Simubank</div>
    <div style="font-size: 0.9em; font-weight: normal; color: #cce6ff;">Tu banco educativo</div>
  </div>
  <div class="tasas-header" id="tasas-header">
    <!-- Se llenar√° din√°micamente con compra y venta -->
  </div>
  <div>
    <strong id="nombre-cajero"></strong> | <span id="fecha-hora"></span> | <span id="sucursal-actual"></span>
  </div>
</header>
      <div class="main-menu">
  	<button class="btn" onclick="mostrarModulo('resumen')">Resumen</button>
  	<button class="btn" onclick="mostrarModulo('gestion-cuentas')" id="btn-apertura" style="display: none;">Gesti√≥n de Cuentas</button>
  	<button class="btn" onclick="mostrarModulo('gestion-prestamos')">Gesti√≥n de Pr√©stamos</button>
  	<button class="btn" onclick="mostrarModulo('consultas')">Consultas</button>
  	<button class="btn" onclick="mostrarModulo('cambio')">Cambio de Divisas</button>
  	<button class="btn" onclick="mostrarModulo('tarjetas')">Gesti√≥n Tarjeta de Cr√©dito</button>
	<button class="btn" onclick="mostrarModulo('cheques')">Gesti√≥n de Cheques</button>
	<button class="btn" onclick="mostrarModulo('gestion-inversiones')">Gesti√≥n de Inversiones</button>
  	<button class="btn" onclick="mostrarModulo('informes')">üìä Informes</button>
  	<button class="btn" id="btn-admin" style="display: none;" onclick="mostrarModulo('admin')">Admin</button>
	<button class="logout-btn" onclick="cambiarContrasena()">üîê Cambiar Contrase√±a</button>
  	<button class="btn" id="btn-limpiar-sistema" onclick="limpiarSistema()" style="background: #dc3545;">üóëÔ∏è Limpiar Sistema</button>
	<button class="btn" onclick="mostrarModulo('backup')">üíæ Copia de seguridad</button>
</div>
      <!-- RESUMEN -->
      <div id="resumen" class="module active">
        <h2>Resumen de Operaciones</h2>
        <div class="grid-3">
          <div class="card">
            <strong>Balance Inicial (RD$):</strong>
            <span class="balance-item" id="balance-rd-display">RD$ 0.00</span>
          </div>
          <div class="card">
            <strong>Balance Inicial (USD):</strong>
            <span class="balance-item" id="balance-usd-display">USD 0.00</span>
          </div>
          <div class="card">
            <strong>Balance Inicial (EUR):</strong>
            <span class="balance-item" id="balance-eur-display">EUR 0.00</span>
          </div>
        </div>
        <div class="grid-3">
          <div class="card">
            <strong>Total Dep√≥sitos (RD$):</strong>
            <span id="total-depositos-rd">RD$ 0.00</span>
          </div>
          <div class="card">
            <strong>Total Dep√≥sitos (USD):</strong>
            <span id="total-depositos-usd">USD 0.00</span>
          </div>
          <div class="card">
            <strong>Total Dep√≥sitos (EUR):</strong>
            <span id="total-depositos-eur">EUR 0.00</span>
          </div>
        </div>
        <div class="grid-3">
          <div class="card">
            <strong>Total Retiros (RD$):</strong>
            <span id="total-retiros-rd">RD$ 0.00</span>
          </div>
          <div class="card">
            <strong>Total Retiros (USD):</strong>
            <span id="total-retiros-usd">USD 0.00</span>
          </div>
          <div class="card">
            <strong>Total Retiros (EUR):</strong>
            <span id="total-retiros-eur">EUR 0.00</span>
          </div>
        </div>
        <div class="grid-3">
          <div class="card">
            <strong>Total Pagos de Servicios (RD$):</strong>
            <span id="total-pagos-servicios">RD$ 0.00</span>
          </div>
        </div>
        <div class="grid-3">
          <div class="card">
            <strong>Efectivo Disponible (RD$):</strong>
            <span style="font-size: 1.3em; color: #28a745;" id="efectivo-caja">RD$ 0.00</span>
          </div>
          <div class="card">
            <strong>Efectivo Disponible (USD):</strong>
            <span style="font-size: 1.3em; color: #007bff;" id="efectivo-usd">USD 0.00</span>
          </div>
          <div class="card">
            <strong>Efectivo Disponible (EUR):</strong>
            <span style="font-size: 1.3em; color: #dc3545;" id="efectivo-eur">EUR 0.00</span>
          </div>
        </div>
         <h3>Accesos R√°pidos</h3>
	<div class="grid-3">
  	<button class="btn" onclick="mostrarModulo('depositos')">Dep√≥sitos</button>
  	<button class="btn" onclick="mostrarModulo('retiros')">Retiros</button>
  	<button class="btn" onclick="mostrarModulo('pagos')">Pagos de Servicios</button>
  	<button class="btn" onclick="mostrarModulo('consulta-saldo')">Consulta de Saldo</button>
  	<button class="btn" onclick="cerrarCaja()">Cierre de Caja</button>
  	<button class="btn" onclick="mostrarModulo('dashboard')">üìä Dashboard</button>
  	<button class="logout-btn" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
	</div>      
        <h3>Alertas y Notificaciones</h3>
        <div id="alertas">
          <div class="alert warning">Recuerde conciliar antes de cerrar caja.</div>
          <div class="alert hidden" id="alerta-sospechosa"></div>
        </div>
      </div>
      <!-- M√ìDULO DE DEP√ìSITOS -->
      <div id="depositos" class="module">
        <h2>Dep√≥sito</h2>
        <input type="text" id="cuenta-deposito" placeholder="N√∫mero de cuenta" />
        <input type="number" id="monto-deposito" placeholder="Monto" min="0.01" step="0.01" />
        <select id="moneda-deposito">
          <option value="RD$">Pesos Dominicanos (RD$)</option>
          <option value="USD">D√≥lares Americanos (USD)</option>
          <option value="EUR">Euros (EUR)</option>
        </select>
        <button onclick="registrarDeposito()">Registrar Dep√≥sito</button>
        <div id="resultado-deposito" class="alert hidden"></div>
      </div>
      <!-- M√ìDULO DE RETIROS -->
      <div id="retiros" class="module">
        <h2>Retiro de Efectivo</h2>
        <input type="text" id="cuenta-retiro" placeholder="N√∫mero de cuenta" />
        <input type="number" id="monto-retiro" placeholder="Monto" min="0.01" step="0.01" />
        <select id="moneda-retiro">
          <option value="RD$">Pesos Dominicanos (RD$)</option>
          <option value="USD">D√≥lares Americanos (USD)</option>
          <option value="EUR">Euros (EUR)</option>
        </select>
        <button onclick="registrarRetiro()">Retirar Efectivo</button>
        <div id="resultado-retiro" class="alert hidden"></div>
      </div>

<!-- PAGOS DE SERVICIOS -->
<div id="pagos" class="module">
  <h2>Pago de Servicios</h2>
  <select id="tipo-servicio" onchange="actualizarProveedores()">
    <option value="">Seleccionar tipo de servicio</option>
    <option value="telefonia">Telef√≥nicas</option>
    <option value="energia">Energ√≠a El√©ctrica</option>
    <option value="streaming">Streaming</option>
    <option value="agua">Agua</option>
  </select>
  <select id="proveedor" disabled>
    <option value="">Seleccionar proveedor</option>
  </select>
  <input type="text" id="numero-cuenta-servicio" placeholder="N√∫mero de cuenta o referencia del servicio" />
  <input type="number" id="monto-pago" placeholder="Monto a pagar" min="0.01" step="0.01" />
  <select id="metodo-pago-servicio" onchange="toggleCamposMetodoPago()">
    <option value="efectivo">Efectivo</option>
    <option value="cuenta">D√©bito a cuenta Simubank</option>
    <option value="tarjeta">D√©bito a tarjeta de cr√©dito</option>
  </select>
  <div id="campo-cuenta-pago" class="hidden" style="margin-top: 10px;">
    <input type="text" id="cuenta-pago" placeholder="N√∫mero de cuenta Simubank" />
  </div>
  <div id="campo-tarjeta-pago" class="hidden" style="margin-top: 10px;">
    <input type="text" id="tarjeta-pago" placeholder="N√∫mero de tarjeta de cr√©dito (sin espacios)" />
  </div>
  <button onclick="registrarPagoServicio()">Registrar Pago</button>
  <div id="resultado-pago" class="alert hidden"></div>
</div>

      <!-- CONSULTAS -->
      <div id="consultas" class="module">
        <h2>Consultas R√°pidas</h2>
        <input type="text" id="buscar-cliente" placeholder="Buscar cliente por c√©dula o cuenta" />
        <button onclick="buscarCliente()">Buscar</button>
        <div id="resultado-busqueda"></div>
        <div id="productos-cliente" class="productos-cliente hidden">
          <h3>Productos con el Banco</h3>
          <div id="lista-productos"></div>
        </div>
        <h3>Historial de Transacciones</h3>
        <div style="margin-bottom: 10px;">
          <label>Filtrar por tipo:</label>
          <select id="filtro-tipo" onchange="filtrarTransacciones()">
            <option value="todos">Todos</option>
            <option value="Dep√≥sito">Dep√≥sito</option>
            <option value="Retiro">Retiro</option>
            <option value="Pago de Servicio">Pago de Servicio</option>
            <option value="Cambio de Divisa">Cambio de Divisa</option>
          </select>
          <button onclick="exportarCSV()" style="margin-left: 10px; background: #28a745; color: white;">
            üì• Exportar a CSV
          </button>
        </div>
        <table id="historial-transacciones">
          <thead>
            <tr><th>Fecha</th><th>Tipo</th><th>Monto</th><th>Moneda</th><th>Cuenta/Referencia</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

	<!-- Informe de Rendimiento -->
	<div id="tab-informe-inversiones" class="tab-content">
  	<h3>Informe de Rendimiento de Inversiones</h3>
 	<button onclick="generarInformeRendimientoInversiones()" class="btn">üìä Generar Informe</button>
  	<div id="resultado-informe-inversiones" class="card hidden" style="margin-top: 20px;"></div>
      </div>

	<!-- Proyecci√≥n de Vencimientos -->
	<div id="tab-proyeccion-vencimientos" class="tab-content">
  	<h3>Proyecci√≥n de Vencimientos</h3>
  	<button onclick="mostrarProyeccionVencimientos()" class="btn">üìÖ Ver Pr√≥ximos Vencimientos</button>
  	<div id="resultado-proyeccion-vencimientos" class="card hidden" style="margin-top: 20px;"></div>
     </div>
      <!-- CAMBIO DE DIVISAS -->
      <div id="cambio" class="module">
  	<h2>Divisas</h2>
	<button class="btn" id="btn-tasas" onclick="mostrarModulo('tasas')" style="background: #6c757d; margin-bottom: 20px;">üí± Tasas de Cambio</button>
        <p>Realice compras o ventas de divisas seg√∫n las tasas del d√≠a.</p>
        <p style="color: #666; font-size: 0.9em; margin-bottom: 20px;">
          <strong>Tasas Actuales:</strong> 
          USD Compra: <span id="tasa-usd-compra-actual">--</span> | 
          USD Venta: <span id="tasa-usd-venta-actual">--</span> | 
          EUR Compra: <span id="tasa-eur-compra-actual">--</span> | 
          EUR Venta: <span id="tasa-eur-venta-actual">--</span>
        </p>
        <select id="tipo-cambio">
          <option value="compra">Comprar Divisa (cliente compra, banco vende)</option>
          <option value="venta">Vender Divisa (cliente vende, banco compra)</option>
        </select>
        <select id="moneda-cambio">
          <option value="USD">D√≥lares Americanos (USD)</option>
          <option value="EUR">Euros (EUR)</option>
        </select>
        <input type="number" id="monto-cambio" placeholder="Monto en divisa" step="0.01" min="0.01" />
        <div id="resultado-cambio" class="alert hidden"></div>
        <button onclick="realizarCambio()">Ejecutar Cambio</button>
      </div>

<!-- GESTI√ìN DE CUENTAS -->
<div id="gestion-cuentas" class="module">
  <h2>Gesti√≥n de Cuentas</h2>
  <div class="tabs">
  <button class="tab-btn active" onclick="mostrarTabCuentas('apertura')">Apertura de Cuenta</button>
  <button class="tab-btn" onclick="mostrarTabCuentas('deposito')">Dep√≥sito a Cuenta</button>
  <button class="tab-btn" onclick="mostrarTabCuentas('retiro')">Retiro de Cuenta</button>
  <button class="tab-btn" onclick="mostrarTabCuentas('consulta')">Consulta de Cuenta</button>
  <button class="tab-btn" onclick="mostrarTabCuentas('historial')">Historial de Transacciones</button>
  <button class="tab-btn" onclick="mostrarTabCuentas('transferencia')">Transferencia entre cuentas</button>
  <button class="tab-btn" onclick="mostrarTabCuentas('estado-cuenta')">Imprimir Estado de Cuenta</button> 
  <button class="tab-btn" onclick="mostrarTabCuentas('reposicion')">Reposici√≥n de libreta</button>	
</div>

  <!-- APERTURA -->
  <div id="tab-cuenta-apertura" class="tab-content active">
    <!-- Contenido original del formulario de apertura -->
    <h3>Apertura de Cuenta Bancaria</h3>
    <form id="form-apertura">
      <h4>Datos del Cliente</h4>
      <input type="text" id="nombre-cliente" placeholder="Nombre Completo" required />
      <input type="text" id="cedula" placeholder="C√©dula/Pasaporte" required />
      <input type="date" id="fecha-nac" required />
      <select id="sexo" required>
        <option value="">Sexo</option>
        <option value="M">Masculino</option>
        <option value="F">Femenino</option>
      </select>
      <select id="estado-civil" required>
        <option value="">Estado Civil</option>
        <option value="Soltero">Soltero</option>
        <option value="Casado">Casado</option>
        <option value="Divorciado">Divorciado</option>
        <option value="Viudo">Viudo</option>
      </select>
      <input type="text" id="direccion" placeholder="Direcci√≥n" required />
      <input type="tel" id="telefono" placeholder="Tel√©fono" required />
      <input type="email" id="email" placeholder="Correo Electr√≥nico" />
      <h4>Ocupaci√≥n</h4>
      <input type="text" id="empresa" placeholder="Empresa" />
      <input type="text" id="cargo" placeholder="Cargo" />
      <input type="number" id="ingresos" placeholder="Ingresos Mensuales (RD$)" />
      <h4>Datos Fiscales</h4>
      <input type="text" id="rnc" placeholder="RNC (si aplica)" />
      <h4>Selecci√≥n del Producto</h4>
      <select id="tipo-cuenta" onchange="actualizarMoneda()" required>
        <option value="">Tipo de Cuenta</option>
        <option value="ahorros">Ahorros</option>
        <option value="corriente">Corriente</option>
        <option value="nomina">N√≥mina</option>
        <option value="infantil">Infantil</option>
        <option value="empresarial">Empresarial</option>
        <option value="cheques">Cuenta de Cheques</option>
      </select>
      <select id="moneda" required>
        <option value="RD$">Pesos Dominicanos (RD$)</option>
        <option value="USD">D√≥lares Americanos (USD)</option>
        <option value="EUR">Euros (EUR)</option>
      </select>
      <h4>Par√°metros de la Cuenta</h4>
      <input type="text" id="numero-cuenta" readonly placeholder="N√∫mero de Cuenta (generado autom√°ticamente)" />
      <input type="text" id="sucursal-cuenta" readonly />
      <input type="text" id="oficial-cuenta" readonly />
      <button type="submit">Abrir Cuenta</button>
    </form>
    <div id="resultado-apertura" class="alert hidden"></div>
  </div>

<!-- DEP√ìSITO -->
<div id="tab-cuenta-deposito" class="tab-content">
  <h3>Dep√≥sito a Cuenta</h3>
  <input type="text" id="cuenta-deposito-tab" placeholder="N√∫mero de cuenta" />
  <select id="moneda-deposito-tab" onchange="mostrarCalculadoraDeposito()">
    <option value="">Seleccione moneda</option>
    <option value="RD$">Pesos Dominicanos (RD$)</option>
    <option value="USD">D√≥lares Americanos (USD)</option>
    <option value="EUR">Euros (EUR)</option>
  </select>
  <div id="calculadora-deposito-container" class="hidden" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
    <h4>üßÆ Calculadora de Billetes</h4>
    <div id="campos-calculadora-deposito"></div>
    <div style="margin-top: 10px; font-weight: bold;">
      Total: <span id="total-calculado-deposito">0.00</span> <span id="moneda-calculada">RD$</span>
    </div>
  </div>
  <button onclick="registrarDepositoTab()">Registrar Dep√≥sito</button>
  <div id="resultado-deposito-tab" class="alert hidden"></div>
</div>

<!-- RETIRO -->
<div id="tab-cuenta-retiro" class="tab-content">
  <h3>Retiro de Cuenta</h3>
  <input type="text" id="cuenta-retiro-tab" placeholder="N√∫mero de cuenta" />
  <select id="moneda-retiro-tab" onchange="mostrarCalculadoraRetiro()">
    <option value="">Seleccione moneda</option>
    <option value="RD$">Pesos Dominicanos (RD$)</option>
    <option value="USD">D√≥lares Americanos (USD)</option>
    <option value="EUR">Euros (EUR)</option>
  </select>
  <div id="calculadora-retiro-container" class="hidden" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
    <h4>üßÆ Calculadora de Billetes</h4>
    <div id="campos-calculadora-retiro"></div>
    <div style="margin-top: 10px; font-weight: bold;">
      Total: <span id="total-calculado-retiro">0.00</span> <span id="moneda-calculada-retiro">RD$</span>
    </div>
  </div>
  <button onclick="registrarRetiroTab()">Retirar Efectivo</button>
  <div id="resultado-retiro-tab" class="alert hidden"></div>
</div>


<!-- TRANSFERENCIA ENTRE CUENTAS (dentro de Gesti√≥n de Cuentas) -->
<div id="tab-cuenta-transferencia" class="tab-content">
  <h3>Transferencia entre Cuentas</h3>
  <input type="text" id="cuenta-origen" placeholder="Cuenta de origen" />
  <input type="text" id="cuenta-destino" placeholder="Cuenta de destino" />
  <input type="number" id="monto-transferencia" placeholder="Monto a transferir" min="0.01" step="0.01" />
  <select id="moneda-transferencia">
    <option value="RD$">Pesos Dominicanos (RD$)</option>
    <option value="USD">D√≥lares Americanos (USD)</option>
    <option value="EUR">Euros (EUR)</option>
  </select>
  <button onclick="realizarTransferenciaTab()">Ejecutar Transferencia</button>
  <div id="resultado-transferencia" class="alert hidden"></div>
</div>

  <!-- CONSULTA -->
  <div id="tab-cuenta-consulta" class="tab-content">
    <h3>Consulta de Cuenta</h3>
    <input type="text" id="cuenta-saldo-tab" placeholder="Ingrese n√∫mero de cuenta" />
    <button onclick="consultarSaldoTab()">Consultar Saldo</button>
    <div id="resultado-saldo-tab" class="alert hidden"></div>
    <div id="datos-cuenta-tab" class="card hidden">
      <strong>Titular:</strong> <span id="nombre-titular-tab"></span><br>
      <strong>Cuenta:</strong> <span id="num-cuenta-tab"></span><br>
      <strong>Producto:</strong> <span id="tipo-producto-tab"></span><br>
      <strong>Moneda:</strong> <span id="moneda-cuenta-tab"></span><br>
      <strong>Saldo Estimado:</strong> <span id="saldo-estimado-tab" style="font-weight: bold; color: #003366;"></span>
    </div>
  </div>

  <!-- HISTORIAL -->
  <div id="tab-cuenta-historial" class="tab-content">
    <h3>Historial de Transacciones</h3>
    <input type="text" id="cuenta-historial" placeholder="N√∫mero de cuenta" />
    <button onclick="filtrarHistorialPorCuenta()">Ver Historial</button>
    <div style="margin-top: 15px;">
      <table id="tabla-historial-cuenta">
        <thead>
          <tr><th>Fecha</th><th>Tipo</th><th>Monto</th><th>Moneda</th><th>Referencia</th></tr>
        </thead>
        <tbody id="cuerpo-historial-cuenta"></tbody>
      </table>
    </div>
  </div>

<!-- IMPRIMIR ESTADO DE CUENTA -->
<div id="tab-cuenta-estado-cuenta" class="tab-content">
  <h3>Imprimir Estado de Cuenta</h3>
  <input type="text" id="cuenta-estado" placeholder="N√∫mero de cuenta" />
  <div class="grid-2">
    <div>
      <label>Fecha Desde:</label>
      <input type="date" id="fecha-desde-estado" />
    </div>
    <div>
      <label>Fecha Hasta:</label>
      <input type="date" id="fecha-hasta-estado" />
    </div>
  </div>
  <button onclick="generarEstadoCuenta()" style="margin-top: 15px;">üñ®Ô∏è Generar Estado de Cuenta</button>
  <div id="resultado-estado-cuenta" class="alert hidden"></div>
</div>  
</div>

<!-- REPOSICI√ìN DE LIBRETA -->
<div id="tab-cuenta-reposicion" class="tab-content">
  <h3>Reposici√≥n de Libreta de Ahorros</h3>
  <input type="text" id="numero-libreta-reposicion" placeholder="Ingrese n√∫mero de cuenta (libreta)" />
  <button onclick="iniciarReposicionLibreta()">Reponer libreta</button>
  <div id="resultado-reposicion" class="alert hidden"></div>
</div>

      <!-- GESTI√ìN DE PR√âSTAMOS -->
	<div id="gestion-prestamos" class="module">
  		<h2>Gesti√≥n de Pr√©stamos</h2>
  		<div class="tabs">
  			<button class="tab-btn active" onclick="mostrarTab('solicitud')">Solicitud</button>
  			<button class="tab-btn" onclick="mostrarTab('aprobar')">Aprobar</button>
  			<button class="tab-btn" onclick="mostrarTab('cobro')">Cobro</button>
  			<button class="tab-btn" onclick="mostrarTab('consulta')">Consulta de Pr√©stamos</button>
  			<button class="tab-btn" onclick="mostrarTab('calculadora')">Calculadora de Pr√©stamo</button>
  			<button class="tab-btn" onclick="mostrarTab('acobrar')">üìÖ Pr√©stamos a Cobrar</button> <!-- NUEVO -->
	</div>

        <!-- SOLICITUD -->
        <div id="tab-solicitud" class="tab-content active">
          <form id="form-prestamo">
            <h3>Datos del Solicitante</h3>
            <input type="text" id="nombre-solicitante" placeholder="Nombre Completo" required />
            <input type="text" id="cedula-prestamo" placeholder="C√©dula" required />
            <input type="text" id="direccion-prestamo" placeholder="Direcci√≥n" required />
            <input type="tel" id="telefono-prestamo" placeholder="Tel√©fono" required />
            <input type="email" id="email-prestamo" placeholder="Correo" required />
            <select id="estado-civil-prestamo">
              <option value="Soltero">Soltero</option>
              <option value="Casado">Casado</option>
              <option value="Divorciado">Divorciado</option>
              <option value="Viudo">Viudo</option>
            </select>
            <input type="number" id="ingresos-prestamo" placeholder="Ingresos Mensuales" required />
            <input type="text" id="empresa-prestamo" placeholder="Empresa" />
            <h3>Datos Bancarios</h3>
            <input type="text" id="numero-cuenta-prestamo" placeholder="N√∫mero de cuenta para desembolso" required />
            <h3>Detalles del Pr√©stamo</h3>
            <select id="tipo-prestamo" required>
              <option value="personal">Personal</option>
              <option value="vehicular">Vehicular</option>
              <option value="hipotecario">Hipotecario</option>
              <option value="empresarial">Empresarial</option>
            </select>
            <input type="number" id="monto-solicitado" placeholder="Monto Solicitado" required />
            <input type="number" id="plazo" placeholder="Plazo en meses" required />
            <input type="number" id="tasa" placeholder="Tasa de inter√©s anual (%)" step="0.1" min="0.1" required />
            <select id="forma-pago">
              <option value="mensual">Mensual</option>
              <option value="quincenal">Quincenal</option>
              <option value="semanal">Semanal</option>
            </select>
            <button type="submit">Enviar Solicitud</button>
          </form>
        </div>

        <!-- APROBAR -->
        <div id="tab-aprobar" class="tab-content">
          <input type="text" id="buscar-solicitud" placeholder="Buscar por c√©dula o c√≥digo de pr√©stamo (SBPT0001)" />
          <button onclick="buscarSolicitud()">Buscar Solicitud</button>
          <div id="resultado-solicitud"></div>
          <div id="acciones-prestamo" class="hidden">
            <h3>Acciones</h3>
            <button onclick="aprobarPrestamo()" style="background: #28a745; color: white; margin-right: 10px;">‚úÖ Aprobar</button>
            <button onclick="rechazarPrestamo()" style="background: #dc3545; color: white;">‚ùå Rechazar</button>
            <div id="resultado-aprobacion" class="alert hidden"></div>
          </div>
        </div>

        <!-- COBRO -->
        <div id="tab-cobro" class="tab-content">
          <input type="text" id="buscar-prestamo" placeholder="Buscar por c√©dula or c√≥digo de pr√©stamo" />
          <button onclick="buscarPrestamo()">Buscar Pr√©stamo</button>
          <div id="resultado-prestamo"></div>
          <div id="lista-cuotas" class="hidden">
            <h3>Cuotas del Pr√©stamo</h3>
            <div id="cuotas-container"></div>
          </div>
          <div id="resultado-cobro" class="alert hidden"></div>
        </div>

<!-- CONSULTA DE PR√âSTAMOS -->
        <div id="tab-consulta" class="tab-content">
          <input type="text" id="buscar-cliente-prestamo" placeholder="Buscar cliente por c√©dula o c√≥digo de pr√©stamo" />
          <button onclick="buscarClientePrestamos()">Buscar Cliente</button>
          <div id="resultado-cliente-prestamo"></div>
          <div id="lista-prestamos" class="hidden">
            <h3>Pr√©stamos del Cliente</h3>
            <div id="prestamos-container"></div>
          </div>
          <div id="pagos-container" class="hidden">
            <h3>Pagos Realizados</h3>
            <div id="historial-pagos"></div>
          </div>
        </div>

        <!-- PR√âSTAMOS A COBRAR -->
        <div id="tab-acobrar" class="tab-content">
          <h3>üìÖ Pr√©stamos Pendientes de Cobro</h3>
          <p>Lista de cuotas vencidas o pr√≥ximas a vencer (hoy y pr√≥ximos 7 d√≠as).</p>
          <button onclick="cargarPrestamosACobrar()" class="btn">Actualizar Lista</button>
          <div id="lista-prestamos-acobrar" style="margin-top: 15px;">
            <p>Haga clic en "Actualizar Lista" para cargar los pr√©stamos.</p>
          </div>
        </div>
      </div> <!-- Cierre de #gestion-prestamos -->

<!-- CALCULADORA DE PR√âSTAMO -->
        <div id="tab-calculadora" class="tab-content">
          <h3>Calculadora de Pr√©stamo</h3>
          <p>Simule su pr√©stamo ingresando los datos a continuaci√≥n.</p>
          <form id="form-calculadora">
            <div class="grid-2">
              <div>
                <label>Monto Solicitado (RD$):</label>
                <input type="number" id="calc-monto" placeholder="Ej: 100000" step="100" min="1000" required />
              </div>
              <div>
                <label>Plazo (meses):</label>
                <input type="number" id="calc-plazo" placeholder="Ej: 12" min="1" max="360" required />
              </div>
              <div>
                <label>Tasa de Inter√©s Anual (%):</label>
                <input type="number" id="calc-tasa" placeholder="Ej: 12.5" step="0.1" min="0.1" required />
              </div>
              <div>
                <label>Forma de Pago:</label>
                <select id="calc-forma-pago" required>
                  <option value="mensual">Mensual</option>
                  <option value="quincenal">Quincenal</option>
                  <option value="semanal">Semanal</option>
                </select>
              </div>
            </div>
            <button type="submit" style="margin-top: 20px;">Calcular</button>
          </form>
          <div id="resultado-calculadora" class="card hidden" style="margin-top: 20px;">
            <h4>Resultado de la Simulaci√≥n</h4>
            <p><strong>Monto del Pr√©stamo:</strong> RD$ <span id="res-monto">0.00</span></p>
            <p><strong>Plazo:</strong> <span id="res-plazo">0</span> meses</p>
            <p><strong>Tasa de Inter√©s Anual:</strong> <span id="res-tasa">0.0</span>%</p>
            <p><strong>Forma de Pago:</strong> <span id="res-forma-pago">Mensual</span></p>
            <p><strong>Cuota Fija:</strong> RD$ <span id="res-cuota">0.00</span></p>
            <p><strong>Total a Pagar (Capital + Intereses):</strong> RD$ <span id="res-total">0.00</span></p>
            <p><strong>Total de Intereses:</strong> RD$ <span id="res-intereses">0.00</span></p>
          </div>
          <div id="tabla-amortizacion" class="hidden" style="margin-top: 20px;">
            <h4>Tabla de Amortizaci√≥n</h4>
            <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px;">
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr>
                    <th style="border: 1px solid #ddd; padding: 8px; background: #f1f1f1;"># Cuota</th>
                    <th style="border: 1px solid #ddd; padding: 8px; background: #f1f1f1;">Fecha de Vencimiento</th>
                    <th style="border: 1px solid #ddd; padding: 8px; background: #f1f1f1;">Cuota (RD$)</th>
                    <th style="border: 1px solid #ddd; padding: 8px; background: #f1f1f1;">Capital (RD$)</th>
                    <th style="border: 1px solid #ddd; padding: 8px; background: #f1f1f1;">Inter√©s (RD$)</th>
                    <th style="border: 1px solid #ddd; padding: 8px; background: #f1f1f1;">Saldo (RD$)</th>
                  </tr>
                </thead>
                <tbody id="cuerpo-tabla-amortizacion">
                  <!-- Las filas se generar√°n din√°micamente -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
    
      <!-- CONSULTA DE SALDO -->
      <div id="consulta-saldo" class="module">
        <h2>Consulta de Saldo</h2>
        <input type="text" id="cuenta-saldo" placeholder="Ingrese n√∫mero de cuenta" />
        <button onclick="consultarSaldo()">Consultar Saldo</button>
        <div id="resultado-saldo" class="alert hidden"></div>
        <div id="datos-cuenta" class="card hidden">
          <strong>Titular:</strong> <span id="nombre-titular"></span><br>
          <strong>Cuenta:</strong> <span id="num-cuenta"></span><br>
          <strong>Producto:</strong> <span id="tipo-producto"></span><br>
          <strong>Moneda:</strong> <span id="moneda-cuenta"></span><br>
          <strong>Saldo Estimado:</strong> <span id="saldo-estimado" style="font-weight: bold; color: #003366;"></span>
        </div>
      </div>

      <!-- GESTI√ìN DE TARJETAS DE CR√âDITO -->
      <div id="tarjetas" class="module">
        <h2>Gesti√≥n de Tarjeta de Cr√©dito</h2>
<div class="tabs">
  <button class="tab-btn active" onclick="mostrarTabTarjeta('solicitud')">Solicitud</button>
  <button class="tab-btn" onclick="mostrarTabTarjeta('aprobar')">Aprobar</button>
  <button class="tab-btn" onclick="mostrarTabTarjeta('debitar')">Debitar Monto</button>
  <button class="tab-btn" onclick="mostrarTabTarjeta('avance')">Avance de Efectivo</button>
  <button class="tab-btn" onclick="mostrarTabTarjeta('cobro')">Cobro</button>
  <button class="tab-btn" onclick="mostrarTabTarjeta('consulta')">Consulta</button>
  <button class="tab-btn" onclick="mostrarTabTarjeta('acobrar')">üí≥ Tarjetas a Cobrar</button>	
  <button class="tab-btn" onclick="descargarTarjetasAprobadasPDF()" style="background: #d9534f; color: white;">üì• PDF Tarjetas Aprobadas</button>
</div>

        <!-- SOLICITUD -->
        <div id="tab-tarjeta-solicitud" class="tab-content active">
          <h3>Solicitud de Tarjeta de Cr√©dito</h3>
          <form id="form-tarjeta">
            <label>N√∫mero de Cuenta del Cliente:</label>
            <input type="text" id="cuenta-tarjeta" placeholder="N√∫mero de cuenta bancaria" required />
            <label>Tipo de Tarjeta:</label>
		<select id="tipo-tarjeta">
  		<option value="Cl√°sica">Cl√°sica</option>
  		<option value="Oro">Oro</option>
  		<option value="Platino">Platino</option>
		</select>
		<label>Marca de la Tarjeta:</label>
		<select id="marca-tarjeta">
  		<option value="Visa">Visa</option>
  		<option value="Mastercard">Mastercard</option>
 		<option value="American Express">American Express</option>
  		<option value="Discover">Discover</option>
  		<option value="Diners Club">Diners Club</option>
		</select>
            <label>L√≠mite de Cr√©dito (RD$):</label>
            <input type="number" id="limite-tarjeta" placeholder="Ej: 150000" required />
            <button type="submit">Enviar Solicitud</button>
          </form>
          <div id="resultado-tarjeta" class="alert hidden"></div>
          <div id="visualizacion-tarjeta" class="hidden">
            <h3>Tarjeta Generada (Pendiente de Aprobaci√≥n):</h3>
            <div id="tarjeta-preview" class="tarjeta">
              <div class="chip"></div>
              <h3>Tarjeta Simubank</h3>
              <div class="tarjeta-numero" id="num-tarjeta">**** **** **** ****</div>
              <div class="tarjeta-info">
                <div>
                  <strong>Titular:</strong><br>
                  <span id="nombre-titular-tarjeta">Nombre Apellido</span>
                </div>
                <div>
                  <strong>Vencimiento:</strong><br>
                  <span id="vencimiento-tarjeta">04/28</span>
                </div>
              </div>
              <div class="logo-tarjeta">VISA</div>
              </div>
          </div>
        </div>

        <!-- APROBAR -->
        <div id="tab-tarjeta-aprobar" class="tab-content">
          <h3>Aprobar Tarjeta de Cr√©dito</h3>
          <input type="text" id="buscar-tarjeta-aprobar" placeholder="Buscar por n√∫mero de cuenta o n√∫mero de tarjeta" />
          <button onclick="buscarTarjetaPendiente()">Buscar Solicitud</button>
          <div id="resultado-tarjeta-pendiente"></div>
          <div id="acciones-tarjeta-aprobar" class="hidden">
            <h3>Acciones</h3>
            <button onclick="aprobarTarjeta()" style="background: #28a745; color: white; margin-right: 10px;">‚úÖ Aprobar</button>
            <button onclick="rechazarTarjeta()" style="background: #dc3545; color: white;">‚ùå Rechazar</button>
            <div id="resultado-aprobacion-tarjeta" class="alert hidden"></div>
          </div>
        </div>

        <!-- DEBITAR MONTO -->
        <div id="tab-tarjeta-debitar" class="tab-content">
          <h3>Debitar Monto de Tarjeta de Cr√©dito</h3>
          <p>Realice un d√©bito (cargo) a una tarjeta de cr√©dito aprobada.</p>
          <input type="text" id="numero-tarjeta-debitar" placeholder="N√∫mero de Tarjeta (sin espacios)" />
          <input type="number" id="monto-debitar" placeholder="Monto a Debitar" min="0.01" step="0.01" />
          <select id="moneda-debitar">
            <option value="RD$">Pesos Dominicanos (RD$)</option>
            <option value="USD">D√≥lares Americanos (USD)</option>
            <option value="EUR">Euros (EUR)</option>
          </select>
          <input type="text" id="descripcion-debito" placeholder="Descripci√≥n del D√©bito (Ej: Compra en Tienda X)" />
          <button onclick="realizarDebitoTarjeta()">Debitar Monto</button>
          <div id="resultado-debito-tarjeta" class="alert hidden"></div>
        </div>

<!-- COBRO -->
<div id="tab-tarjeta-cobro" class="tab-content">
  <h3>Cobro a Tarjeta de Cr√©dito</h3>
  <p>Registre un pago (abono) realizado por el cliente a su tarjeta de cr√©dito.</p>
  <input type="text" id="numero-tarjeta-cobro" placeholder="N√∫mero de Tarjeta (sin espacios)" />
  
  <label>M√©todo de Cobro:</label>
  <select id="metodo-cobro-tarjeta" onchange="toggleCuentaCobroTarjeta()">
    <option value="efectivo">Efectivo</option>
    <option value="cuenta">D√©bito a cuenta Simubank</option>
  </select>

  <input type="number" id="monto-cobro" placeholder="Monto a Cobrar (Abonar)" min="0.01" step="0.01" />

  <div id="campo-cuenta-cobro" class="hidden" style="margin-top: 10px;">
    <input type="text" id="cuenta-cobro-tarjeta" placeholder="N√∫mero de cuenta Simubank" />
  </div>

  <button onclick="realizarCobroTarjeta()">Registrar Cobro</button>
  <div id="resultado-cobro-tarjeta" class="alert hidden"></div>
</div>        

<!-- AVANCE DE EFECTIVO -->
<div id="tab-tarjeta-avance" class="tab-content">
  <h3>Avance de Efectivo con Tarjeta de Cr√©dito</h3>
  <p>Permite al cliente retirar efectivo contra su tarjeta de cr√©dito aprobada.</p>
  <input type="text" id="numero-tarjeta-avance" placeholder="N√∫mero de Tarjeta (sin espacios)" />
  <input type="number" id="monto-avance" placeholder="Monto a Retirar (RD$)" min="0.01" step="0.01" />
  <input type="text" id="descripcion-avance" placeholder="Descripci√≥n (Ej: Avance en cajero)" />
  <button onclick="realizarAvanceEfectivo()">Realizar Avance</button>
  <div id="resultado-avance-tarjeta" class="alert hidden"></div>
</div>

        <!-- CONSULTA -->
        <div id="tab-tarjeta-consulta" class="tab-content">
          <h3>Consulta de Tarjeta de Cr√©dito</h3>
          <input type="text" id="buscar-tarjeta-consulta" placeholder="Buscar por n√∫mero de cuenta, c√©dula o n√∫mero de tarjeta" />
          <button onclick="buscarTarjetaConsulta()">Buscar Tarjeta</button>
          <div id="resultado-consulta-tarjeta"></div>
          <div id="detalles-tarjeta" class="hidden">
            <div class="card" style="margin-top: 20px;">
              <h4>Detalles de la Tarjeta</h4>
              <p><strong>N√∫mero de Tarjeta:</strong> <span id="consulta-num-tarjeta"></span></p>
              <p><strong>Titular:</strong> <span id="consulta-nombre-titular"></span></p>
              <p><strong>Tipo:</strong> <span id="consulta-tipo-tarjeta"></span></p>
              <p><strong>L√≠mite de Cr√©dito:</strong> RD$ <span id="consulta-limite"></span></p>
              <p><strong>Saldo Actual:</strong> RD$ <span id="consulta-saldo"></span></p>
              <p><strong>Estado:</strong> <span id="consulta-estado"></span></p>
              <p><strong>Fecha de Emisi√≥n:</strong> <span id="consulta-fecha-emision"></span></p>
              <p><strong>Fecha de Vencimiento:</strong> <span id="consulta-fecha-vencimiento"></span></p>
            </div>
            <h4>Historial de Movimientos</h4>
            <div id="historial-movimientos" style="margin-top: 10px;">
              <!-- El historial se llenar√° din√°micamente -->
            </div>
          </div>
        </div>
      </div>

<!-- TARJETAS A COBRAR -->
<div id="tab-tarjeta-acobrar" class="tab-content">
  <h3>üí≥ Tarjetas con Saldo Pendiente (A Cobrar)</h3>
  <p>Lista de tarjetas de cr√©dito con saldo activo pendiente de pago.</p>
  <button onclick="cargarTarjetasACobrar()" class="btn">Actualizar Lista</button>
  <div id="lista-tarjetas-acobrar" style="margin-top: 15px;">
    <p>Haga clic en "Actualizar Lista" para cargar las tarjetas.</p>
  </div>
</div>

<!-- GESTI√ìN DE INVERSIONES -->
<div id="gestion-inversiones" class="module">
  <h2>üíº Gesti√≥n de Inversiones</h2>
  <div class="tabs">
    <button class="tab-btn active" onclick="mostrarTabInversion('apertura')">Abrir Inversi√≥n</button>
    <button class="tab-btn" onclick="mostrarTabInversion('consulta')">Consultar Certificado</button>
  </div>

  <!-- APERTURA DE INVERSI√ìN -->
  <div id="tab-inversion-apertura" class="tab-content active">
    <h3>Abrir Nueva Inversi√≥n</h3>
<div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
      <h4>üí± Establecer Tasa de Inter√©s para Inversiones</h4>
      <div class="grid-2">
        <div>
          <label>Tasa de Inter√©s Anual Predeterminada (%):</label>
          <input type="number" id="tasa-inversion-global" placeholder="Ej: 8.5" step="0.1" min="0.1">
        </div>
        <div>
          <label>Moneda:</label>
          <select id="moneda-tasa-inversion">
            <option value="RD$">Pesos Dominicanos (RD$)</option>
            <option value="USD">D√≥lares (USD)</option>
            <option value="EUR">Euros (EUR)</option>
          </select>
        </div>
      </div>
      <button type="button" onclick="guardarTasaInversion()" class="btn" style="margin-top: 15px; background: #28a745; color: white;">üíæ Guardar Tasa</button>
      <div id="resultado-tasa-inversion" class="alert hidden" style="margin-top: 10px;"></div>
    </div>
    <form id="form-inversion">
      <input type="text" id="nombre-inversion" placeholder="Nombre y Apellido" required />
      <input type="text" id="cuenta-vinculada" placeholder="N√∫mero de Cuenta Vinculada" required />
      <select id="moneda-inversion" required onchange="cargarTasaGlobalEnFormulario()">
        <option value="RD$">Pesos Dominicanos (RD$)</option>
        <option value="USD">D√≥lares Americanos (USD)</option>
        <option value="EUR">Euros (EUR)</option>
      </select>
      <input type="number" id="monto-inversion" placeholder="Monto a Invertir" min="100" step="0.01" required />
      <select id="plazo-inversion" required onchange="actualizarFechaVencimiento()">
        <option value="30">30 d√≠as</option>
        <option value="60">60 d√≠as</option>
        <option value="90">90 d√≠as</option>
        <option value="180">180 d√≠as</option>
        <option value="360">360 d√≠as</option>
      </select>
      <input type="number" id="tasa-interes" placeholder="Tasa de Inter√©s Anual (%)" step="0.1" min="0.1" required />
      <input type="date" id="fecha-vencimiento" />
      <button type="submit">Abrir Inversi√≥n</button>
    </form>
    <div id="resultado-inversion" class="alert hidden"></div>
  </div>

  <!-- CONSULTA DE CERTIFICADO -->
  <div id="tab-inversion-consulta" class="tab-content">
    <h3>Consultar Certificado de Inversi√≥n</h3>
    <input type="text" id="cuenta-consulta-inversion" placeholder="N√∫mero de Cuenta Vinculada" />
    <button onclick="consultarCertificadoInversion()">Buscar Certificado</button>
    <div id="resultado-certificado" class="card hidden" style="margin-top: 20px;"></div>
  </div>
</div>

<!-- M√ìDULO DE INFORMES -->
<div id="informes" class="module">
  <h2>üìä M√≥dulo de Informes</h2>
  <p>Seleccione el tipo de informe que desea generar.</p>
  <div class="tabs">
    <button class="tab-btn active" onclick="mostrarTabInforme('diario')">Resumen Diario</button>
    <button class="tab-btn" onclick="mostrarTabInforme('prestamos')">Pr√©stamos</button>
    <button class="tab-btn" onclick="mostrarTabInforme('tarjetas')">Tarjetas de Cr√©dito</button>
    <button class="tab-btn" onclick="mostrarTabInforme('transacciones')">Transacciones</button>
  </div>

  <!-- INFORME DIARIO -->
  <div id="tab-informe-diario" class="tab-content active">
    <h3>Resumen Diario de Operaciones</h3>
    <p>Este informe muestra un resumen consolidado de todas las operaciones realizadas en el d√≠a.</p>
    <button onclick="generarInformeDiario()" class="btn">Generar Informe Diario</button>
	<button onclick="exportarInformeDiarioPDF()" class="btn" style="background: #d9534f; margin-left: 10px;">üìÑ Exportar a PDF</button>
    <div id="resultado-informe-diario" class="card hidden" style="margin-top: 20px;">
      <h4>Informe Generado</h4>
      <div id="contenido-informe-diario"></div>
    </div>
  </div>

  <!-- INFORME DE PR√âSTAMOS -->
  <div id="tab-informe-prestamos" class="tab-content">
    <h3>Informe de Pr√©stamos</h3>
    <div class="grid-2">
      <div>
        <label>Estado del Pr√©stamo:</label>
        <select id="filtro-estado-prestamo">
          <option value="todos">Todos</option>
          <option value="Pendiente">Pendiente</option>
          <option value="Aprobado">Aprobado</option>
          <option value="Pagado">Pagado</option>
          <option value="Rechazado">Rechazado</option>
        </select>
      </div>
      <div>
        <label>Tipo de Pr√©stamo:</label>
        <select id="filtro-tipo-prestamo">
          <option value="todos">Todos</option>
          <option value="personal">Personal</option>
          <option value="vehicular">Vehicular</option>
          <option value="hipotecario">Hipotecario</option>
          <option value="empresarial">Empresarial</option>
        </select>
      </div>
    </div>
    <button onclick="generarInformePrestamos()" class="btn" style="margin-top: 20px;">Generar Informe</button>
    <div id="resultado-informe-prestamos" class="card hidden" style="margin-top: 20px;">
      <h4>Informe de Pr√©stamos</h4>
      <div id="contenido-informe-prestamos"></div>
    </div>
  </div>

  <!-- INFORME DE TARJETAS -->
  <div id="tab-informe-tarjetas" class="tab-content">
    <h3>Informe de Tarjetas de Cr√©dito</h3>
    <div class="grid-2">
      <div>
        <label>Estado de la Tarjeta:</label>
        <select id="filtro-estado-tarjeta">
          <option value="todos">Todos</option>
          <option value="Pendiente">Pendiente</option>
          <option value="Aprobada">Aprobada</option>
          <option value="Rechazada">Rechazada</option>
        </select>
      </div>
      <div>
        <label>Tipo de Tarjeta:</label>
        <select id="filtro-tipo-tarjeta">
          <option value="todos">Todos</option>
          <option value="Cl√°sica">Cl√°sica</option>
          <option value="Oro">Oro</option>
          <option value="Platino">Platino</option>
        </select>
      </div>
    </div>
    <button onclick="generarInformeTarjetas()" class="btn" style="margin-top: 20px;">Generar Informe</button>
    <div id="resultado-informe-tarjetas" class="card hidden" style="margin-top: 20px;">
      <h4>Informe de Tarjetas</h4>
      <div id="contenido-informe-tarjetas"></div>
    </div>
  </div>

  <!-- INFORME DE TRANSACCIONES -->
  <div id="tab-informe-transacciones" class="tab-content">
    <h3>Informe Detallado de Transacciones</h3>
    <div class="grid-3">
      <div>
        <label>Tipo de Transacci√≥n:</label>
        <select id="filtro-tipo-transaccion">
          <option value="todos">Todos</option>
          <option value="Dep√≥sito">Dep√≥sito</option>
          <option value="Retiro">Retiro</option>
          <option value="Pago de Servicio">Pago de Servicio</option>
          <option value="Cambio de Divisa">Cambio de Divisa</option>
          <option value="Transferencia">Transferencia</option>
          <option value="Cobro de Pr√©stamo">Cobro de Pr√©stamo</option>
          <option value="D√©bito Tarjeta">D√©bito Tarjeta</option>
          <option value="Cobro Tarjeta">Cobro Tarjeta</option>
        </select>
      </div>
      <div>
        <label>Moneda:</label>
        <select id="filtro-moneda-transaccion">
          <option value="todos">Todas</option>
          <option value="RD$">RD$</option>
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
        </select>
      </div>
      <div>
        <label>Fecha Desde:</label>
        <input type="date" id="fecha-desde" />
      </div>
      <div>
        <label>Fecha Hasta:</label>
        <input type="date" id="fecha-hasta" />
      </div>
    </div>
    <button onclick="generarInformeTransacciones()" class="btn" style="margin-top: 20px;">Generar Informe</button>
    <div id="resultado-informe-transacciones" class="card hidden" style="margin-top: 20px; max-height: 400px; overflow-y: auto;">
      <h4>Informe de Transacciones</h4>
      <table id="tabla-informe-transacciones" style="width: 100%; border-collapse: collapse; margin-top: 10px;">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Monto</th>
            <th>Moneda</th>
            <th>Referencia</th>
          </tr>
        </thead>
        <tbody id="cuerpo-tabla-informe-transacciones">
        </tbody>
      </table>
    </div>
    <button onclick="exportarInformeTransaccionesCSV()" class="btn" style="margin-top: 20px; background: #28a745; display: none;" id="btn-exportar-csv">üì• Exportar a CSV</button>
  </div>
</div>
      <!-- ADMIN -->
<div id="admin" class="module">
  <h2>Administraci√≥n de Cajeros</h2>
  <div class="tabs">
    <button class="tab-btn active" onclick="mostrarTabAdmin('crear')">Crear Cajero</button>
    <button class="tab-btn" onclick="mostrarTabAdmin('ver')">Verificar Cajeros Registrados</button>
	<button class="tab-btn" onclick="mostrarTabAdmin('actividad')">Actividad del Cajero</button>
  </div>

  <!-- CREAR CAJERO -->
  <div id="tab-admin-crear" class="tab-content active">
    <p>Registre nuevos cajeros con acceso al sistema.</p>
    <form id="form-crear-cajero">
      <h3>Datos del Cajero</h3>
      <input type="text" id="nombre-cajero-nuevo" placeholder="Nombre Completo" required />
      <input type="text" id="usuario-cajero" placeholder="Usuario" required />
      <input type="password" id="password-cajero" placeholder="Contrase√±a" required />
      <select id="sucursal-cajero">
        <option value="Bani">Ban√≠</option>
        <option value="Yaguate">Yaguate</option>
        <option value="San Cristobal">San Crist√≥bal</option>
        <option value="Azua">Azua</option>
      </select>
      <button type="submit">Crear Cajero</button>
    </form>
    <div id="resultado-admin" class="alert hidden"></div>
  </div>

  <!-- VER CAJEROS -->
  <div id="tab-admin-ver" class="tab-content">
    <h3>Cajeros Registrados</h3>
    <button onclick="cargarCajerosRegistrados()" class="btn" style="margin-bottom: 15px;">Actualizar Lista</button>
    <div id="lista-cajeros" style="margin-top: 10px;">
      <p>Haga clic en "Actualizar Lista" para ver los cajeros.</p>
    </div>
  </div>
</div>

<!-- ACTIVIDAD DEL CAJERO -->
<div id="tab-admin-actividad" class="tab-content">
  <h3>üîç Actividad del Cajero</h3>
  <p>Consulte todas las operaciones realizadas por un cajero en una fecha espec√≠fica.</p>
  
  <div class="grid-2">
    <div>
      <label>Usuario del Cajero:</label>
      <input type="text" id="usuario-cajero-actividad" placeholder="Ej: juan123" />
    </div>
    <div>
      <label>Fecha:</label>
      <input type="date" id="fecha-actividad" />
    </div>
  </div>
  <button onclick="consultarActividadCajero()" class="btn" style="margin-top: 15px;">Buscar Actividad</button>

  <div id="resultado-actividad-cajero" class="hidden" style="margin-top: 20px;">
    <h4>Operaciones del Cajero <span id="nombre-cajero-actividad"></span> el <span id="fecha-mostrada"></span></h4>
    <div style="max-height: 400px; overflow-y: auto; margin-top: 10px;">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr>
            <th>Hora</th>
            <th>Tipo</th>
            <th>Monto</th>
            <th>Moneda</th>
            <th>Referencia</th>
          </tr>
        </thead>
        <tbody id="tabla-actividad-cajero"></tbody>
      </table>
    </div>
    <div id="resumen-actividad" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;"></div>
  </div>
</div>     
      
      <!-- NUEVO M√ìDULO: TASAS DE CAMBIO -->
      <div id="tasas" class="module">
        <h2>Tasas de Cambio de Divisas</h2>
        <p>Actualice las tasas de cambio para USD y EUR. Las tasas se aplican inmediatamente a todas las operaciones de cambio.</p>
        
        <div class="tasas-container">
          <div class="tasa-card">
            <h4>USD - D√≥lar Estadounidense</h4>
            <div class="tasa-row">
              <label>Compra (Banco compra USD):</label>
              <input type="number" id="tasa-usd-compra-actualizar" step="0.01" min="0.01" placeholder="Ej: 58.50" />
            </div>
            <div class="tasa-row">
              <label>Venta (Banco vende USD):</label>
              <input type="number" id="tasa-usd-venta-actualizar" step="0.01" min="0.01" placeholder="Ej: 59.00" />
            </div>
            <div class="tasa-row">
              <label></label>
              <button class="tasa-update-btn" onclick="actualizarTasaUSD()">Actualizar Tasas USD</button>
            </div>
          </div>
          
          <div class="tasa-card">
            <h4>EUR - Euro</h4>
            <div class="tasa-row">
              <label>Compra (Banco compra EUR):</label>
              <input type="number" id="tasa-eur-compra-actualizar" step="0.01" min="0.01" placeholder="Ej: 65.00" />
            </div>
            <div class="tasa-row">
              <label>Venta (Banco vende EUR):</label>
              <input type="number" id="tasa-eur-venta-actualizar" step="0.01" min="0.01" placeholder="Ej: 66.00" />
            </div>
            <div class="tasa-row">
              <label></label>
              <button class="tasa-update-btn" onclick="actualizarTasaEUR()">Actualizar Tasas EUR</button>
            </div>
          </div>
        </div>
        
        <div id="resultado-tasas" class="tasa-alert hidden"></div>
        
        <h3>Historial de Actualizaciones</h3>
        <div id="historial-tasas" style="margin-top: 20px; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px; background: #f8f9fa;">
          <p>Cargando historial...</p>
        </div>
      </div>

<!-- GESTI√ìN DE CHEQUES -->
<div id="cheques" class="module">
  <h2>üßæ Gesti√≥n de Cheques</h2>
  <div class="tabs">
    <button class="tab-btn active" onclick="mostrarTabCheque('generar')">Generar Cheque</button>
    <button class="tab-btn" onclick="mostrarTabCheque('cambiar')">Cambiar Cheque</button>
    <button class="tab-btn" onclick="mostrarTabCheque('consulta')">Consulta de Cheques</button>
    <button class="tab-btn" onclick="mostrarTabCheque('cambiar-externo')">Cambiar Cheque Externo</button>
  </div>

  <!-- GENERAR CHEQUE -->
  <div id="tab-cheque-generar" class="tab-content active">
    <h3>Generar Nuevo Cheque</h3>
    <form id="form-generar-cheque">
      <label>N√∫mero de Cuenta Corriente (debe ser tipo "corriente"):</label>
      <input type="text" id="cuenta-cheque-generar" placeholder="Ej: SBRD0001" required />
      <label>Beneficiario:</label>
      <input type="text" id="beneficiario-cheque" placeholder="Nombre del beneficiario" required />
      <label>Monto (RD$):</label>
      <input type="number" id="monto-cheque" placeholder="Monto en pesos dominicanos" min="1" step="0.01" required />
      <label>Concepto (opcional):</label>
      <input type="text" id="concepto-cheque" placeholder="Ej: Pago de servicios" />
      <button type="submit">Generar Cheque</button>
    </form>
    <div id="resultado-generar-cheque" class="alert hidden"></div>
    <div id="vista-cheque" class="hidden" style="margin-top: 20px; background: white; padding: 20px; border: 1px solid #ccc; border-radius: 8px; font-family: monospace; max-width: 600px;">
      <h4 style="text-align: center; margin-bottom: 15px;">CHEQUE BANCARIO - SIMUBANK</h4>
      <p><strong>N√∫mero:</strong> <span id="num-cheque-generado">SBCH0000</span></p>
      <p><strong>Fecha:</strong> <span id="fecha-cheque"></span></p>
      <p><strong>Cuenta Origen:</strong> <span id="cuenta-origen-cheque"></span></p>
      <p><strong>Beneficiario:</strong> <span id="beneficiario-vista"></span></p>
      <p><strong>Monto:</strong> RD$ <span id="monto-vista"></span></p>
      <p><strong>Concepto:</strong> <span id="concepto-vista">‚Äî</span></p>
      <p style="margin-top: 30px; text-align: right;"><em>Firma autorizada</em></p>
    </div>
  </div>

  <!-- CAMBIAR CHEQUE (INTERNO) -->
  <div id="tab-cheque-cambiar" class="tab-content">
    <h3>Cambiar Cheque Emitido por Simubank</h3>
    <input type="text" id="numero-cheque-cambiar" placeholder="N√∫mero de cheque (SBCH...)" />
    <input type="text" id="nombre-cliente-cobro" placeholder="Nombre del cliente que cobra el cheque" />
    <button onclick="cambiarChequeInterno()">Cambiar Cheque</button>
    <div id="resultado-cambiar-cheque" class="alert hidden"></div>
  </div>

  <!-- CONSULTA DE CHEQUES -->
  <div id="tab-cheque-consulta" class="tab-content">
    <h3>Consulta de Cheques</h3>
    <input type="text" id="buscar-cheque" placeholder="Buscar por n√∫mero de cheque o cuenta" />
    <button onclick="buscarCheques()">Buscar</button>
    <div id="lista-cheques" style="margin-top: 15px;"></div>
  </div>

  <!-- CAMBIAR CHEQUE EXTERNO -->
  <div id="tab-cheque-cambiar-externo" class="tab-content">
    <h3>Cambiar Cheque de Otra Entidad Bancaria</h3>
    <input type="text" id="cuenta-destino-externo" placeholder="Cuenta del cliente en Simubank" />
    <input type="text" id="nombre-cliente-externo" placeholder="Nombre del cliente" />
    <input type="number" id="monto-cheque-externo" placeholder="Monto del cheque (RD$)" min="1" step="0.01" />
    <input type="text" id="banco-emisor" placeholder="Banco emisor del cheque" />
    <button onclick="cambiarChequeExterno()">Depositar Cheque Externo</button>
    <div id="resultado-cheque-externo" class="alert hidden"></div>
  </div>
</div>

<!-- M√ìDULO DE COPIA DE SEGURIDAD -->
<div id="backup" class="module">
  <h2>üíæ Copia de Seguridad</h2>
  <div class="tabs">
    <button class="tab-btn active" onclick="mostrarTabBackup('exportar')">Exportar Copia de Seguridad</button>
    <button class="tab-btn" onclick="mostrarTabBackup('importar')">Importar Copia de Seguridad</button>
  </div>

  <!-- EXPORTAR -->
  <div id="tab-backup-exportar" class="tab-content active">
    <h3>Exportar Base de Datos</h3>
    <p>Haga clic en el bot√≥n para descargar una copia de seguridad completa del sistema en formato JSON.</p>
    <button class="btn" onclick="exportarBackup()" style="background: #28a745; color: white;">üì§ Descargar Copia de Seguridad</button>
  </div>

  <!-- IMPORTAR -->
  <div id="tab-backup-importar" class="tab-content">
    <h3>Importar Base de Datos</h3>
    <p>Seleccione un archivo JSON de copia de seguridad para restaurar los datos del sistema.</p>
    <input type="file" id="archivo-backup" accept=".json" style="margin: 10px 0; width: 100%;" />
    <button class="btn" onclick="importarBackup()" style="background: #007bff; color: white;">üì• Cargar y Restaurar</button>
    <div id="resultado-backup" class="alert hidden" style="margin-top: 15px;"></div>
   </div>
  </div>
<div id="dashboard" class="module">
  <h2>üìä Dashboard de Rendimiento</h2>
  <div style="margin-bottom: 20px; text-align: center;">
    <label for="fecha-dashboard">Seleccionar fecha:</label>
    <input type="date" id="fecha-dashboard" style="margin-left: 10px; padding: 6px; border-radius: 4px;" />
    <button onclick="cargarDashboardPorFecha()" style="margin-left: 10px; padding: 6px 12px; background: #0056b3; color: white; border: none; border-radius: 4px;">Actualizar</button>
  </div>
  
  <div class="grid-2" style="margin-bottom: 20px;">
    <div class="card" style="text-align: center;">
      <strong>Total Transacciones Hoy</strong>
      <div style="font-size: 2em; color: #0056b3;" id="total-transacciones-hoy">0</div>
    </div>
  </div>
  
  <!-- Monto Total Hoy (por moneda) -->
  <div class="grid-3" style="margin-bottom: 20px;">
    <div class="card">
      <strong>Monto Total Hoy (RD$)</strong>
      <div id="monto-total-rd">RD$ 0.00</div>
    </div>
    <div class="card">
      <strong>Monto Total Hoy (USD)</strong>
      <div id="monto-total-usd">USD 0.00</div>
    </div>
    <div class="card">
      <strong>Monto Total Hoy (EUR)</strong>
      <div id="monto-total-eur">EUR 0.00</div>
    </div>
  </div>
  
  <!-- Gr√°ficos principales - Dos primeros gr√°ficos lado a lado -->
  <div class="grid-2" style="margin-bottom: 20px;">
    <div class="card">
      <h3>Distribuci√≥n por Tipo de Transacci√≥n</h3>
      <canvas id="chart-tipo-transacciones" width="400" height="300"></canvas>
    </div>
    <div class="card">
      <h3>Transacciones por Moneda</h3>
      <canvas id="chart-monedas" width="400" height="300"></canvas>
    </div>
  </div>
  
  <!-- Gr√°fico de evoluci√≥n debajo de los dos anteriores -->
  <div class="card" style="margin-bottom: 20px;">
    <h3>Evoluci√≥n de Transacciones (√öltimos 7 d√≠as)</h3>
    <canvas id="chart-evolucion" width="800" height="300"></canvas>
  </div>
  
  <div class="grid-3" style="margin-top: 20px;">
    <div class="card" style="text-align: center;">
      <strong>Pr√©stamos Activos</strong>
      <div style="font-size: 1.5em; color: #dc3545;" id="prestamos-activos">0</div>
    </div>
    <div class="card" style="text-align: center;">
      <strong>Tarjetas Aprobadas</strong>
      <div style="font-size: 1.5em; color: #17a2b8;" id="tarjetas-aprobadas">0</div>
    </div>
    <div class="card" style="text-align: center;">
      <strong>Cuentas Activas</strong>
      <div style="font-size: 1.5em; color: #ffc107;" id="cuentas-activas">0</div>
    </div>
  </div>
  
  <button onclick="actualizarDashboard()" class="btn" style="margin-top: 20px;">üîÑ Actualizar Dashboard</button>
<button onclick="exportarDashboardPDF()" class="btn" style="background: #d9534f; margin-top: 15px;">üìÑ Exportar Dashboard a PDF</button>
</div>

</div>
    <footer>
      Simubank Beta - Sistema de Gesti√≥n Bancaria | Todos los derechos reservados
    </footer>
    <script>
// Si la URL tiene ?tarjeta=..., mostrar SOLO la tarjeta y detener la ejecuci√≥n
(function() {
  const urlParams = new URLSearchParams(window.location.search);
  const tarjetaData = urlParams.get('tarjeta');
  if (tarjetaData) {
    try {
      const json = atob(decodeURIComponent(tarjetaData));
      const datos = JSON.parse(json);

      const html = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1">
          <title>Tarjeta - Simubank</title>
          <style>
            body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background: #f0f2f5; }
            .tarjeta {
              width: 320px;
              height: 200px;
              border-radius: 15px;
              padding: 20px;
              color: white;
              position: relative;
              box-shadow: 0 8px 20px rgba(0,0,0,0.2);
              font-size: 14px;
            }
            .tarjeta.clasica { background: linear-gradient(135deg, #1e3c72, #2a5298); }
            .tarjeta.oro { background: linear-gradient(135deg, #d4af37, #f9d71c); color: #1a1a1a; }
            .tarjeta.platino { background: linear-gradient(135deg, #c0c0c0, #e6e6e6); color: #1a1a1a; }
            .chip { width: 50px; height: 40px; background: #ccc; border-radius: 8px; float: right; }
            .logo-tarjeta { position: absolute; bottom: 20px; right: 20px; font-weight: bold; font-size: 1.5em; }
            .tarjeta-numero { letter-spacing: 2px; font-family: monospace; font-size: 1.4em; margin: 10px 0; }
            .tarjeta-info { display: flex; justify-content: space-between; margin-top: 30px; font-size: 0.9em; }
		.container {
  		overflow-x: hidden;
	    }
	
		#dashboard {
  		padding: 20px;
  		margin: 0 -20px;
  		background: #fff;
	    }	
          </style>
        </head>
        <body>
          <div class="tarjeta ${datos.tipo.toLowerCase()}">
            <div class="chip"></div>
            <h3>Tarjeta Simubank</h3>
            <div class="tarjeta-numero">${datos.numero}</div>
            <div class="tarjeta-info">
              <div><strong>Titular:</strong><br>${datos.titular}</div>
              <div><strong>Vencimiento:</strong><br>${datos.vencimiento}</div>
            </div>
            <div class="logo-tarjeta">${datos.marca}</div>
          </div>
        </body>
        </html>
      `;
      document.open();
      document.write(html);
      document.close();
      return; // Detener la ejecuci√≥n del resto del script
    } catch (e) {
      alert("‚ùå No se pudo cargar la tarjeta.");
    }
  }
})();

	let inactividadTimer = null;
	const TIEMPO_INACTIVIDAD = 2 * 60 * 1000; // 2 minutos en milisegundos
      let db;
      let usuarioSesion = null;
      let cajaCerrada = false;
      const dbName = "SimubankDB";
      const version = 12; // <-- ¬°¬°¬° Versi√≥n incrementada a 11 !!!
      let transacciones = [];
      const IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.mozIDBKeyRange;	
      const proveedores = {
        telefonia: ["Altice", "Claro", "Viva"],
        energia: ["Edesur", "Edenorte", "Edeeste"],
        streaming: ["Netflix", "Max", "Vix"],
        agua: ["INAPA", "CASD"]
      };
      async function hashPassword(password) {
        const encoder = new TextEncoder();
        const data = encoder.encode(password);
        const hash = await crypto.subtle.digest('SHA-256', data);
        return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
      }

function parsearFechaDDMMYYYY(fechaStr) {
  const partes = fechaStr.split('/');
  if (partes.length !== 3) return null;
  const [dia, mes, anio] = partes.map(Number);
  if (isNaN(dia) || isNaN(mes) || isNaN(anio)) return null;
  return new Date(anio, mes - 1, dia);
}

      function initDB() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(dbName, version);
          request.onupgradeneeded = function(e) {
            db = e.target.result;
            if (!db.objectStoreNames.contains("cuentas")) {
              const store = db.createObjectStore("cuentas", { keyPath: "id", autoIncrement: true });
              store.createIndex("cedula", "cedula", { unique: false });
              store.createIndex("numeroCuenta", "numeroCuenta", { unique: true });
              store.createIndex("saldo", "saldo", { unique: false });
            }
            if (!db.objectStoreNames.contains("inversiones")) {
            const store = db.createObjectStore("inversiones", { keyPath: "id", autoIncrement: true });
            store.createIndex("cuentaVinculada", "cuentaVinculada", { unique: false });
            store.createIndex("codigo", "codigo", { unique: true });
            }	    

            if (!db.objectStoreNames.contains("prestamos")) {
              const store = db.createObjectStore("prestamos", { keyPath: "id", autoIncrement: true });
              store.createIndex("cedula", "cedula", { unique: false });
              store.createIndex("codigo", "codigo", { unique: true });
              store.createIndex("estado", "estado", { unique: false });
            }
            if (!db.objectStoreNames.contains("transacciones")) {
              const store = db.createObjectStore("transacciones", { keyPath: "id", autoIncrement: true });
              store.createIndex("cuenta", "cuenta", { unique: false });
            }
            if (!db.objectStoreNames.contains("sesiones")) {
              const store = db.createObjectStore("sesiones", { keyPath: "id", autoIncrement: true });
              store.createIndex("cajero", "cajero", { unique: false });
              store.createIndex("fecha", "fecha", { unique: false });
            }
            if (!db.objectStoreNames.contains("tarjetas")) {
              const store = db.createObjectStore("tarjetas", { keyPath: "id", autoIncrement: true });
              store.createIndex("cuenta", "cuenta", { unique: true });
              store.createIndex("estado", "estado", { unique: false });
              store.createIndex("numero", "numero", { unique: true });
            }
            if (!db.objectStoreNames.contains("usuarios")) {
              const store = db.createObjectStore("usuarios", { keyPath: "id", autoIncrement: true });
              store.createIndex("usuario", "usuario", { unique: true });
              store.createIndex("rol", "rol", { unique: false });
            }
            if (!db.objectStoreNames.contains("tasas")) {
              const store = db.createObjectStore("tasas", { keyPath: "id", autoIncrement: true });
              store.createIndex("fecha", "fecha", { unique: false });
            }
		if (!db.objectStoreNames.contains("cheques")) {
  		const store = db.createObjectStore("cheques", { keyPath: "id", autoIncrement: true });
  		store.createIndex("numero", "numero", { unique: true });
  		store.createIndex("cuentaOrigen", "cuentaOrigen", { unique: false });
  		store.createIndex("estado", "estado", { unique: false }); // "emitido", "cobrado", "anulado"
		}
            
            // Manejar actualizaci√≥n a versi√≥n 8
            if (e.oldVersion < 8 && e.newVersion >= 8) {
              console.log("Actualizando base de datos a versi√≥n 8: A√±adiendo campo 'estado' a tarjetas.");
              const transaction = e.target.transaction;
              const store = transaction.objectStore("tarjetas");
              store.openCursor().onsuccess = function(event) {
                const cursor = event.target.result;
                if (cursor) {
                  const tarjeta = cursor.value;
                  if (!tarjeta.estado) {
                    tarjeta.estado = "Aprobada";
                    cursor.update(tarjeta);
                  }
                  cursor.continue();
                }
              };
            }
            
            // Manejar actualizaci√≥n a versi√≥n 9
            if (e.oldVersion < 9 && e.newVersion >= 9) {
              console.log("Actualizando base de datos a versi√≥n 9: Creando store de tasas.");
              const transaction = e.target.transaction;
              const store = transaction.objectStore("usuarios");
              
              // Verificar si ya existen tasas en el usuario admin
              const request = store.get("admin");
              request.onsuccess = function() {
                const user = request.result;
                if (user) {
                  // Si ya hay tasas definidas en el usuario, creamos el store de tasas con esos valores
                  const tasasStore = transaction.objectStore("tasas");
                  
                  // Agregar tasas actuales como primer registro
                  const tasaRecord = {
                    fecha: new Date().toISOString(),
                    usd_compra: user.tasaUsdCompra || 58.5,
                    usd_venta: user.tasaUsdVenta || 59.0,
                    eur_compra: user.tasaEurCompra || 65.0,
                    eur_venta: user.tasaEurVenta || 66.0,
                    cajero: user.usuario
                  };
                  tasasStore.add(tasaRecord);
                }
              };
            }
          };
          request.onsuccess = function(e) {
            db = e.target.result;
            resolve(db);
          };
          request.onerror = function(e) {
            console.error("Error al abrir IndexedDB", e);
            reject(e);
          };
        });
      }
      async function initUsuarios() {
        const transaction = db.transaction(["usuarios"], "readonly");
        const store = transaction.objectStore("usuarios");
        const index = store.index("usuario");
        const request = index.get("admin");
        request.onsuccess = async function() {
          if (!request.result) {
            const hash = await hashPassword("admin123");
            const addTrans = db.transaction(["usuarios"], "readwrite");
            const addStore = addTrans.objectStore("usuarios");
            addStore.add({
              usuario: "admin",
              password: hash,
              nombre: "Administrador",
              rol: "admin",
              sucursal: "Central",
              balanceRD: 0,
              balanceUSD: 0,
              balanceEUR: 0,
              tasaUsdCompra: 58.5,
              tasaUsdVenta: 59.0,
              tasaEurCompra: 65.0,
              tasaEurVenta: 66.0
            });
            addTrans.oncomplete = () => console.log("Usuario admin creado por defecto.");
          }
        };
      }
async function mostrarRegistro() {
  const adminUser = prompt("üîí Usuario del administrador:");
  if (adminUser === null) return; // Cancelado

  const adminPass = prompt("üîí Contrase√±a del administrador:");
  if (adminPass === null) return; // Cancelado

  if (adminUser !== "admin") {
    alert("‚ùå Solo el usuario 'admin' puede crear nuevos cajeros.");
    return;
  }

  try {
    const hash = await hashPassword(adminPass);
    const transaction = db.transaction(["usuarios"], "readonly");
    const store = transaction.objectStore("usuarios");
    const request = store.index("usuario").get("admin");
    request.onsuccess = function() {
      const admin = request.result;
      if (admin && admin.password === hash) {
        document.getElementById("login-form").style.display = "none";
        document.getElementById("registro-form").style.display = "block";
      } else {
        alert("‚ùå Credenciales incorrectas.");
      }
    };
    request.onerror = function() {
      alert("‚ùå Error al verificar credenciales del administrador.");
    };
  } catch (error) {
    console.error("Error al verificar admin:", error);
    alert("‚ùå Error interno al validar credenciales.");
  }
}
      
      function mostrarLogin() {
        document.getElementById("registro-form").style.display = "none";
        document.getElementById("login-form").style.display = "block";
      }

      async function registrarCajero() {
        const nombre = document.getElementById("nombre-completo").value.trim();
        const usuario = document.getElementById("nuevo-usuario").value.trim();
        const password = document.getElementById("nueva-password").value;
        const sucursal = document.getElementById("sucursal").value;
        const rd = parseFloat(document.getElementById("balance-rd").value) || 0;
        const usd = parseFloat(document.getElementById("balance-usd").value) || 0;
        const eur = parseFloat(document.getElementById("balance-eur").value) || 0;
        const tasaUsdCompra = parseFloat(document.getElementById("tasa-usd-compra").value);
        const tasaUsdVenta = parseFloat(document.getElementById("tasa-usd-venta").value);
        const tasaEurCompra = parseFloat(document.getElementById("tasa-eur-compra").value);
        const tasaEurVenta = parseFloat(document.getElementById("tasa-eur-venta").value);
        if (!nombre || !usuario || !password) return alert("Complete todos los campos.");
        if (rd < 0 || usd < 0 || eur < 0) return alert("Los balances no pueden ser negativos.");
        if (isNaN(tasaUsdCompra) || isNaN(tasaUsdVenta) || tasaUsdCompra >= tasaUsdVenta)
          return alert("Las tasas de USD deben ser v√°lidas.");
        if (isNaN(tasaEurCompra) || isNaN(tasaEurVenta) || tasaEurCompra >= tasaEurVenta)
          return alert("Las tasas de EUR deben ser v√°lidas.");
        const hash = await hashPassword(password);
        const transaction = db.transaction(["usuarios"], "readwrite");
        const store = transaction.objectStore("usuarios");
        const index = store.index("usuario");
        const check = index.get(usuario);
        check.onsuccess = function() {
          if (check.result) {
            alert("El usuario ya existe.");
          } else {
            store.add({
              usuario,
              password: hash,
              nombre,
              rol: "cajero",
              sucursal,
              balanceRD: rd,
              balanceUSD: usd,
              balanceEUR: eur,
              tasaUsdCompra,
              tasaUsdVenta,
              tasaEurCompra,
              tasaEurVenta
            });
            transaction.oncomplete = () => {
              alert(`Cajero ${usuario} registrado exitosamente.`);
              mostrarLogin();
            };
          }
        };
      }

// Mostrar calculadora seg√∫n moneda seleccionada en dep√≥sito
function mostrarCalculadoraDeposito() {
  const moneda = document.getElementById("moneda-deposito-tab").value;
  const container = document.getElementById("calculadora-deposito-container");
  const campos = document.getElementById("campos-calculadora-deposito");
  const monedaSpan = document.getElementById("moneda-calculada");
  if (!moneda) {
    container.classList.add("hidden");
    return;
  }
  let billetes = [];
  let simbolo = "";
  if (moneda === "RD$") {
    billetes = [2000, 1000, 500, 200, 100, 50, 20, 10, 5, 1];
    simbolo = "RD$";
  } else if (moneda === "USD") {
    billetes = [100, 50, 20, 10, 5, 2, 1];
    simbolo = "USD";
  } else if (moneda === "EUR") {
    billetes = [500, 200, 100, 50, 20, 10, 5];
    simbolo = "EUR";
  }
  monedaSpan.textContent = simbolo;
  let html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">';
  billetes.forEach(b => {
    html += `
      <div><label>${b} x</label></div>
      <div><input type="number" id="calc-dep-${b}" min="0" value="0" oninput="calcularTotalDeposito()"></div>
    `;
  });
  html += '</div>';
  campos.innerHTML = html;
  container.classList.remove("hidden");
  calcularTotalDeposito();
}

function registrarCajeroAdmin() {
  const nombre = document.getElementById("nombre-cajero-nuevo").value.trim();
  const usuario = document.getElementById("usuario-cajero").value.trim();
  const password = document.getElementById("password-cajero").value;
  const sucursal = document.getElementById("sucursal-cajero").value;
  const resultado = document.getElementById("resultado-admin");

  if (!nombre || !usuario || !password) {
    mostrarResultado("error", "‚ùå Complete todos los campos obligatorios.", resultado);
    return;
  }

  // Verificar si el usuario ya existe
  const transaction = db.transaction(["usuarios"], "readwrite");
  const store = transaction.objectStore("usuarios");
  const index = store.index("usuario");
  const check = index.get(usuario);
  
  check.onsuccess = async function() {
    if (check.result) {
      mostrarResultado("error", "‚ùå El usuario ya existe.", resultado);
      return;
    }

    try {
      const hash = await hashPassword(password);
      
      // Crear nuevo cajero con balances iniciales en 0
      const nuevoCajero = {
        usuario,
        password: hash,
        nombre,
        rol: "cajero",
        sucursal,
        balanceRD: 0,
        balanceUSD: 0,
        balanceEUR: 0,
        tasaUsdCompra: usuarioSesion.tasaUsdCompra || 58.5,
        tasaUsdVenta: usuarioSesion.tasaUsdVenta || 59.0,
        tasaEurCompra: usuarioSesion.tasaEurCompra || 65.0,
        tasaEurVenta: usuarioSesion.tasaEurVenta || 66.0
      };

      store.add(nuevoCajero);
      
      transaction.oncomplete = function() {
        mostrarResultado("success", `‚úÖ Cajero ${nombre} registrado exitosamente.`, resultado);
        // Limpiar formulario
        document.getElementById("form-crear-cajero").reset();
      };
      
    } catch (error) {
      console.error("Error al crear cajero:", error);
      mostrarResultado("error", "‚ùå Error al registrar el cajero.", resultado);
    }
  };
  
  check.onerror = function() {
    mostrarResultado("error", "‚ùå Error al verificar el usuario.", resultado);
  };
}

// Tambi√©n necesitamos agregar el event listener para el formulario
document.addEventListener('DOMContentLoaded', function() {
  const formCrearCajero = document.getElementById("form-crear-cajero");
  if (formCrearCajero) {
    formCrearCajero.addEventListener("submit", function(e) {
      e.preventDefault();
      registrarCajeroAdmin();
    });
  }
});

      async function iniciarSesion() {
        const usuario = document.getElementById("cajero-usuario").value.trim();
        const password = document.getElementById("cajero-password").value;
        if (!usuario || !password) {
          alert("Por favor, complete usuario y contrase√±a.");
          return;
        }
        try {
          const hash = await hashPassword(password);
          const transaction = db.transaction(["usuarios"], "readonly");
          const store = transaction.objectStore("usuarios");
          const index = store.index("usuario");
          const request = index.get(usuario);
          request.onsuccess = async function() {
  const user = request.result;
  if (user && user.password === hash) {
    // üîÅ Volver a leer al usuario para asegurar datos frescos (√∫til si cerr√≥ caja antes)
    const freshTrans = db.transaction(["usuarios"], "readonly");
    const freshStore = freshTrans.objectStore("usuarios");
    const freshReq = freshStore.get(user.id);
    freshReq.onsuccess = function() {
      usuarioSesion = freshReq.result;
      document.getElementById("login-screen").classList.add("hidden");
      mostrarFormularioBalanceInicial();
    };
  } else {
    alert("Usuario o contrase√±a incorrectos.");
  }
};
          request.onerror = function() {
            alert("Error al verificar credenciales.");
          };
        } catch (error) {
          console.error("Error en iniciarSesion:", error);
          alert("Error al procesar la autenticaci√≥n.");
        }
      }
function mostrarFormularioBalanceInicial() {
  const formHtml = `
    <div id="modal-balance">
      <div class="modal-content">
        <h3>Balance Inicial de Caja</h3>
        <p><strong>Cajero:</strong> ${usuarioSesion.nombre}</p>
        
        <label>Balance RD$:</label>
        <input type="number" id="balance-inicial-rd" step="0.01" min="0" value="${usuarioSesion.balanceRD || 0}" style="width: 100%; padding: 10px; margin: 10px 0;" />
        <button type="button" onclick="abrirCalculadora('RD')" style="background:#0056b3; color:white; padding:6px 10px; border:none; border-radius:4px; margin-bottom:15px;">üßÆ Cal. balance RD$</button>
        
        <label>Balance USD:</label>
        <input type="number" id="balance-inicial-usd" step="0.01" min="0" value="${usuarioSesion.balanceUSD || 0}" style="width: 100%; padding: 10px; margin: 10px 0;" />
        <button type="button" onclick="abrirCalculadora('USD')" style="background:#007bff; color:white; padding:6px 10px; border:none; border-radius:4px; margin-bottom:15px;">üßÆ Cal. balance US$</button>
        
        <label>Balance EUR:</label>
        <input type="number" id="balance-inicial-eur" step="0.01" min="0" value="${usuarioSesion.balanceEUR || 0}" style="width: 100%; padding: 10px; margin: 10px 0;" />
        <button type="button" onclick="abrirCalculadora('EUR')" style="background:#dc3545; color:white; padding:6px 10px; border:none; border-radius:4px; margin-bottom:20px;">üßÆ Cal. balance EU$</button>
        
        <button onclick="confirmarBalanceInicial()" style="width: 100%; padding: 12px; background: #0056b3; color: white; border: none; border-radius: 5px;">Confirmar Balance</button>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', formHtml);
}

function mostrarFormularioTasasDelDia() {
  const tasasFormHtml = `
    <div id="modal-tasas-dia" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 2000;">
      <div class="modal-content" style="background: white; padding: 25px; border-radius: 10px; width: 500px; max-width: 95%;">
        <h3>üìà Tasas del D√≠a</h3>
        <p><strong>Cajero:</strong> ${usuarioSesion.nombre}</p>

        <h4 style="margin-top: 20px;">D√≥lar Estadounidense (USD)</h4>
        <div class="grid-2" style="gap: 12px;">
          <div>
            <label>Compra:</label>
            <input type="number" id="tasa-usd-compra-dia" step="0.01" min="0.01" placeholder="Ej: 58.50" style="width:100%; padding:8px; margin-top:5px;" />
          </div>
          <div>
            <label>Venta:</label>
            <input type="number" id="tasa-usd-venta-dia" step="0.01" min="0.01" placeholder="Ej: 59.00" style="width:100%; padding:8px; margin-top:5px;" />
          </div>
        </div>

        <h4 style="margin-top: 20px;">Euro (EUR)</h4>
        <div class="grid-2" style="gap: 12px;">
          <div>
            <label>Compra:</label>
            <input type="number" id="tasa-eur-compra-dia" step="0.01" min="0.01" placeholder="Ej: 65.00" style="width:100%; padding:8px; margin-top:5px;" />
          </div>
          <div>
            <label>Venta:</label>
            <input type="number" id="tasa-eur-venta-dia" step="0.01" min="0.01" placeholder="Ej: 66.00" style="width:100%; padding:8px; margin-top:5px;" />
          </div>
        </div>

        <h4 style="margin-top: 20px;">Tasa de Inversi√≥n (% anual)</h4>
        <div class="grid-2" style="gap: 12px;">
          <div>
            <label>RD$:</label>
            <input type="number" id="tasa-inversion-rd" step="0.1" min="0.1" placeholder="Ej: 8.5" style="width:100%; padding:8px; margin-top:5px;" />
          </div>
          <div>
            <label>USD:</label>
            <input type="number" id="tasa-inversion-usd" step="0.1" min="0.1" placeholder="Ej: 5.2" style="width:100%; padding:8px; margin-top:5px;" />
          </div>
          <div>
            <label>EUR:</label>
            <input type="number" id="tasa-inversion-eur" step="0.1" min="0.1" placeholder="Ej: 4.8" style="width:100%; padding:8px; margin-top:5px;" />
          </div>
        </div>

        <button onclick="confirmarTasasDelDia()" style="width: 100%; margin-top: 20px; padding: 12px; background: #0056b3; color: white; border: none; border-radius: 5px;">
          Confirmar Tasas del D√≠a
        </button>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', tasasFormHtml);
}

function confirmarTasasDelDia() {
  const usdCompra = parseFloat(document.getElementById("tasa-usd-compra-dia").value);
  const usdVenta = parseFloat(document.getElementById("tasa-usd-venta-dia").value);
  const eurCompra = parseFloat(document.getElementById("tasa-eur-compra-dia").value);
  const eurVenta = parseFloat(document.getElementById("tasa-eur-venta-dia").value);

  if (isNaN(usdCompra) || isNaN(usdVenta) || usdCompra >= usdVenta) {
    alert("Las tasas de USD deben ser v√°lidas y la compra debe ser menor que la venta.");
    return;
  }
  if (isNaN(eurCompra) || isNaN(eurVenta) || eurCompra >= eurVenta) {
    alert("Las tasas de EUR deben ser v√°lidas y la compra debe ser menor que la venta.");
    return;
  }

  // Guardar tasas en la sesi√≥n
  usuarioSesion.tasaUsdCompra = usdCompra;
  usuarioSesion.tasaUsdVenta = usdVenta;
  usuarioSesion.tasaEurCompra = eurCompra;
  usuarioSesion.tasaEurVenta = eurVenta;

  // Guardar tasas de inversi√≥n
  window.tasasInversion = {
    "RD$": parseFloat(document.getElementById("tasa-inversion-rd").value) || 0,
    "USD": parseFloat(document.getElementById("tasa-inversion-usd").value) || 0,
    "EUR": parseFloat(document.getElementById("tasa-inversion-eur").value) || 0
  };

  // Guardar en IndexedDB
  const trans = db.transaction(["usuarios"], "readwrite");
  const store = trans.objectStore("usuarios");
  const req = store.index("usuario").get(usuarioSesion.usuario);
  req.onsuccess = function() {
    const user = req.result;
    if (user) {
      user.tasaUsdCompra = usdCompra;
      user.tasaUsdVenta = usdVenta;
      user.tasaEurCompra = eurCompra;
      user.tasaEurVenta = eurVenta;
      store.put(user);
      registrarHistorialTasa("USD", usdCompra, usdVenta, usuarioSesion.nombre);
      registrarHistorialTasa("EUR", eurCompra, eurVenta, usuarioSesion.nombre);
    }
  };

  // Cerrar modal y continuar
  document.getElementById("modal-tasas-dia").remove();
  continuarConInicioSesion(); // Este m√©todo ya actualiza el header
}

// Mostrar calculadora seg√∫n moneda seleccionada en retiro
function mostrarCalculadoraRetiro() {
  const moneda = document.getElementById("moneda-retiro-tab").value;
  const container = document.getElementById("calculadora-retiro-container");
  const campos = document.getElementById("campos-calculadora-retiro");
  const monedaSpan = document.getElementById("moneda-calculada-retiro");

  if (!moneda) {
    container.classList.add("hidden");
    return;
  }

  let billetes = [];
  let simbolo = "";
  if (moneda === "RD$") {
    billetes = [2000, 1000, 500, 200, 100, 50, 20, 10, 5, 1];
    simbolo = "RD$";
  } else if (moneda === "USD") {
    billetes = [100, 50, 20, 10, 5, 2, 1];
    simbolo = "USD";
  } else if (moneda === "EUR") {
    billetes = [500, 200, 100, 50, 20, 10, 5];
    simbolo = "EUR";
  }

  monedaSpan.textContent = simbolo;
  let html = '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">';
  billetes.forEach(b => {
    html += `
      <div><label>${b} x</label></div>
      <div><input type="number" id="calc-ret-${b}" min="0" value="0" oninput="calcularTotalRetiro()"></div>
    `;
  });
  html += '</div>';
  campos.innerHTML = html;
  container.classList.remove("hidden");
  calcularTotalRetiro();
}

// Calcular total del retiro seg√∫n billetes ingresados
function calcularTotalRetiro() {
  const moneda = document.getElementById("moneda-retiro-tab").value;
  if (!moneda) return;

  let total = 0;
  let billetes = [];
  if (moneda === "RD$") billetes = [2000, 1000, 500, 200, 100, 50, 20, 10, 5, 1];
  else if (moneda === "USD") billetes = [100, 50, 20, 10, 5, 2, 1];
  else if (moneda === "EUR") billetes = [500, 200, 100, 50, 20, 10, 5];

  billetes.forEach(b => {
    const input = document.getElementById(`calc-ret-${b}`);
    const val = parseInt(input?.value) || 0;
    total += val * b;
  });

  document.getElementById("total-calculado-retiro").textContent = total.toFixed(2);
}

// Calcular total del dep√≥sito seg√∫n billetes ingresados
function calcularTotalDeposito() {
  const moneda = document.getElementById("moneda-deposito-tab").value;
  if (!moneda) return;

  let total = 0;
  let billetes = [];
  if (moneda === "RD$") billetes = [2000, 1000, 500, 200, 100, 50, 20, 10, 5, 1];
  else if (moneda === "USD") billetes = [100, 50, 20, 10, 5, 2, 1];
  else if (moneda === "EUR") billetes = [500, 200, 100, 50, 20, 10, 5];

  billetes.forEach(b => {
    const input = document.getElementById(`calc-dep-${b}`);
    const val = parseInt(input?.value) || 0;
    total += val * b;
  });

  document.getElementById("total-calculado-deposito").textContent = total.toFixed(2);
}

// --- Calculadoras de billetes ---
function abrirCalculadora(moneda) {
  let billetes = [];
  let titulo = "";

  if (moneda === "RD") {
    billetes = [1, 5, 10, 20, 50, 100, 200, 500, 1000, 2000];
    titulo = "C√°lculo de Billetes - Pesos Dominicanos (RD$)";
  } else if (moneda === "USD") {
    billetes = [1, 2, 5, 10, 20, 50, 100];
    titulo = "C√°lculo de Billetes - D√≥lares Estadounidenses (USD)";
  } else if (moneda === "EUR") {
    billetes = [5, 10, 20, 50, 100, 200, 500];
    titulo = "C√°lculo de Billetes - Euros (EUR)";
  }

  let camposHtml = billetes.map(b => `
    <div class="tasa-row">
      <label>${b} x</label>
      <input type="number" id="calc-${moneda}-${b}" value="0" min="0" step="1" oninput="actualizarTotalCalculadora('${moneda}')">
    </div>
  `).join("");

  const modalHtml = `
    <div id="modal-calculadora" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center; z-index:2000;">
      <div class="modal-content" style="background:white; padding:20px; border-radius:10px; width:400px; max-width:90%;">
        <h3>${titulo}</h3>
        <div style="max-height:400px; overflow-y:auto;">
          ${camposHtml}
        </div>
        <div style="margin-top:15px; padding:10px; background:#f8f9fa; border-radius:5px; font-weight:bold;">
          Total: <span id="total-calculado-${moneda}">0.00</span> ${moneda === 'RD' ? 'RD$' : moneda}
        </div>
        <div style="margin-top:15px; display:flex; gap:10px;">
          <button onclick="aplicarCalculo('${moneda}')" style="flex:1; background:#28a745; color:white; padding:8px; border:none; border-radius:5px;">Aplicar a Balance</button>
          <button onclick="cerrarCalculadora()" style="flex:1; background:#6c757d; color:white; padding:8px; border:none; border-radius:5px;">Cerrar</button>
        </div>
      </div>
    </div>
  `;

  document.body.insertAdjacentHTML('beforeend', modalHtml);
  actualizarTotalCalculadora(moneda);
}

function actualizarTotalCalculadora(moneda) {
  let total = 0;
  const billetes = moneda === "RD" ? [1,5,10,20,50,100,200,500,1000,2000] :
                  moneda === "USD" ? [1,2,5,10,20,50,100] :
                  [5,10,20,50,100,200,500];

  billetes.forEach(b => {
    const input = document.getElementById(`calc-${moneda}-${b}`);
    const cantidad = parseInt(input?.value) || 0;
    total += cantidad * b;
  });

  document.getElementById(`total-calculado-${moneda}`).textContent = total.toFixed(2);
}

function aplicarCalculo(moneda) {
  const total = parseFloat(document.getElementById(`total-calculado-${moneda}`).textContent);
  if (moneda === "RD") {
    document.getElementById("balance-inicial-rd").value = total;
  } else if (moneda === "USD") {
    document.getElementById("balance-inicial-usd").value = total;
  } else if (moneda === "EUR") {
    document.getElementById("balance-inicial-eur").value = total;
  }
  cerrarCalculadora();
}
function cerrarCalculadora() {
  const modal = document.getElementById("modal-calculadora");
  if (modal) modal.remove();
}

function confirmarBalanceInicial() {
  const rd = parseFloat(document.getElementById("balance-inicial-rd").value) || 0;
  const usd = parseFloat(document.getElementById("balance-inicial-usd").value) || 0;
  const eur = parseFloat(document.getElementById("balance-inicial-eur").value) || 0;
  if (rd < 0 || usd < 0 || eur < 0) {
    return alert("Los balances no pueden ser negativos.");
  }
  usuarioSesion.balanceRD = rd;
  usuarioSesion.balanceUSD = usd;
  usuarioSesion.balanceEUR = eur;
  const modal = document.getElementById("modal-balance");
  if (modal) modal.remove();

  // üëâ En lugar de continuar directamente, mostramos el modal de tasas
  mostrarFormularioTasasDelDia();
}

	function continuarConInicioSesion() {
	cajaCerrada = false;
  	document.getElementById("main-page").classList.remove("hidden");
  	document.getElementById("nombre-cajero").textContent = usuarioSesion.nombre;
  	document.getElementById("sucursal-actual").textContent = usuarioSesion.sucursal;
  	document.getElementById("sucursal-cuenta").value = usuarioSesion.sucursal;
	document.getElementById("oficial-cuenta").value = usuarioSesion.nombre;
  	document.getElementById("balance-rd-display").textContent = `RD$ ${usuarioSesion.balanceRD.toFixed(2)}`;
  	document.getElementById("balance-usd-display").textContent = `USD ${usuarioSesion.balanceUSD.toFixed(2)}`;
  	document.getElementById("balance-eur-display").textContent = `EUR ${usuarioSesion.balanceEUR.toFixed(2)}`;
	calcularEfectivoDisponible();
  	actualizarReloj();
  	setInterval(actualizarReloj, 1000);
  	cargarTodasTransacciones();
  	document.getElementById("btn-admin").style.display = usuarioSesion.rol === "admin" ? "block" : "none";
  	const rolesConPermisoApertura = ["admin", "cajero"];
  	document.getElementById("btn-apertura").style.display = 
    	rolesConPermisoApertura.includes(usuarioSesion.rol) ? "block" : "none";
  	document.getElementById("btn-tasas").style.display = "block";
  	cargarTasasActuales();
	actualizarTasasEnHeader();
  	cargarHistorialTasas();

  	// üëá NUEVO: Mostrar mensaje de bienvenida
  	mostrarBienvenida();
	reiniciarTemporizadorInactividad(); // üëà Inicia el control de inactividad
	}

function cerrarSesion() {
  if (!cajaCerrada) {
    alert("‚ö†Ô∏è Debe cerrar la caja antes de cerrar sesi√≥n.");
    return;
  }
  if (confirm("¬øEst√° seguro de cerrar sesi√≥n?")) {
    if (inactividadTimer) {
      clearTimeout(inactividadTimer);
      inactividadTimer = null;
    }
    document.getElementById("main-page").classList.add("hidden");
    document.getElementById("login-screen").classList.remove("hidden");
    document.getElementById("cajero-usuario").value = "";
    document.getElementById("cajero-password").value = "";
    usuarioSesion = null;
    cajaCerrada = false; // Reiniciar para la pr√≥xima sesi√≥n
  }
}

	function reiniciarTemporizadorInactividad() {
  // Limpiar el temporizador anterior si existe
  if (inactividadTimer) {
    clearTimeout(inactividadTimer);
  }
  // Establecer nuevo temporizador
  inactividadTimer = setTimeout(() => {
    if (usuarioSesion) {
      alert("üîí Sesi√≥n cerrada por inactividad.");
      cerrarSesion();
    }
  }, TIEMPO_INACTIVIDAD);
}

      function actualizarReloj() {
        const now = new Date();
        document.getElementById("fecha-hora").textContent = now.toLocaleString();
      }
      function mostrarModulo(id) {
        document.querySelectorAll(".module").forEach(m => m.classList.remove("active"));
        document.getElementById(id).classList.add("active");
        if (id === 'consultas') filtrarTransacciones();
        if (id === 'cambio') cargarTasasActuales();
        if (id === 'tasas') cargarHistorialTasas();
      }
      function mostrarTab(tabName) {
document.getElementById("form-calculadora").addEventListener("submit", function(e) {
  e.preventDefault();
  const monto = parseFloat(document.getElementById("calc-monto").value);
  const plazo = parseInt(document.getElementById("calc-plazo").value);
  const tasaAnual = parseFloat(document.getElementById("calc-tasa").value);
  const formaPago = document.getElementById("calc-forma-pago").value;

  if (isNaN(monto) || isNaN(plazo) || isNaN(tasaAnual) || monto <= 0 || plazo <= 0 || tasaAnual <= 0) {
    alert("Por favor, ingrese valores v√°lidos y positivos.");
    return;
  }

  // Calcular la tasa peri√≥dica
  let periodosPorAno;
  switch (formaPago) {
    case 'mensual':
      periodosPorAno = 12;
      break;
    case 'quincenal':
      periodosPorAno = 24;
      break;
    case 'semanal':
      periodosPorAno = 52;
      break;
    default:
      periodosPorAno = 12;
  }

  const tasaPeriodica = tasaAnual / 100 / periodosPorAno;
  const numeroCuotas = plazo * (periodosPorAno / 12); // Ajustar el n√∫mero de cuotas seg√∫n la frecuencia

  // F√≥rmula de la cuota fija: C = P * [i(1+i)^n] / [(1+i)^n - 1]
  const cuota = monto * (tasaPeriodica * Math.pow(1 + tasaPeriodica, numeroCuotas)) / (Math.pow(1 + tasaPeriodica, numeroCuotas) - 1);

  // Calcular totales
  const totalAPagar = cuota * numeroCuotas;
  const totalIntereses = totalAPagar - monto;

  // Mostrar resultados resumidos
  document.getElementById("res-monto").textContent = monto.toFixed(2);
  document.getElementById("res-plazo").textContent = plazo;
  document.getElementById("res-tasa").textContent = tasaAnual.toFixed(2);
  document.getElementById("res-forma-pago").textContent = formaPago.charAt(0).toUpperCase() + formaPago.slice(1);
  document.getElementById("res-cuota").textContent = cuota.toFixed(2);
  document.getElementById("res-total").textContent = totalAPagar.toFixed(2);
  document.getElementById("res-intereses").textContent = totalIntereses.toFixed(2);

  document.getElementById("resultado-calculadora").classList.remove("hidden");

  // Generar la tabla de amortizaci√≥n
  const tbody = document.getElementById("cuerpo-tabla-amortizacion");
  tbody.innerHTML = "";

  let saldo = monto;
  const hoy = new Date();

  for (let i = 1; i <= numeroCuotas; i++) {
    const interes = saldo * tasaPeriodica;
    const capital = cuota - interes;
    saldo -= capital;

    // Asegurar que el saldo no sea negativo por errores de redondeo
    if (saldo < 0) saldo = 0;

    // Calcular la fecha de vencimiento
    const fechaVencimiento = new Date(hoy);
    switch (formaPago) {
      case 'mensual':
        fechaVencimiento.setMonth(hoy.getMonth() + i);
        break;
      case 'quincenal':
        fechaVencimiento.setDate(hoy.getDate() + (i * 15));
        break;
      case 'semanal':
        fechaVencimiento.setDate(hoy.getDate() + (i * 7));
        break;
    }

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="border: 1px solid #ddd; padding: 8px;">${i}</td>
      <td style="border: 1px solid #ddd; padding: 8px;">${fechaVencimiento.toLocaleDateString()}</td>
      <td style="border: 1px solid #ddd; padding: 8px;">${cuota.toFixed(2)}</td>
      <td style="border: 1px solid #ddd; padding: 8px;">${capital.toFixed(2)}</td>
      <td style="border: 1px solid #ddd; padding: 8px;">${interes.toFixed(2)}</td>
      <td style="border: 1px solid #ddd; padding: 8px;">${saldo.toFixed(2)}</td>
    `;
    tbody.appendChild(tr);
  }

  document.getElementById("tabla-amortizacion").classList.remove("hidden");
});
        document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active"));
        document.querySelectorAll(".tab-btn").forEach(t => t.classList.remove("active"));
        document.getElementById(`tab-${tabName}`).classList.add("active");
        const index = {solicitud:0, aprobar:1, cobro:2, consulta:3}[tabName];
        document.querySelectorAll(".tab-btn")[index].classList.add("active");
      }
      function mostrarTabTarjeta(tabName) {
  	document.querySelectorAll("#tarjetas .tab-content").forEach(t => t.classList.remove("active"));
  	document.querySelectorAll("#tarjetas .tab-btn").forEach(t => t.classList.remove("active"));
  	document.getElementById(`tab-tarjeta-${tabName}`).classList.add("active");
  	const index = {solicitud:0, aprobar:1, debitar:2, avance:3, cobro:4, consulta:5}[tabName];
  	document.querySelectorAll("#tarjetas .tab-btn")[index].classList.add("active");
	}

	function mostrarTabAdmin(tabName) {
  	document.querySelectorAll("#admin .tab-content").forEach(t => t.classList.remove("active"));
  	document.querySelectorAll("#admin .tab-btn").forEach(t => t.classList.remove("active"));
  	document.getElementById(`tab-admin-${tabName}`).classList.add("active");
  	const index = {crear: 0, ver: 1, actividad: 2}[tabName];
  	const btns = document.querySelectorAll("#admin .tab-btn");
  	if (btns[index]) btns[index].classList.add("active");
	}
	
	function mostrarTabInforme(tabName) {
	document.querySelectorAll("#informes .tab-content").forEach(t => t.classList.remove("active"));
  	document.querySelectorAll("#informes .tab-btn").forEach(t => t.classList.remove("active"));
  	document.getElementById(`tab-informe-${tabName}`).classList.add("active");
  	const index = {diario:0, prestamos:1, tarjetas:2, transacciones:3}[tabName];
  	document.querySelectorAll("#informes .tab-btn")[index].classList.add("active");
	}

// Reemplazar la funci√≥n cerrarCaja existente
function cerrarCaja() {
  mostrarCalculadoraCierre();
}

// Nueva funci√≥n para mostrar la calculadora de cierre
function mostrarCalculadoraCierre() {
  const formHtml = `
    <div id="modal-cierre" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 2000;">
      <div class="modal-content" style="background: white; padding: 30px; border-radius: 10px; width: 500px; max-width: 90%; max-height: 90vh; overflow-y: auto;">
        <h3>üßÆ Calculadora de Cierre de Caja</h3>
        <p><strong>Cajero:</strong> ${usuarioSesion.nombre}</p>
        <p style="margin-bottom: 20px; color: #666;">Calcule el efectivo final en caja para cada moneda:</p>
        
        <!-- PESOS DOMINICANOS (RD$) -->
        <div style="margin-bottom: 25px; padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
          <h4 style="margin-bottom: 15px; color: #0056b3;">Pesos Dominicanos (RD$)</h4>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
            <div style="font-weight: bold;">Denominaci√≥n</div>
            <div style="font-weight: bold;">Cantidad</div>
            
            <div>2000 x</div>
            <input type="number" id="cierre-rd-2000" value="0" min="0" step="1" oninput="actualizarTotalCierre('rd')" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            
            <div>1000 x</div>
            <input type="number" id="cierre-rd-1000" value="0" min="0" step="1" oninput="actualizarTotalCierre('rd')" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            
            <div>500 x</div>
            <input type="number" id="cierre-rd-500" value="0" min="0" step="1" oninput="actualizarTotalCierre('rd')" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            
            <div>200 x</div>
            <input type="number" id="cierre-rd-200" value="0" min="0" step="1" oninput="actualizarTotalCierre('rd')" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            
            <div>100 x</div>
            <input type="number" id="cierre-rd-100" value="0" min="0" step="1" oninput="actualizarTotalCierre('rd')" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            
            <div>50 x</div>
            <input type="number" id="cierre-rd-50" value="0" min="0" step="1" oninput="actualizarTotalCierre('rd')" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            
            <div>20 x</div>
            <input type="number" id="cierre-rd-20" value="0" min="0" step="1" oninput="actualizarTotalCierre('rd')" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            
            <div>10 x</div>
            <input type="number" id="cierre-rd-10" value="0" min="0" step="1" oninput="actualizarTotalCierre('rd')" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            
            <div>5 x</div>
            <input type="number" id="cierre-rd-5" value="0" min="0" step="1" oninput="actualizarTotalCierre('rd')" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            
            <div>1 x</div>
            <input type="number" id="cierre-rd-1" value="0" min="0" step="1" oninput="actualizarTotalCierre('rd')" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
          </div>
          
          <div style="padding: 12px; background: #f8f9fa; border-radius: 5px; font-weight: bold; text-align: center;">
            Total RD$: <span id="total-cierre-rd">0.00</span>
          </div>
        </div>
        
        <!-- D√ìLARES (USD) -->
        <div style="margin-bottom: 25px; padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
          <h4 style="margin-bottom: 15px; color: #007bff;">D√≥lares Estadounidenses (USD)</h4>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
            <div style="font-weight: bold;">Denominaci√≥n</div>
            <div style="font-weight: bold;">Cantidad</div>
            
            <div>100 x</div>
            <input type="number" id="cierre-usd-100" value="0" min="0" step="1" oninput="actualizarTotalCierre('usd')" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            
            <div>50 x</div>
            <input type="number" id="cierre-usd-50" value="0" min="0" step="1" oninput="actualizarTotalCierre('usd')" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            
            <div>20 x</div>
            <input type="number" id="cierre-usd-20" value="0" min="0" step="1" oninput="actualizarTotalCierre('usd')" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            
            <div>10 x</div>
            <input type="number" id="cierre-usd-10" value="0" min="0" step="1" oninput="actualizarTotalCierre('usd')" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            
            <div>5 x</div>
            <input type="number" id="cierre-usd-5" value="0" min="0" step="1" oninput="actualizarTotalCierre('usd')" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            
            <div>2 x</div>
            <input type="number" id="cierre-usd-2" value="0" min="0" step="1" oninput="actualizarTotalCierre('usd')" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            
            <div>1 x</div>
            <input type="number" id="cierre-usd-1" value="0" min="0" step="1" oninput="actualizarTotalCierre('usd')" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
          </div>
          
          <div style="padding: 12px; background: #f8f9fa; border-radius: 5px; font-weight: bold; text-align: center;">
            Total USD: <span id="total-cierre-usd">0.00</span>
          </div>
        </div>
        
        <!-- EUROS (EUR) -->
        <div style="margin-bottom: 25px; padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
          <h4 style="margin-bottom: 15px; color: #dc3545;">Euros (EUR)</h4>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
            <div style="font-weight: bold;">Denominaci√≥n</div>
            <div style="font-weight: bold;">Cantidad</div>
            
            <div>500 x</div>
            <input type="number" id="cierre-eur-500" value="0" min="0" step="1" oninput="actualizarTotalCierre('eur')" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            
            <div>200 x</div>
            <input type="number" id="cierre-eur-200" value="0" min="0" step="1" oninput="actualizarTotalCierre('eur')" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            
            <div>100 x</div>
            <input type="number" id="cierre-eur-100" value="0" min="0" step="1" oninput="actualizarTotalCierre('eur')" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            
            <div>50 x</div>
            <input type="number" id="cierre-eur-50" value="0" min="0" step="1" oninput="actualizarTotalCierre('eur')" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            
            <div>20 x</div>
            <input type="number" id="cierre-eur-20" value="0" min="0" step="1" oninput="actualizarTotalCierre('eur')" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            
            <div>10 x</div>
            <input type="number" id="cierre-eur-10" value="0" min="0" step="1" oninput="actualizarTotalCierre('eur')" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            
            <div>5 x</div>
            <input type="number" id="cierre-eur-5" value="0" min="0" step="1" oninput="actualizarTotalCierre('eur')" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
          </div>
          
          <div style="padding: 12px; background: #f8f9fa; border-radius: 5px; font-weight: bold; text-align: center;">
            Total EUR: <span id="total-cierre-eur">0.00</span>
          </div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button onclick="confirmarCierreCaja()" style="flex: 1; padding: 12px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
            ‚úÖ Confirmar Cierre
          </button>
          <button onclick="cancelarCierre()" style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">
            ‚ùå Cancelar
          </button>
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', formHtml);
  
  // Inicializar con los valores actuales de caja
  actualizarTotalCierre('rd');
  actualizarTotalCierre('usd');
  actualizarTotalCierre('eur');
}

// Funci√≥n para calcular el total de cada moneda en el cierre
function actualizarTotalCierre(moneda) {
  let total = 0;
  
  if (moneda === 'rd') {
    const billetes = [2000, 1000, 500, 200, 100, 50, 20, 10, 5, 1];
    billetes.forEach(b => {
      const input = document.getElementById(`cierre-rd-${b}`);
      const cantidad = parseInt(input?.value) || 0;
      total += cantidad * b;
    });
    document.getElementById("total-cierre-rd").textContent = total.toFixed(2);
  } 
  else if (moneda === 'usd') {
    const billetes = [100, 50, 20, 10, 5, 2, 1];
    billetes.forEach(b => {
      const input = document.getElementById(`cierre-usd-${b}`);
      const cantidad = parseInt(input?.value) || 0;
      total += cantidad * b;
    });
    document.getElementById("total-cierre-usd").textContent = total.toFixed(2);
  } 
  else if (moneda === 'eur') {
    const billetes = [500, 200, 100, 50, 20, 10, 5];
    billetes.forEach(b => {
      const input = document.getElementById(`cierre-eur-${b}`);
      const cantidad = parseInt(input?.value) || 0;
      total += cantidad * b;
    });
    document.getElementById("total-cierre-eur").textContent = total.toFixed(2);
  }
}

// Funci√≥n para confirmar el cierre de caja con los valores calculados
function confirmarCierreCaja() {
  const balanceRD = parseFloat(document.getElementById("total-cierre-rd").textContent);
  const balanceUSD = parseFloat(document.getElementById("total-cierre-usd").textContent);
  const balanceEUR = parseFloat(document.getElementById("total-cierre-eur").textContent);

  if (balanceRD < 0 || balanceUSD < 0 || balanceEUR < 0) {
    alert("‚ùå Los balances no pueden ser negativos.");
    return;
  }

  // Guardar en la base de datos del usuario
  const transaction = db.transaction(["usuarios"], "readwrite");
  const store = transaction.objectStore("usuarios");
  const index = store.index("usuario");
  const request = index.get(usuarioSesion.usuario);

  request.onsuccess = function() {
    const user = request.result;
    if (user) {
      user.balanceRD = balanceRD;
      user.balanceUSD = balanceUSD;
      user.balanceEUR = balanceEUR;
      store.put(user);
      
      // üîÑ LIMPIAR TRANSACCIONES DEL D√çA
      limpiarTransaccionesDelDia();
      
      // üîÑ LIMPIAR ESTAD√çSTICAS EN PANTALLA
      limpiarEstadisticasResumen();
      
      cajaCerrada = true; 
      
      // Cerrar el modal
      const modal = document.getElementById("modal-cierre");
      if (modal) modal.remove();
      
      alert(`‚úÖ Caja cerrada.\nBalance final guardado:\nRD$ ${balanceRD.toFixed(2)}\nUSD ${balanceUSD.toFixed(2)}\nEUR ${balanceEUR.toFixed(2)}\n\nLas transacciones del d√≠a han sido limpiadas.`);
    }
  };

  request.onerror = function() {
    alert("‚ùå Error al guardar el balance de cierre.");
  };
}

// Funci√≥n para cancelar el cierre
function cancelarCierre() {
  const modal = document.getElementById("modal-cierre");
  if (modal) modal.remove();
}

// üîÑ NUEVA FUNCI√ìN: Limpiar estad√≠sticas del resumen
function limpiarEstadisticasResumen() {
  // Limpiar todos los totales en el resumen
  document.getElementById("total-depositos-rd").textContent = "RD$ 0.00";
  document.getElementById("total-depositos-usd").textContent = "USD 0.00";
  document.getElementById("total-depositos-eur").textContent = "EUR 0.00";
  
  document.getElementById("total-retiros-rd").textContent = "RD$ 0.00";
  document.getElementById("total-retiros-usd").textContent = "USD 0.00";
  document.getElementById("total-retiros-eur").textContent = "EUR 0.00";
  
  document.getElementById("total-pagos-servicios").textContent = "RD$ 0.00";
  
  // Tambi√©n limpiar el array de transacciones en memoria
  transacciones = [];
  
  // Actualizar la tabla de historial si est√° visible
  if (document.getElementById("consultas").classList.contains("active")) {
    filtrarTransacciones();
  }
  
  console.log("‚úÖ Estad√≠sticas del resumen limpiadas despu√©s del cierre de caja.");
}

// üîÑ FUNCI√ìN MEJORADA: Limpiar transacciones del d√≠a actual
function limpiarTransaccionesDelDia() {
  const hoy = new Date().toLocaleDateString();
  let transaccionesEliminadas = 0;
  
  const transaction = db.transaction(["transacciones"], "readwrite");
  const store = transaction.objectStore("transacciones");
  const request = store.openCursor();
  
  request.onsuccess = function(e) {
    const cursor = e.target.result;
    if (cursor) {
      const transaccion = cursor.value;
      // Si la transacci√≥n es de hoy, eliminarla
      if (transaccion.fecha.includes(hoy)) {
        cursor.delete();
        transaccionesEliminadas++;
      }
      cursor.continue();
    } else {
      console.log(`üóëÔ∏è Eliminadas ${transaccionesEliminadas} transacciones del d√≠a ${hoy}`);
    }
  };
  
  request.onerror = function() {
    console.error("Error al limpiar transacciones del d√≠a");
  };
}

// üîÑ NUEVA FUNCI√ìN: Limpiar transacciones del d√≠a actual
function limpiarTransaccionesDelDia() {
  const hoy = new Date().toLocaleDateString();
  
  const transaction = db.transaction(["transacciones"], "readwrite");
  const store = transaction.objectStore("transacciones");
  const request = store.openCursor();
  
  request.onsuccess = function(e) {
    const cursor = e.target.result;
    if (cursor) {
      const transaccion = cursor.value;
      // Si la transacci√≥n es de hoy, eliminarla
      if (transaccion.fecha.includes(hoy)) {
        cursor.delete();
      }
      cursor.continue();
    }
  };
  
  request.onerror = function() {
    console.error("Error al limpiar transacciones del d√≠a");
  };
}

function generarNumeroCuenta(moneda, tipoCuenta) {
  return new Promise((resolve) => {
    const transaction = db.transaction(["cuentas"], "readonly");
    const store = transaction.objectStore("cuentas");
    const index = store.index("numeroCuenta");
    let maxNum = 0;
    index.openCursor().onsuccess = function(e) {
      const cursor = e.target.result;
      if (cursor) {
        const numStr = cursor.key;
        let match;

        // Solo para RD$: asignar prefijo seg√∫n tipo de cuenta
        if (moneda === "RD$") {
          const prefijosPorTipo = {
            "corriente": "SBCR",
            "nomina": "SBNM",
            "infantil": "SBIN",
            "empresarial": "SBEM",
            "cheques": "SBCC",
            "ahorros": "SBRD"
          };

          for (const [tipo, prefijo] of Object.entries(prefijosPorTipo)) {
            if (tipoCuenta === tipo && numStr.startsWith(prefijo)) {
              match = numStr.match(new RegExp(`^${prefijo}(\\d+)$`));
              if (match) {
                const num = parseInt(match[1], 10);
                if (num > maxNum) maxNum = num;
              }
              break; // salir del bucle una vez encontrado
            }
          }
        }
        // USD
        else if (moneda === "USD" && numStr.startsWith("SBDA")) {
          match = numStr.match(/^SBDA(\d+)$/);
          if (match) {
            const num = parseInt(match[1], 10);
            if (num > maxNum) maxNum = num;
          }
        }
        // EUR
        else if (moneda === "EUR" && numStr.startsWith("SBEEUR")) {
          match = numStr.match(/^SBEEUR(\d+)$/);
          if (match) {
            const num = parseInt(match[1], 10);
            if (num > maxNum) maxNum = num;
          }
        }
        cursor.continue();
      } else {
        const nextNum = (maxNum + 1).toString().padStart(4, '0');
        let prefijo;

        if (moneda === "RD$") {
          // Mapeo de tipo de cuenta ‚Üí prefijo
          const mapeo = {
            "corriente": "SBCR",
            "nomina": "SBNM",
            "infantil": "SBIN",
            "empresarial": "SBEM",
            "cheques": "SBCC",
            "ahorros": "SBRD"
          };
          prefijo = mapeo[tipoCuenta] || "SBRD"; // fallback a SBRD si no coincide
        } else if (moneda === "USD") {
          prefijo = "SBDA";
        } else if (moneda === "EUR") {
          prefijo = "SBEEUR";
        } else {
          prefijo = "SB";
        }

        resolve(prefijo + nextNum);
      }
    };
  });
}    


function calcularEfectivoDisponible() {
  // Mostrar directamente los balances actuales del cajero
  document.getElementById("efectivo-caja").textContent = `RD$ ${usuarioSesion.balanceRD.toFixed(2)}`;
  document.getElementById("efectivo-usd").textContent = `USD ${usuarioSesion.balanceUSD.toFixed(2)}`;
  document.getElementById("efectivo-eur").textContent = `EUR ${usuarioSesion.balanceEUR.toFixed(2)}`;

  // NO recalcular totales de dep√≥sitos/retiros/pagos aqu√≠
  // Los totales se mantendr√°n en 0 despu√©s del cierre de caja
  // y solo se incrementar√°n con las nuevas transacciones del d√≠a
}


      function cargarTodasTransacciones() {
        transacciones = [];
        const transaction = db.transaction(["transacciones"], "readonly");
        const store = transaction.objectStore("transacciones");
        const request = store.openCursor();
        request.onsuccess = function(e) {
          const cursor = e.target.result;
          if (cursor) {
            const t = cursor.value;
            if (t.moneda === "USD" || t.moneda === "EUR") {
              const match = t.referencia.match(/(\d+(?:\.\d+)?) (USD|EUR)/);
              if (match) t.cantidadDivisa = parseFloat(match[1]);
            }
            transacciones.push(t);
            cursor.continue();
          } else {
            filtrarTransacciones();
          }
        };
      }
      function filtrarTransacciones() {
        const filtro = document.getElementById("filtro-tipo").value;
        const tbody = document.querySelector("#historial-transacciones tbody");
        tbody.innerHTML = "";
        const filtradas = filtro === "todos" ? transacciones : transacciones.filter(t => t.tipo === filtro);
        filtradas.forEach(transaccion => {
          const tr = document.createElement("tr");
          let clase = "";
          let icono = "";
          if (transaccion.tipo === "Dep√≥sito") { clase = "transaccion-deposito"; icono = "üíµ"; }
          else if (transaccion.tipo === "Retiro") { clase = "transaccion-retiro"; icono = "üí∏"; }
          else if (transaccion.tipo === "Pago de Servicio") { clase = "transaccion-pago"; icono = "üßæ"; }
          else if (transaccion.tipo === "Cambio de Divisa") { clase = "transaccion-cambio"; icono = "üí±"; }
          else if (transaccion.tipo === "Cobro de Pr√©stamo") { clase = "transaccion-cobro"; icono = "üí∞"; }
          tr.className = clase;
          tr.innerHTML = `<td>${transaccion.fecha}</td><td>${icono} ${transaccion.tipo}</td><td>${transaccion.monto.toFixed(2)}</td><td>${transaccion.moneda}</td><td>${transaccion.cuenta}</td>`;
          tbody.appendChild(tr);
        });
      }
      function exportarCSV() {
        const filtro = document.getElementById("filtro-tipo").value;
        const nombreFiltro = filtro === "todos" ? "Todas" : filtro;
        const fecha = new Date().toLocaleDateString().replace(/\//g, "-");
        const filename = `historial_${nombreFiltro.toLowerCase().replace(" ", "_")}_${fecha}.csv`;
        let csv = "Fecha,Tipo,Monto,Moneda,Referencia\n";
        const filtradas = filtro === "todos" ? transacciones : transacciones.filter(t => t.tipo === filtro);
        filtradas.forEach(t => {
          csv += `"${t.fecha}","${t.tipo}","${t.monto.toFixed(2)}","${t.moneda}","${t.cuenta}"\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
      }
async function realizarCambio() {
  const tipo = document.getElementById("tipo-cambio").value;
  const moneda = document.getElementById("moneda-cambio").value;
  const montoDivisa = parseFloat(document.getElementById("monto-cambio").value);
  const resultado = document.getElementById("resultado-cambio");

  if (!moneda || isNaN(montoDivisa) || montoDivisa <= 0) {
    mostrarResultado("error", "‚ùå Por favor, complete todos los campos correctamente.", resultado);
    return;
  }

  const tasaCompra = moneda === "USD" ? usuarioSesion.tasaUsdCompra : usuarioSesion.tasaEurCompra;
  const tasaVenta = moneda === "USD" ? usuarioSesion.tasaUsdVenta : usuarioSesion.tasaEurVenta;

  let montoRD, referencia, operacion;
  if (tipo === "compra") {
    // Cliente compra divisa ‚Üí banco vende divisa ‚Üí caja pierde divisa, gana RD$
    montoRD = montoDivisa * tasaVenta;
    referencia = `Cambio: cliente compra ${montoDivisa.toFixed(2)} ${moneda}`;
    operacion = "cliente compra";

    const disponible = moneda === "USD" ? usuarioSesion.balanceUSD : usuarioSesion.balanceEUR;
    if (disponible < montoDivisa) {
      mostrarResultado("error", `‚ùå No hay suficiente ${moneda} en caja para vender.`, resultado);
      return;
    }
  } else {
    // Cliente vende divisa ‚Üí banco compra divisa ‚Üí caja gana divisa, pierde RD$
    montoRD = montoDivisa * tasaCompra;
    referencia = `Cambio: cliente vende ${montoDivisa.toFixed(2)} ${moneda}`;
    operacion = "cliente vende";

    if (usuarioSesion.balanceRD < montoRD) {
      mostrarResultado("error", `‚ùå No hay suficiente RD$ en caja para comprar ${moneda}.`, resultado);
      return;
    }
  }

  // ‚úÖ ACTUALIZAR BALANCES DEL CAJERO EN MEMORIA
  if (tipo === "compra") {
    // Banco vende divisa ‚Üí pierde divisa, gana RD$
    usuarioSesion.balanceRD += montoRD;
    if (moneda === "USD") usuarioSesion.balanceUSD -= montoDivisa;
    else if (moneda === "EUR") usuarioSesion.balanceEUR -= montoDivisa;
  } else {
    // Banco compra divisa ‚Üí gana divisa, pierde RD$
    usuarioSesion.balanceRD -= montoRD;
    if (moneda === "USD") usuarioSesion.balanceUSD += montoDivisa;
    else if (moneda === "EUR") usuarioSesion.balanceEUR += montoDivisa;
  }

  // ‚úÖ GUARDAR NUEVOS BALANCES EN LA BASE DE DATOS
  const userTrans = db.transaction(["usuarios"], "readwrite");
  const userStore = userTrans.objectStore("usuarios");
  const userIndex = userStore.index("usuario");
  const userReq = userIndex.get(usuarioSesion.usuario);
  userReq.onsuccess = function() {
    const user = userReq.result;
    if (user) {
      user.balanceRD = usuarioSesion.balanceRD;
      user.balanceUSD = usuarioSesion.balanceUSD;
      user.balanceEUR = usuarioSesion.balanceEUR;
      userStore.put(user);
    }
  };

  // Registrar transacci√≥n
  const transaccion = {
	cajero: usuarioSesion.usuario, // üëà AGREGAR ESTA L√çNEA
    cuenta: "CAJA",
    tipo: "Cambio de Divisa",
    monto: montoRD,
    moneda: "RD$",
    referencia,
    fecha: new Date().toLocaleString(),
    cantidadDivisa: montoDivisa,
    divisa: moneda,
    operacion: operacion
  };

  // Guardar transacci√≥n normalmente
guardarTransaccion(transaccion, resultado, "");

// Mostrar modal con los detalles
mostrarModalCambio(
  operacion === "cliente compra" ? "Cliente compr√≥" : "Cliente vendi√≥",
  moneda,
  montoDivisa.toFixed(2),
  montoRD.toFixed(2)
);

  document.getElementById("monto-cambio").value = "";
} 

function registrarDeposito() {
  const cuenta = document.getElementById("cuenta-deposito").value.trim();
  const monto = parseFloat(document.getElementById("monto-deposito").value);
  const moneda = document.getElementById("moneda-deposito").value;
  const resultado = document.getElementById("resultado-deposito");
  
  if (!cuenta || isNaN(monto) || monto <= 0) {
    mostrarResultado("error", "‚ùå Por favor, complete todos los campos correctamente.", resultado);
    return;
  }
  const transaction = db.transaction(["cuentas"], "readwrite");
  const store = transaction.objectStore("cuentas");
  const index = store.index("numeroCuenta");
  const request = index.get(cuenta);
  
  request.onsuccess = function() {
    const cuentaData = request.result;
    if (!cuentaData) {
      mostrarResultado("error", "‚ùå Cuenta no encontrada.", resultado);
      return;
    }

    // üîí VALIDACI√ìN: La moneda del dep√≥sito debe coincidir con la moneda de la cuenta
    if (cuentaData.moneda !== moneda) {
      mostrarResultado(
        "error",
        `‚ùå No puede depositar en ${moneda} en una cuenta en ${cuentaData.moneda}.`,
        resultado
      );
      return;
    }

    cuentaData.saldo += monto;
    store.put(cuentaData);

    // Actualizar balance del cajero
    if (moneda === "RD$") usuarioSesion.balanceRD += monto;
    else if (moneda === "USD") usuarioSesion.balanceUSD += monto;
    else if (moneda === "EUR") usuarioSesion.balanceEUR += monto;

    // Guardar balances actualizados
    const userTrans = db.transaction(["usuarios"], "readwrite");
    const userStore = userTrans.objectStore("usuarios");
    const userIndex = userStore.index("usuario");
    const userReq = userIndex.get(usuarioSesion.usuario);
    userReq.onsuccess = function() {
      const user = userReq.result;
      if (user) {
        user.balanceRD = usuarioSesion.balanceRD;
        user.balanceUSD = usuarioSesion.balanceUSD;
        user.balanceEUR = usuarioSesion.balanceEUR;
        userStore.put(user);
      }
    };

    const transaccion = {
	 cajero: usuarioSesion.usuario, // üëà AGREGAR ESTA L√çNEA
      cuenta,
      tipo: "Dep√≥sito",
      monto,
      moneda,
      referencia: `Dep√≥sito en cuenta ${cuenta}`,
      fecha: new Date().toLocaleString()
    };
    guardarTransaccion(transaccion, resultado, `‚úÖ Dep√≥sito de ${moneda} ${monto.toFixed(2)} realizado. Saldo actual: ${moneda} ${cuentaData.saldo.toFixed(2)}.`);
    
    // Limpiar campos
    document.getElementById("monto-deposito").value = "";
    document.getElementById("cuenta-deposito").value = "";
  };
  
  request.onerror = () => mostrarResultado("error", "‚ùå Error al buscar la cuenta.", resultado);
} 

function iniciarReposicionLibreta() {
  const numeroCuenta = document.getElementById("numero-libreta-reposicion").value.trim();
  if (!numeroCuenta) {
    mostrarResultado("error", "‚ùå Ingrese el n√∫mero de cuenta.", document.getElementById("resultado-reposicion"));
    return;
  }

  // Mostrar modal de confirmaci√≥n
  const modalHtml = `
    <div id="modal-reposicion" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 3000;">
      <div class="modal-content" style="background: white; padding: 25px; border-radius: 10px; width: 400px; max-width: 90%; text-align: center;">
        <h3>‚ö†Ô∏è Confirmar Reposici√≥n</h3>
        <p style="margin: 20px 0;">Esta operaci√≥n deduce <strong>$500 pesos</strong> de la cuenta.</p>
        <div style="display: flex; gap: 10px; justify-content: center;">
          <button onclick="confirmarReposicion('${numeroCuenta}')" style="background: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 5px;">Aceptar</button>
          <button onclick="cerrarModalReposicion()" style="background: #6c757d; color: white; padding: 8px 16px; border: none; border-radius: 5px;">Cancelar</button>
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function cerrarModalReposicion() {
  const modal = document.getElementById("modal-reposicion");
  if (modal) modal.remove();
}

async function confirmarReposicion(numeroCuenta) {
  cerrarModalReposicion();

  const resultadoDiv = document.getElementById("resultado-reposicion");
  const montoDeduccion = 500;
  const moneda = "RD$";

  // Verificar que la cuenta exista
  const trans = db.transaction(["cuentas"], "readwrite");
  const store = trans.objectStore("cuentas");
  const index = store.index("numeroCuenta");
  const req = index.get(numeroCuenta);

  req.onsuccess = function() {
    const cuenta = req.result;
    if (!cuenta) {
      mostrarResultado("error", "‚ùå Cuenta no encontrada.", resultadoDiv);
      return;
    }

    if (cuenta.saldo < montoDeduccion) {
      mostrarResultado("error", `‚ùå Saldo insuficiente. Se requieren ${moneda} ${montoDeduccion.toFixed(2)}. Saldo actual: ${cuenta.moneda} ${cuenta.saldo.toFixed(2)}.`, resultadoDiv);
      return;
    }

    // Realizar la deducci√≥n
    cuenta.saldo -= montoDeduccion;
    store.put(cuenta);

    // Registrar transacci√≥n
    const transaccion = {
      cajero: usuarioSesion.usuario,
      cuenta: numeroCuenta,
      tipo: "Reposici√≥n de Libreta",
      monto: montoDeduccion,
      moneda: moneda,
      referencia: "Reposici√≥n de libreta de ahorros",
      fecha: new Date().toLocaleString()
    };

    guardarTransaccion(transaccion, resultadoDiv, `‚úÖ Reposici√≥n realizada. Se dedujeron ${moneda} ${montoDeduccion.toFixed(2)}. Saldo actual: ${cuenta.moneda} ${cuenta.saldo.toFixed(2)}.`);
    
    // Limpiar campo
    document.getElementById("numero-libreta-reposicion").value = "";
  };

  req.onerror = function() {
    mostrarResultado("error", "‚ùå Error al acceder a la cuenta.", resultadoDiv);
  };
}

function registrarRetiro() {
  const cuenta = document.getElementById("cuenta-retiro").value.trim();
  const monto = parseFloat(document.getElementById("monto-retiro").value);
  const moneda = document.getElementById("moneda-retiro").value;
  const resultado = document.getElementById("resultado-retiro");
  if (!cuenta || isNaN(monto) || monto <= 0) {
    mostrarResultado("error", "‚ùå Por favor, complete todos los campos correctamente.", resultado);
    return;
  }
  const transaction = db.transaction(["cuentas"], "readwrite");
  const store = transaction.objectStore("cuentas");
  const index = store.index("numeroCuenta");
  const request = index.get(cuenta);
  request.onsuccess = function() {
    const cuentaData = request.result;
    if (!cuentaData) {
      mostrarResultado("error", "‚ùå Cuenta no encontrada.", resultado);
      return;
    }

    // üîí VALIDACI√ìN: La moneda del retiro debe coincidir con la moneda de la cuenta
    if (cuentaData.moneda !== moneda) {
      mostrarResultado(
        "error",
        `‚ùå No puede retirar en ${moneda} de una cuenta en ${cuentaData.moneda}.`,
        resultado
      );
      return;
    }

    if (cuentaData.saldo < monto) {
      mostrarResultado("error", `‚ùå Saldo insuficiente. Saldo actual: ${moneda} ${cuentaData.saldo.toFixed(2)}.`, resultado);
      return;
    }

    // ‚úÖ Verificar efectivo en caja
    let balanceCajero = 0;
    if (moneda === "RD$") balanceCajero = usuarioSesion.balanceRD;
    else if (moneda === "USD") balanceCajero = usuarioSesion.balanceUSD;
    else if (moneda === "EUR") balanceCajero = usuarioSesion.balanceEUR;
    if (balanceCajero < monto) {
      mostrarResultado("error", `‚ùå No hay suficiente efectivo en caja en ${moneda}. Disponible: ${moneda} ${balanceCajero.toFixed(2)}.`, resultado);
      return;
    }

    cuentaData.saldo -= monto;
    store.put(cuentaData);

    // ‚úÖ Actualizar balance del cajero
    if (moneda === "RD$") usuarioSesion.balanceRD -= monto;
    else if (moneda === "USD") usuarioSesion.balanceUSD -= monto;
    else if (moneda === "EUR") usuarioSesion.balanceEUR -= monto;

    // ‚úÖ Guardar en base de datos
    const userTrans = db.transaction(["usuarios"], "readwrite");
    const userStore = userTrans.objectStore("usuarios");
    const userIndex = userStore.index("usuario");
    const userReq = userIndex.get(usuarioSesion.usuario);
    userReq.onsuccess = function() {
      const user = userReq.result;
      if (user) {
        user.balanceRD = usuarioSesion.balanceRD;
        user.balanceUSD = usuarioSesion.balanceUSD;
        user.balanceEUR = usuarioSesion.balanceEUR;
        userStore.put(user);
      }
    };

    const transaccion = {
	cajero: usuarioSesion.usuario, // üëà AGREGAR ESTA L√çNEA
      cuenta,
      tipo: "Retiro",
      monto,
      moneda,
      referencia: `Retiro en cuenta ${cuenta}`,
      fecha: new Date().toLocaleString()
    };
    guardarTransaccion(transaccion, resultado, `‚úÖ Retiro de ${moneda} ${monto.toFixed(2)} realizado. Saldo actual: ${moneda} ${cuentaData.saldo.toFixed(2)}.`);
    document.getElementById("monto-retiro").value = "";
    document.getElementById("cuenta-retiro").value = "";
  };
  request.onerror = () => mostrarResultado("error", "‚ùå Error al buscar la cuenta.", resultado);
}

async function registrarPagoServicio() {
  const tipo = document.getElementById("tipo-servicio").value;
  const proveedor = document.getElementById("proveedor").value;
  const referencia = document.getElementById("numero-cuenta-servicio").value.trim();
  const monto = parseFloat(document.getElementById("monto-pago").value);
  const metodo = document.getElementById("metodo-pago-servicio").value;
  const cuentaOrigen = document.getElementById("cuenta-pago")?.value?.trim();
  const tarjetaOrigen = document.getElementById("tarjeta-pago")?.value?.trim()?.replace(/\s/g, '');
  const resultado = document.getElementById("resultado-pago");

  if (!tipo || !proveedor || !referencia || isNaN(monto) || monto <= 0) {
    mostrarResultado("error", "‚ùå Complete todos los campos correctamente.", resultado);
    return;
  }

  if (metodo === "cuenta" && !cuentaOrigen) {
    mostrarResultado("error", "‚ùå Ingrese el n√∫mero de cuenta Simubank.", resultado);
    return;
  }
  if (metodo === "tarjeta" && (!tarjetaOrigen || tarjetaOrigen.length !== 16)) {
    mostrarResultado("error", "‚ùå Ingrese un n√∫mero de tarjeta v√°lido (16 d√≠gitos).", resultado);
    return;
  }

  let transaccionExitosa = false;

  if (metodo === "efectivo") {
    // ‚úÖ Solo se suma al balance del cajero
    if (usuarioSesion.balanceRD < monto) {
      mostrarResultado("error", `‚ùå No hay suficiente efectivo en caja. Disponible: RD$ ${usuarioSesion.balanceRD.toFixed(2)}`, resultado);
      return;
    }
    usuarioSesion.balanceRD -= monto; // el cajero entrega efectivo al proveedor
    transaccionExitosa = true;

  } else if (metodo === "cuenta") {
    // ‚úÖ D√©bito desde cuenta Simubank
    const trans = db.transaction(["cuentas"], "readwrite");
    const store = trans.objectStore("cuentas");
    const req = store.index("numeroCuenta").get(cuentaOrigen);
    const cuenta = await new Promise((res) => {
      req.onsuccess = () => res(req.result);
      req.onerror = () => res(null);
    });
    if (!cuenta) {
      mostrarResultado("error", "‚ùå Cuenta Simubank no encontrada.", resultado);
      return;
    }
    if (cuenta.moneda !== "RD$") {
      mostrarResultado("error", "‚ùå Solo se aceptan cuentas en RD$ para pagos de servicios.", resultado);
      return;
    }
    if (cuenta.saldo < monto) {
      mostrarResultado("error", `‚ùå Saldo insuficiente. Saldo actual: RD$ ${cuenta.saldo.toFixed(2)}`, resultado);
      return;
    }
    cuenta.saldo -= monto;
    store.put(cuenta);
    transaccionExitosa = true;

  } else if (metodo === "tarjeta") {
    // ‚úÖ D√©bito desde tarjeta de cr√©dito
    const trans = db.transaction(["tarjetas"], "readwrite");
    const store = trans.objectStore("tarjetas");
    let tarjeta = null;
    const req = store.openCursor();
    await new Promise((res) => {
      req.onsuccess = function(e) {
        const cursor = e.target.result;
        if (cursor) {
          const t = cursor.value;
          if (t.numero === tarjetaOrigen && t.estado === "Aprobada") {
            tarjeta = t;
          }
          cursor.continue();
        } else {
          res();
        }
      };
    });
    if (!tarjeta) {
      mostrarResultado("error", "‚ùå Tarjeta no encontrada o no aprobada.", resultado);
      return;
    }
    const saldoActual = parseFloat(tarjeta.saldo) || 0;
    const limite = parseFloat(tarjeta.limite);
    if (saldoActual + monto > limite) {
      const disponible = limite - saldoActual;
      mostrarResultado("error", `‚ùå L√≠mite excedido. Disponible: RD$ ${disponible.toFixed(2)}`, resultado);
      return;
    }
    tarjeta.saldo = saldoActual + monto;
    store.put(tarjeta);
    transaccionExitosa = true;
  }

  if (transaccionExitosa) {
    // Actualizar balance del cajero (solo si es en efectivo)
    if (metodo === "efectivo") {
      const userTrans = db.transaction(["usuarios"], "readwrite");
      const userStore = userTrans.objectStore("usuarios");
      const userReq = userStore.index("usuario").get(usuarioSesion.usuario);
      const user = await new Promise((res) => {
        userReq.onsuccess = () => res(userReq.result);
        userReq.onerror = () => res(null);
      });
      if (user) {
        user.balanceRD = usuarioSesion.balanceRD;
        userStore.put(user);
      }
    }

    // Registrar transacci√≥n
    const transaccion = {
      cajero: usuarioSesion.usuario,
      cuenta: referencia,
      tipo: "Pago de Servicio",
      monto: monto,
      moneda: "RD$",
      referencia: `Pago a ${proveedor} v√≠a ${metodo === "efectivo" ? "efectivo" : metodo === "cuenta" ? "cuenta" : "tarjeta"}`,
      fecha: new Date().toLocaleString()
    };
    guardarTransaccion(transaccion, resultado, `‚úÖ Pago de RD$ ${monto.toFixed(2)} registrado.`);
    
    // Limpiar formulario
    document.getElementById("monto-pago").value = "";
    document.getElementById("numero-cuenta-servicio").value = "";
    document.getElementById("metodo-pago-servicio").value = "efectivo";
    toggleCamposMetodoPago();
  }
}

      function actualizarProveedores() {
        const tipo = document.getElementById("tipo-servicio").value;
        const select = document.getElementById("proveedor");
        select.innerHTML = '<option value="">Seleccionar proveedor</option>';
        if (tipo && proveedores[tipo]) {
          proveedores[tipo].forEach(p => {
            const opt = document.createElement("option");
            opt.value = p;
            opt.textContent = p;
            select.appendChild(opt);
          });
          select.disabled = false;
        } else {
          select.disabled = true;
        }
      }
document.getElementById("form-apertura").addEventListener("submit", async function(e) {
  e.preventDefault();
  const nombre = document.getElementById("nombre-cliente").value.trim();
  const cedula = document.getElementById("cedula").value.trim();
  const moneda = document.getElementById("moneda").value;
  const tipoCuenta = document.getElementById("tipo-cuenta").value;
  if (!nombre || !cedula || !moneda || !tipoCuenta) {
    mostrarResultado("error", "‚ùå Por favor, complete los campos obligatorios.", document.getElementById("resultado-apertura"));
    return;
  }
  const cuentaGenerada = await generarNumeroCuenta(moneda, tipoCuenta);
  document.getElementById("numero-cuenta").value = cuentaGenerada;
  const cliente = {
    nombre,
    cedula,
    fechaNac: document.getElementById("fecha-nac").value,
    sexo: document.getElementById("sexo").value,
    estadoCivil: document.getElementById("estado-civil").value,
    direccion: document.getElementById("direccion").value,
    telefono: document.getElementById("telefono").value,
    email: document.getElementById("email").value,
    empresa: document.getElementById("empresa").value,
    cargo: document.getElementById("cargo").value,
    ingresos: document.getElementById("ingresos").value,
    rnc: document.getElementById("rnc").value,
    tipoCuenta: document.getElementById("tipo-cuenta").value,
    moneda: moneda,
    numeroCuenta: cuentaGenerada,
    sucursal: document.getElementById("sucursal-cuenta").value,
    oficial: document.getElementById("oficial-cuenta").value,
    fechaApertura: new Date().toLocaleString(),
    saldo: 0
  };
  const transaction = db.transaction(["cuentas"], "readwrite");
  const store = transaction.objectStore("cuentas");
  const request = store.add(cliente);
  request.onsuccess = function() {
    // ‚úÖ Mostrar modal en lugar de solo un mensaje
    mostrarModalCuenta(cuentaGenerada);
    document.getElementById("form-apertura").reset();
    document.getElementById("sucursal-cuenta").value = usuarioSesion.sucursal;
    document.getElementById("oficial-cuenta").value = usuarioSesion.nombre;
    // Opcional: limpiar el mensaje de resultado
    document.getElementById("resultado-apertura").classList.add("hidden");
  };
  request.onerror = function() {
    mostrarResultado("error", "‚ùå Error al guardar la cuenta. Intente nuevamente.", document.getElementById("resultado-apertura"));
  };
});

document.getElementById("form-prestamo").addEventListener("submit", async function(e) {
  e.preventDefault();
  const nombre = document.getElementById("nombre-solicitante").value;
  const cedula = document.getElementById("cedula-prestamo").value;
  const monto = parseFloat(document.getElementById("monto-solicitado").value);
  const plazo = parseInt(document.getElementById("plazo").value);
  const tasa = parseFloat(document.getElementById("tasa").value);
  const tipo = document.getElementById("tipo-prestamo").value;
  const formaPago = document.getElementById("forma-pago").value;
  const cuentaDestinoInput = document.getElementById("numero-cuenta-prestamo");
  const moneda = "RD$";
  if (!cuentaDestinoInput.value) {
    try {
      const cuentaGenerada = await generarNumeroCuenta(moneda);
      cuentaDestinoInput.value = cuentaGenerada;
    } catch (err) {
      return alert("Error al generar n√∫mero de cuenta.");
    }
  }
  const cuentaDestino = cuentaDestinoInput.value.trim();
  if (isNaN(tasa) || tasa <= 0) return alert("La tasa debe ser un valor positivo.");
  const transaction = db.transaction(["prestamos"], "readonly");
  const store = transaction.objectStore("prestamos");
  const request = store.count();
  request.onsuccess = function() {
    const count = request.result;
    const codigo = `SBPT${String(count + 1).padStart(4, '0')}`;
    const prestamo = {
      nombre, cedula, monto, plazo, tasa, tipo, formaPago,
      fecha: new Date().toISOString().split('T')[0],
      estado: "Pendiente", saldoPendiente: monto, codigo, cuentaDestino,
      cuotas: []
    };
    const addTrans = db.transaction(["prestamos"], "readwrite");
    const addStore = addTrans.objectStore("prestamos");
    addStore.add(prestamo);
    addTrans.oncomplete = () => {
      mostrarModalPrestamo(codigo);
      // ‚úÖ LIMPIAR EL FORMULARIO TRAS √âXITO
      document.getElementById("form-prestamo").reset();
      // Opcional: restablecer valores por defecto si es necesario
      document.getElementById("numero-cuenta-prestamo").value = "";
    };
  };
});

      function generarCuotas(monto, plazo, tasaAnual, formaPago, fechaInicio) {
        const tasaMensual = tasaAnual / 100 / 12;
        const numCuotas = plazo;
        const cuota = monto * (tasaMensual / (1 - Math.pow(1 + tasaMensual, -numCuotas)));
        const cuotas = [];
        let fecha = new Date(fechaInicio);
        for (let i = 1; i <= numCuotas; i++) {
          fecha.setMonth(fecha.getMonth() + 1);
          cuotas.push({
            numero: i,
            monto: parseFloat(cuota.toFixed(2)),
            fechaVencimiento: fecha.toISOString().split('T')[0],
            pagada: false,
            fechaPago: null
          });
        }
        return cuotas;
      }
      function aprobarPrestamo() {
  const prestamo = window.prestamoPendiente;
  if (!prestamo) return;

  // üîí RESTRICCI√ìN 1: El pr√©stamo no puede superar el 50% del efectivo en caja (RD$)
  const maximoPermitido = usuarioSesion.balanceRD * 0.5;
  if (prestamo.monto > maximoPermitido) {
    mostrarResultado(
      "error",
      `‚ùå El monto del pr√©stamo (RD$ ${prestamo.monto.toFixed(2)}) excede el 50% del efectivo disponible en caja (m√°ximo permitido: RD$ ${maximoPermitido.toFixed(2)}).`,
      document.getElementById("resultado-aprobacion")
    );
    return;
  }

  const cuentaDestino = prestamo.cuentaDestino;
  const cuentaTrans = db.transaction(["cuentas"], "readwrite");
  const cuentaStore = cuentaTrans.objectStore("cuentas");
  const cuentaIndex = cuentaStore.index("numeroCuenta");
  const getRequest = cuentaIndex.get(cuentaDestino);

  getRequest.onsuccess = function() {
    const cuenta = getRequest.result;
    if (!cuenta) {
      return mostrarResultado(
        "error",
        `‚ùå No se encontr√≥ la cuenta ${cuentaDestino}.`,
        document.getElementById("resultado-aprobacion")
      );
    }

    // ‚úÖ Aumentar el saldo de la cuenta del cliente (el dinero est√° "a favor", listo para retirar)
    cuenta.saldo += prestamo.monto;
    cuentaStore.put(cuenta);

    // Actualizar estado del pr√©stamo
    const prestamoTrans = db.transaction(["prestamos"], "readwrite");
    const prestamoStore = prestamoTrans.objectStore("prestamos");
    const prestamoRequest = prestamoStore.get(prestamo.id);
    prestamoRequest.onsuccess = function() {
      const prestamoActualizado = prestamoRequest.result;
      prestamoActualizado.estado = "Aprobado";
      prestamoActualizado.fechaAprobacion = new Date().toISOString();
      prestamoActualizado.cuotas = generarCuotas(
        prestamo.monto,
        prestamo.plazo,
        prestamo.tasa,
        prestamo.formaPago,
        new Date()
      );
      prestamoStore.put(prestamoActualizado);
    };

    // Registrar transacci√≥n: dep√≥sito por desembolso (pero NO se toca el balance del cajero)
    const transaccion = {
	cajero: usuarioSesion.usuario, // üëà AGREGAR ESTA L√çNEA
      cuenta: cuentaDestino,
      tipo: "Dep√≥sito",
      monto: prestamo.monto,
      moneda: "RD$",
      referencia: `Desembolso de pr√©stamo ${prestamo.codigo} (disponible para retiro)`,
      fecha: new Date().toLocaleString()
    };
    guardarTransaccion(
      transaccion,
      document.getElementById("resultado-aprobacion"),
      `‚úÖ Pr√©stamo ${prestamo.codigo} aprobado. RD$ ${prestamo.monto.toFixed(2)} est√°n disponibles en la cuenta ${cuentaDestino} para retiro.`
    );

    buscarSolicitud();
  };

  getRequest.onerror = function() {
    mostrarResultado(
      "error",
      "‚ùå Error al acceder a la cuenta destino.",
      document.getElementById("resultado-aprobacion")
    );
  };
}
            
      function rechazarPrestamo() {
        const prestamo = window.prestamoPendiente;
        if (!prestamo) return;
        const updateTrans = db.transaction(["prestamos"], "readwrite");
        const store = updateTrans.objectStore("prestamos");
        const getRequest = store.get(prestamo.id);
        getRequest.onsuccess = function() {
          const prestamoActualizado = getRequest.result;
          prestamoActualizado.estado = "Rechazado";
          prestamoActualizado.fechaRechazo = new Date().toISOString();
          store.put(prestamoActualizado);
          updateTrans.oncomplete = function() {
            mostrarResultado("warning", `‚ùå Pr√©stamo ${prestamo.codigo} rechazado.`, document.getElementById("resultado-aprobacion"));
            document.getElementById("resultado-aprobacion").classList.remove("hidden");
            buscarSolicitud();
          };
        };
      }
      function buscarSolicitud() {
        const query = document.getElementById("buscar-solicitud").value.trim().toUpperCase();
        if (!query) return alert("Ingrese un c√≥digo (SBPT...) o c√©dula.");
        const transaction = db.transaction(["prestamos"], "readonly");
        const store = transaction.objectStore("prestamos");
        const resultadoDiv = document.getElementById("resultado-solicitud");
        const acciones = document.getElementById("acciones-prestamo");
        const resultado = document.getElementById("resultado-aprobacion");
        resultadoDiv.innerHTML = "";
        acciones.classList.add("hidden");
        resultado.classList.add("hidden");
        // B√∫squeda por c√≥digo
        if (query.startsWith("SBPT")) {
          const index = store.index("codigo");
          index.get(query).onsuccess = function(e) {
            const prestamo = e.target.result;
            if (prestamo && prestamo.estado === "Pendiente") {
              mostrarResultadoSolicitud(prestamo);
            } else {
              resultadoDiv.innerHTML = "<div class='alert'>No se encontr√≥ solicitud pendiente con ese c√≥digo.</div>";
            }
          };
        } else {
          // B√∫squeda por c√©dula
          const index = store.index("cedula");
          const request = index.openCursor(IDBKeyRange.only(query));
          request.onsuccess = function(e) {
            const cursor = e.target.result;
            if (cursor) {
              const prestamo = cursor.value;
              if (prestamo.estado === "Pendiente") {
                mostrarResultadoSolicitud(prestamo);
                return;
              }
              cursor.continue();
            } else {
              resultadoDiv.innerHTML = "<div class='alert'>No se encontr√≥ solicitud pendiente con esa c√©dula.</div>";
            }
          };
        }
      }
      function mostrarResultadoSolicitud(prestamo) {
        const div = document.getElementById("resultado-solicitud");
        const acciones = document.getElementById("acciones-prestamo");
        const resultado = document.getElementById("resultado-aprobacion");
        if (prestamo) {
          div.innerHTML = `
            <div class="card">
              <strong>Solicitud de Pr√©stamo #${prestamo.id}</strong><br>
              <strong>C√≥digo: ${prestamo.codigo}</strong><br>
              Cliente: ${prestamo.nombre}<br>
              C√©dula: ${prestamo.cedula}<br>
              Cuenta destino: ${prestamo.cuentaDestino}<br>
              Tipo: ${prestamo.tipo} | Monto: RD$ ${prestamo.monto.toFixed(2)}<br>
              Plazo: ${prestamo.plazo} meses | Tasa: ${prestamo.tasa}% | Forma: ${prestamo.formaPago}<br>
              <strong>Estado: ${prestamo.estado}</strong>
            </div>`;
          acciones.classList.remove("hidden");
          resultado.classList.add("hidden");
          window.prestamoPendiente = prestamo;
        } else {
          div.innerHTML = "<div class='alert'>No se encontr√≥ solicitud pendiente.</div>";
          acciones.classList.add("hidden");
          window.prestamoPendiente = null;
        }
      }
      function buscarPrestamo() {
        const query = document.getElementById("buscar-prestamo").value.trim().toUpperCase();
        if (!query) return alert("Ingrese un c√≥digo o c√©dula.");
        const transaction = db.transaction(["prestamos"], "readonly");
        const store = transaction.objectStore("prestamos");
        const index = query.startsWith("SBPT") ? store.index("codigo") : store.index("cedula");
        index.get(query).onsuccess = function(e) {
          const prestamo = e.target.result;
          const resultadoDiv = document.getElementById("resultado-prestamo");
          const listaCuotas = document.getElementById("lista-cuotas");
          const cuotasContainer = document.getElementById("cuotas-container");
          const resultadoCobro = document.getElementById("resultado-cobro");
          if (prestamo && prestamo.estado === "Aprobado") {
            resultadoDiv.innerHTML = `
              <div class="card">
                <strong>Pr√©stamo: ${prestamo.codigo}</strong><br>
                Cliente: ${prestamo.nombre}<br>
                Monto: RD$ ${prestamo.monto.toFixed(2)}<br>
                <strong>Saldo Pendiente: RD$ ${prestamo.saldoPendiente.toFixed(2)}</strong><br>
                Estado: ${prestamo.estado}
              </div>`;
            listaCuotas.classList.remove("hidden");
            cuotasContainer.innerHTML = "";
            prestamo.cuotas.forEach((cuota, i) => {
              const div = document.createElement("div");
              div.className = `cuota-item ${cuota.pagada ? 'cuota-pagada' : ''}`;
              div.innerHTML = `
                <strong>Cuota ${cuota.numero}</strong> - Vence: ${cuota.fechaVencimiento}
                <br>Monto: RD$ ${cuota.monto.toFixed(2)}
                ${cuota.pagada ? ` (Pagada el ${cuota.fechaPago})` : ''}
                <button onclick="pagarCuota(${prestamo.id}, ${i})" ${cuota.pagada ? 'disabled style="background:gray"' : ''}>Pagar</button>
              `;
              cuotasContainer.appendChild(div);
            });
            resultadoCobro.classList.add("hidden");
            window.prestamoCobro = prestamo;
          } else {
            resultadoDiv.innerHTML = "<div class='alert'>No se encontr√≥ un pr√©stamo aprobado.</div>";
            listaCuotas.classList.add("hidden");
            window.prestamoCobro = null;
          }
        };
      }
      function pagarCuota(prestamoId, indiceCuota) {
        const transaction = db.transaction(["prestamos"], "readwrite");
        const store = transaction.objectStore("prestamos");
        const request = store.get(prestamoId);
        const resultadoDiv = document.getElementById("resultado-cobro");
        request.onsuccess = function() {
          const prestamo = request.result;
          const cuota = prestamo.cuotas[indiceCuota];
          if (!cuota || cuota.pagada) {
            return mostrarResultado("error", "Cuota ya pagada o inv√°lida.", resultadoDiv);
          }
          cuota.pagada = true;
          cuota.fechaPago = new Date().toISOString().split('T')[0];
          prestamo.saldoPendiente -= cuota.monto;
          if (prestamo.saldoPendiente <= 0) {
            prestamo.estado = "Pagado";
            prestamo.saldoPendiente = 0;
          }
          store.put(prestamo);
          const transaccion = {
		cajero: usuarioSesion.usuario, // üëà AGREGAR ESTA L√çNEA
            cuenta: prestamo.cuentaDestino,
            tipo: "Cobro de Pr√©stamo",
            monto: cuota.monto,
            moneda: "RD$",
            referencia: `Pago de cuota ${cuota.numero} del pr√©stamo ${prestamo.codigo}`,
            fecha: new Date().toLocaleString()
          };
          guardarTransaccion(transaccion, resultadoDiv,
            `‚úÖ Cuota ${cuota.numero} pagada. RD$ ${cuota.monto.toFixed(2)} aplicado. Saldo pendiente: RD$ ${prestamo.saldoPendiente.toFixed(2)}.`
          );
          // --- NUEVO C√ìDIGO ---
          // Actualizar el balance de efectivo del cajero
          usuarioSesion.balanceRD += cuota.monto;
          // Guardar el nuevo balance en la base de datos
          const updateBalanceTrans = db.transaction(["usuarios"], "readwrite");
          const userStore = updateBalanceTrans.objectStore("usuarios");
          const userIndex = userStore.index("usuario");
          const getUserRequest = userIndex.get(usuarioSesion.usuario);
          getUserRequest.onsuccess = function() {
            const user = getUserRequest.result;
            user.balanceRD = usuarioSesion.balanceRD;
            userStore.put(user);
          };
          // Recalcular el efectivo disponible en pantalla
          calcularEfectivoDisponible();
          // --- FIN DEL NUEVO C√ìDIGO ---
          setTimeout(() => buscarPrestamo(), 1000);
        };
      }
      function generarNumeroTarjeta() {
        let numero = "";
        for (let i = 0; i < 4; i++) {
          numero += Math.floor(1000 + Math.random() * 9000);
          if (i < 3) numero += " ";
        }
        return numero;
      }

document.getElementById("form-tarjeta").addEventListener("submit", function(e) {
  e.preventDefault();
  const cuenta = document.getElementById("cuenta-tarjeta").value.trim();
  const tipo = document.getElementById("tipo-tarjeta").value;
  const marca = document.getElementById("marca-tarjeta").value;
  const limite = document.getElementById("limite-tarjeta").value;
  const resultado = document.getElementById("resultado-tarjeta");
  const visualizacion = document.getElementById("visualizacion-tarjeta");
  if (!cuenta || !tipo || !limite) {
    mostrarResultado("error", "‚ùå Complete todos los campos.", resultado);
    return;
  }

  // üîç Verificar si ya existe una tarjeta (aprobada o pendiente) para esta cuenta
  const tarjetaTrans = db.transaction(["tarjetas"], "readonly");
  const tarjetaStore = tarjetaTrans.objectStore("tarjetas");
  const cuentaIndex = tarjetaStore.index("cuenta");
  const cuentaRequest = cuentaIndex.get(cuenta);

  cuentaRequest.onsuccess = function() {
    const tarjetaExistente = cuentaRequest.result;
    if (tarjetaExistente && (tarjetaExistente.estado === "Aprobada" || tarjetaExistente.estado === "Pendiente")) {
      mostrarResultado("error", `‚ùå Ya existe una tarjeta ${tarjetaExistente.estado.toLowerCase()} asociada a la cuenta ${cuenta}. Solo se permite una tarjeta por cliente.`, resultado);
      return;
    }

    // ‚úÖ Continuar con la creaci√≥n si no hay tarjeta existente
    const transaction = db.transaction(["cuentas"], "readonly");
    const store = transaction.objectStore("cuentas");
    const index = store.index("numeroCuenta");
    const request = index.get(cuenta);
    request.onsuccess = function() {
      const cuentaData = request.result;
      if (!cuentaData) {
        mostrarResultado("error", "‚ùå Cuenta no encontrada. Imposible generar tarjeta.", resultado);
        return;
      }
      const nombreTitular = cuentaData.nombre;
      const numTarjeta = generarNumeroTarjeta();
      const hoy = new Date();
      const vencimiento = `${(hoy.getMonth() + 1).toString().padStart(2, '0')}/${(hoy.getFullYear() + 4).toString().slice(-2)}`;

      document.getElementById("num-tarjeta").textContent = numTarjeta;
      document.getElementById("nombre-titular-tarjeta").textContent = nombreTitular;
      document.getElementById("vencimiento-tarjeta").textContent = vencimiento;

      const tarjetaPreview = document.getElementById("tarjeta-preview");
      tarjetaPreview.classList.remove("clasica", "oro", "platino");
      document.querySelector(".logo-tarjeta").textContent = marca;
      if (tipo === "Cl√°sica") {
        tarjetaPreview.classList.add("clasica");
      } else if (tipo === "Oro") {
        tarjetaPreview.classList.add("oro");
      } else if (tipo === "Platino") {
        tarjetaPreview.classList.add("platino");
      }
      visualizacion.classList.remove("hidden");
      generarQRParaTarjeta(numTarjeta, nombreTitular, tipo, vencimiento, marca, limite);
      mostrarResultado("success", `‚úÖ Solicitud de tarjeta ${tipo} generada exitosamente para ${nombreTitular}. Pendiente de aprobaci√≥n.`, resultado);

      // Guardar en base de datos
      const tarjeta = {
        cuenta,
        tipo,
        marca,
        limite: parseFloat(limite),
        numero: numTarjeta.replace(/\s/g, ''),
        vencimiento,
        nombreTitular,
        fechaEmision: new Date().toISOString(),
        estado: "Pendiente"
      };
      const addTrans = db.transaction(["tarjetas"], "readwrite");
      const addStore = addTrans.objectStore("tarjetas");
      addStore.add(tarjeta);
    };
    request.onerror = function() {
      mostrarResultado("error", "‚ùå Error al buscar la cuenta en la base de datos.", resultado);
    };
  };

  cuentaRequest.onerror = function() {
    mostrarResultado("error", "‚ùå Error al verificar tarjetas existentes.", resultado);
  };
});

      // Funci√≥n para buscar una tarjeta pendiente de aprobaci√≥n
      function buscarTarjetaPendiente() {
        const query = document.getElementById("buscar-tarjeta-aprobar").value.trim();
        if (!query) {
          alert("Por favor, ingrese un n√∫mero de cuenta o n√∫mero de tarjeta.");
          return;
        }
        const transaction = db.transaction(["tarjetas"], "readonly");
        const store = transaction.objectStore("tarjetas");
        const indexCuenta = store.index("cuenta");
        let request;
        // Si el query parece un n√∫mero de tarjeta (16 d√≠gitos), buscar por el √≠ndice "numero"
        if (/^\d{16}$/.test(query.replace(/\s/g, ''))) {
          const indexNumero = store.index("numero");
          request = indexNumero.get(query.replace(/\s/g, ''));
        } else {
          // De lo contrario, buscar por n√∫mero de cuenta
          request = indexCuenta.get(query);
        }
        request.onsuccess = function() {
          const tarjeta = request.result;
          const resultadoDiv = document.getElementById("resultado-tarjeta-pendiente");
          const accionesDiv = document.getElementById("acciones-tarjeta-aprobar");
          if (tarjeta && tarjeta.estado === "Pendiente") {
            resultadoDiv.innerHTML = `
              <div class="card">
                <strong>Solicitud de Tarjeta</strong><br>
                <strong>N√∫mero de Tarjeta:</strong> ${tarjeta.numero.match(/.{1,4}/g).join(' ')}<br>
                <strong>Titular:</strong> ${tarjeta.nombreTitular}<br>
                <strong>N√∫mero de Cuenta:</strong> ${tarjeta.cuenta}<br>
                <strong>Tipo:</strong> ${tarjeta.tipo}<br>
                <strong>L√≠mite:</strong> RD$ ${parseFloat(tarjeta.limite).toFixed(2)}<br>
                <strong>Estado:</strong> ${tarjeta.estado}
              </div>`;
            accionesDiv.classList.remove("hidden");
            document.getElementById("resultado-aprobacion-tarjeta").classList.add("hidden");
            window.tarjetaPendiente = tarjeta; // <-- Variable global para almacenar la tarjeta seleccionada
          } else {
            resultadoDiv.innerHTML = "<div class='alert'>No se encontr√≥ una solicitud de tarjeta pendiente con esos datos.</div>";
            accionesDiv.classList.add("hidden");
            window.tarjetaPendiente = null;
          }
        };
        request.onerror = function() {
          document.getElementById("resultado-tarjeta-pendiente").innerHTML = "<div class='alert'>Error al buscar la solicitud de tarjeta.</div>";
        };
      }

function generarQRParaTarjeta(numero, titular, tipo, vencimiento, marca, limite) {
  const datosTarjeta = {
    numero: numero,
    titular: titular,
    tipo: tipo,
    vencimiento: vencimiento,
    marca: marca,
    limite: limite
  };
  // üëá Usar una URL que abra SOLO la tarjeta (sin el sistema bancario)
  const url = `${window.location.origin}${window.location.pathname}?tarjeta=${encodeURIComponent(btoa(JSON.stringify(datosTarjeta)))}`;
  
  const qrContainer = document.getElementById("qr-tarjeta-container");
  if (qrContainer) qrContainer.remove();

  const nuevoQr = document.createElement("div");
  nuevoQr.id = "qr-tarjeta-container";
  nuevoQr.innerHTML = `
    <h4 style="margin-top:20px;">üì± Escanea para ver tu tarjeta</h4>
    <div id="qrcode-tarjeta" style="text-align:center; margin:10px auto;"></div>
    <p style="font-size:0.85em; color:#666;">Abre en tu celular para ver la versi√≥n digital.</p>
  `;
  document.querySelector("#visualizacion-tarjeta").appendChild(nuevoQr);

  new QRCode(document.getElementById("qrcode-tarjeta"), {
    text: url,
    width: 160,
    height: 160
  });
}

      // Funci√≥n para aprobar una tarjeta
      function aprobarTarjeta() {
        if (!window.tarjetaPendiente) {
          mostrarResultado("error", "‚ùå No hay una tarjeta seleccionada para aprobar.", document.getElementById("resultado-aprobacion-tarjeta"));
          return;
        }
        const transaction = db.transaction(["tarjetas"], "readwrite");
        const store = transaction.objectStore("tarjetas");
        const request = store.get(window.tarjetaPendiente.id);
        request.onsuccess = function() {
          const tarjeta = request.result;
          tarjeta.estado = "Aprobada";
          tarjeta.fechaAprobacion = new Date().toISOString();
          tarjeta.saldo = 0;
          store.put(tarjeta);
          transaction.oncomplete = function() {
            mostrarResultado("success", `‚úÖ Tarjeta ${tarjeta.numero.match(/.{1,4}/g).join(' ')} aprobada exitosamente.`, document.getElementById("resultado-aprobacion-tarjeta"));
            buscarTarjetaPendiente();
          };
        };
      }
      // Funci√≥n para rechazar una tarjeta
      function rechazarTarjeta() {
        if (!window.tarjetaPendiente) {
          mostrarResultado("error", "‚ùå No hay una tarjeta seleccionada para rechazar.", document.getElementById("resultado-aprobacion-tarjeta"));
          return;
        }
        const transaction = db.transaction(["tarjetas"], "readwrite");
        const store = transaction.objectStore("tarjetas");
        const request = store.get(window.tarjetaPendiente.id);
        request.onsuccess = function() {
          const tarjeta = request.result;
          tarjeta.estado = "Rechazada";
          tarjeta.fechaRechazo = new Date().toISOString();
          store.put(tarjeta);
          transaction.oncomplete = function() {
            mostrarResultado("warning", `‚ùå Tarjeta ${tarjeta.numero.match(/.{1,4}/g).join(' ')} rechazada.`, document.getElementById("resultado-aprobacion-tarjeta"));
            buscarTarjetaPendiente();
          };
        };
      }


function realizarDebitoTarjeta() {
    let numeroTarjeta = document.getElementById("numero-tarjeta-debitar").value.trim();
    numeroTarjeta = numeroTarjeta.replace(/\s/g, '');
    const monto = parseFloat(document.getElementById("monto-debitar").value);
    const moneda = document.getElementById("moneda-debitar").value;
    const descripcion = document.getElementById("descripcion-debito").value.trim();
    const resultadoDiv = document.getElementById("resultado-debito-tarjeta");

    // Validaciones
    if (!numeroTarjeta || numeroTarjeta.length !== 16) {
        mostrarResultado("error", "‚ùå Por favor, ingrese un n√∫mero de tarjeta v√°lido (16 d√≠gitos).", resultadoDiv);
        return;
    }
    
    if (isNaN(monto) || monto <= 0) {
        mostrarResultado("error", "‚ùå Por favor, ingrese un monto v√°lido mayor a cero.", resultadoDiv);
        return;
    }
    
    if (!descripcion) {
        mostrarResultado("error", "‚ùå Por favor, ingrese una descripci√≥n para el d√©bito.", resultadoDiv);
        return;
    }
    
    if (moneda !== "RD$") {
        mostrarResultado("error", "‚ùå Actualmente, solo se permiten d√©bitos en RD$.", resultadoDiv);
        return;
    }

    console.log("Buscando tarjeta:", numeroTarjeta);

    // Buscar la tarjeta
    const transaction = db.transaction(["tarjetas"], "readwrite");
    const store = transaction.objectStore("tarjetas");
    
    // Intentar buscar por n√∫mero de tarjeta
    const request = store.openCursor();
    
    let tarjetaEncontrada = null;
    
    request.onsuccess = function(e) {
        const cursor = e.target.result;
        if (cursor) {
            const tarjeta = cursor.value;
            // Comparar n√∫meros de tarjeta (sin espacios)
            const tarjetaNumero = tarjeta.numero ? tarjeta.numero.replace(/\s/g, '') : '';
            
            if (tarjetaNumero === numeroTarjeta) {
                tarjetaEncontrada = tarjeta;
                console.log("Tarjeta encontrada:", tarjetaEncontrada);
            }
            cursor.continue();
        } else {
            // Cuando termina de buscar
            if (tarjetaEncontrada) {
                procesarDebito(tarjetaEncontrada, monto, descripcion, resultadoDiv);
            } else {
                mostrarResultado("error", "‚ùå Tarjeta no encontrada. Verifique el n√∫mero ingresado.", resultadoDiv);
            }
        }
    };

    request.onerror = function(e) {
        console.error("Error al buscar tarjeta:", e);
        mostrarResultado("error", "‚ùå Error al buscar la tarjeta en la base de datos.", resultadoDiv);
    };
}

function procesarDebito(tarjeta, monto, descripcion, resultadoDiv) {
    if (tarjeta.estado !== "Aprobada") {
        mostrarResultado("error", `‚ùå La tarjeta est√° ${tarjeta.estado.toLowerCase()}. No se pueden realizar d√©bitos.`, resultadoDiv);
        return;
    }
    // Verificar l√≠mite de cr√©dito
    const saldoActual = parseFloat(tarjeta.saldo) || 0;
    const limite = parseFloat(tarjeta.limite);
    if ((saldoActual + monto) > limite) {
        const disponible = limite - saldoActual;
        mostrarResultado("error", 
            `‚ùå El d√©bito excede el l√≠mite de cr√©dito disponible.
` +
            `L√≠mite: RD$ ${limite.toFixed(2)}
` +
            `Saldo actual: RD$ ${saldoActual.toFixed(2)}
` +
            `Disponible: RD$ ${disponible.toFixed(2)}`, 
            resultadoDiv
        );
        return;
    }

    // ‚úÖ Verificar que el cajero tenga suficiente efectivo en caja (RD$)
    if (usuarioSesion.balanceRD < monto) {
        mostrarResultado("error",
            `‚ùå No hay suficiente efectivo en caja para realizar este d√©bito.
` +
            `Disponible en caja: RD$ ${usuarioSesion.balanceRD.toFixed(2)}`,
            resultadoDiv
        );
        return;
    }

    // Actualizar saldo de la tarjeta
    const nuevoSaldo = saldoActual + monto;

    // Actualizar en la base de datos
    const updateTransaction = db.transaction(["tarjetas"], "readwrite");
    const updateStore = updateTransaction.objectStore("tarjetas");
    const getRequest = updateStore.get(tarjeta.id);
    getRequest.onsuccess = function() {
        const tarjetaActual = getRequest.result;
        if (tarjetaActual) {
            tarjetaActual.saldo = nuevoSaldo;
            const updateRequest = updateStore.put(tarjetaActual);
            updateRequest.onsuccess = function() {
                // ‚úÖ Debitar del balance del cajero
                usuarioSesion.balanceRD -= monto;

                // ‚úÖ Guardar nuevo balance en la base de datos
                const userTrans = db.transaction(["usuarios"], "readwrite");
                const userStore = userTrans.objectStore("usuarios");
                const userIndex = userStore.index("usuario");
                const userReq = userIndex.get(usuarioSesion.usuario);
                userReq.onsuccess = function() {
                    const user = userReq.result;
                    if (user) {
                        user.balanceRD = usuarioSesion.balanceRD;
                        userStore.put(user);

                        // Registrar la transacci√≥n
                        const transaccion = {
				cajero: usuarioSesion.usuario, // üëà AGREGAR ESTA L√çNEA
                            cuenta: tarjeta.numero,
                            tipo: "D√©bito Tarjeta",
                            monto: monto,
                            moneda: "RD$",
                            referencia: `D√©bito: ${descripcion}`,
                            fecha: new Date().toLocaleString()
                        };
                        guardarTransaccion(transaccion, resultadoDiv, 
                            `‚úÖ D√©bito de RD$ ${monto.toFixed(2)} realizado.
` +
                            `Nuevo saldo tarjeta: RD$ ${nuevoSaldo.toFixed(2)}.
` +
                            `Efectivo en caja actualizado: RD$ ${usuarioSesion.balanceRD.toFixed(2)}.`
                        );

                        // ‚úÖ Actualizar visualizaci√≥n del efectivo disponible
                        calcularEfectivoDisponible();

                        // Limpiar formulario
                        document.getElementById("numero-tarjeta-debitar").value = "";
                        document.getElementById("monto-debitar").value = "";
                        document.getElementById("descripcion-debito").value = "";
                    }
                };
            };
            updateRequest.onerror = function() {
                mostrarResultado("error", "‚ùå Error al actualizar el saldo de la tarjeta.", resultadoDiv);
            };
        }
    };
    getRequest.onerror = function() {
        mostrarResultado("error", "‚ùå Error al obtener datos de la tarjeta para actualizar.", resultadoDiv);
    };
}

function procesarAvanceEfectivo(tarjeta, monto, descripcion, resultadoDiv) {
  if (tarjeta.estado !== "Aprobada") {
    mostrarResultado("error", `‚ùå La tarjeta est√° ${tarjeta.estado.toLowerCase()}. No se pueden realizar avances de efectivo.`, resultadoDiv);
    return;
  }

  // Verificar l√≠mite de cr√©dito
  const saldoActual = parseFloat(tarjeta.saldo) || 0;
  const limite = parseFloat(tarjeta.limite);
  if ((saldoActual + monto) > limite) {
    const disponible = limite - saldoActual;
    mostrarResultado("error", 
      `‚ùå El avance excede el l√≠mite de cr√©dito disponible.
L√≠mite: RD$ ${limite.toFixed(2)}
Saldo actual: RD$ ${saldoActual.toFixed(2)}
Disponible: RD$ ${disponible.toFixed(2)}`, 
      resultadoDiv
    );
    return;
  }

  // Verificar que el cajero tenga suficiente efectivo en RD$
  if (usuarioSesion.balanceRD < monto) {
    mostrarResultado("error",
      `‚ùå No hay suficiente efectivo en caja para realizar este avance.
Disponible en caja: RD$ ${usuarioSesion.balanceRD.toFixed(2)}`,
      resultadoDiv
    );
    return;
  }

  // Actualizar saldo de la tarjeta
  const nuevoSaldo = saldoActual + monto;

  // Actualizar en la base de datos
  const updateTransaction = db.transaction(["tarjetas"], "readwrite");
  const updateStore = updateTransaction.objectStore("tarjetas");
  const getRequest = updateStore.get(tarjeta.id);

  getRequest.onsuccess = function() {
    const tarjetaActual = getRequest.result;
    if (tarjetaActual) {
      tarjetaActual.saldo = nuevoSaldo;
      const updateRequest = updateStore.put(tarjetaActual);
      updateRequest.onsuccess = function() {
        // ‚úÖ Debitar del balance del cajero (efectivo entregado)
        usuarioSesion.balanceRD -= monto;

        // ‚úÖ Guardar nuevo balance en la base de datos
        const userTrans = db.transaction(["usuarios"], "readwrite");
        const userStore = userTrans.objectStore("usuarios");
        const userIndex = userStore.index("usuario");
        const userReq = userIndex.get(usuarioSesion.usuario);
        userReq.onsuccess = function() {
          const user = userReq.result;
          if (user) {
            user.balanceRD = usuarioSesion.balanceRD;
            userStore.put(user);

            // Registrar la transacci√≥n
            const transaccion = {
		cajero: usuarioSesion.usuario, // üëà AGREGAR ESTA L√çNEA
              cuenta: tarjeta.numero,
              tipo: "Avance de Efectivo",
              monto: monto,
              moneda: "RD$",
              referencia: `Avance: ${descripcion}`,
              fecha: new Date().toLocaleString()
            };
            guardarTransaccion(transaccion, resultadoDiv, 
              `‚úÖ Avance de efectivo de RD$ ${monto.toFixed(2)} realizado.
Nuevo saldo tarjeta: RD$ ${nuevoSaldo.toFixed(2)}.
Efectivo en caja actualizado: RD$ ${usuarioSesion.balanceRD.toFixed(2)}.`
            );

            // Limpiar formulario
            document.getElementById("numero-tarjeta-avance").value = "";
            document.getElementById("monto-avance").value = "";
            document.getElementById("descripcion-avance").value = "";
          }
        };
      };
      updateRequest.onerror = function() {
        mostrarResultado("error", "‚ùå Error al actualizar el saldo de la tarjeta.", resultadoDiv);
      };
    }
  };
  getRequest.onerror = function() {
    mostrarResultado("error", "‚ùå Error al obtener datos de la tarjeta para actualizar.", resultadoDiv);
  };
}

function realizarCobroTarjeta() {
  let numeroTarjeta = document.getElementById("numero-tarjeta-cobro").value.trim().replace(/\s/g, '');
  const monto = parseFloat(document.getElementById("monto-cobro").value);
  const metodo = document.getElementById("metodo-cobro-tarjeta").value;
  const cuentaOrigen = metodo === "cuenta" ? document.getElementById("cuenta-cobro-tarjeta").value.trim() : null;
  const resultadoDiv = document.getElementById("resultado-cobro-tarjeta");

  // Validaciones b√°sicas
  if (!numeroTarjeta || numeroTarjeta.length !== 16) {
    mostrarResultado("error", "‚ùå Ingrese un n√∫mero de tarjeta v√°lido (16 d√≠gitos).", resultadoDiv);
    return;
  }
  if (isNaN(monto) || monto <= 0) {
    mostrarResultado("error", "‚ùå Ingrese un monto v√°lido mayor a cero.", resultadoDiv);
    return;
  }
  if (metodo === "cuenta" && !cuentaOrigen) {
    mostrarResultado("error", "‚ùå Ingrese el n√∫mero de cuenta Simubank.", resultadoDiv);
    return;
  }

  // Buscar la tarjeta
  const transT = db.transaction(["tarjetas"], "readwrite");
  const storeT = transT.objectStore("tarjetas");
  const reqT = storeT.openCursor();
  let tarjetaEncontrada = null;

  reqT.onsuccess = function(e) {
    const cursor = e.target.result;
    if (cursor) {
      const t = cursor.value;
      if (t.numero.replace(/\s/g, '') === numeroTarjeta) tarjetaEncontrada = t;
      cursor.continue();
    } else {
      if (!tarjetaEncontrada) {
        mostrarResultado("error", "‚ùå Tarjeta no encontrada.", resultadoDiv);
        return;
      }
      if (tarjetaEncontrada.estado !== "Aprobada") {
        mostrarResultado("error", `‚ùå La tarjeta est√° ${tarjetaEncontrada.estado.toLowerCase()}.`, resultadoDiv);
        return;
      }

      if (metodo === "cuenta") {
        // Validar cuenta origen y realizar d√©bito
        const transC = db.transaction(["cuentas"], "readwrite");
        const storeC = transC.objectStore("cuentas");
        const reqC = storeC.index("numeroCuenta").get(cuentaOrigen);
        reqC.onsuccess = function() {
          const cuenta = reqC.result;
          if (!cuenta) {
            mostrarResultado("error", "‚ùå Cuenta Simubank no encontrada.", resultadoDiv);
            return;
          }
          if (cuenta.saldo < monto) {
            mostrarResultado("error", `‚ùå Saldo insuficiente. Saldo: ${cuenta.moneda} ${cuenta.saldo.toFixed(2)}`, resultadoDiv);
            return;
          }
          if (cuenta.moneda !== "RD$") {
            mostrarResultado("error", "‚ùå Solo se permiten cobros en RD$ desde cuentas.", resultadoDiv);
            return;
          }
          // Actualizar saldos
          cuenta.saldo -= monto;
          storeC.put(cuenta);

          // Aplicar cobro a la tarjeta
          aplicarCobroATarjeta(tarjetaEncontrada, monto, "D√©bito a cuenta", resultadoDiv);
        };
      } else {
        // Cobro en efectivo ‚Üí afecta balance del cajero
        if (usuarioSesion.balanceRD < monto) {
          mostrarResultado("error", `‚ùå No hay suficiente efectivo en caja. Disponible: RD$ ${usuarioSesion.balanceRD.toFixed(2)}`, resultadoDiv);
          return;
        }
        usuarioSesion.balanceRD += monto;

        // Guardar balance en BD
        const userTrans = db.transaction(["usuarios"], "readwrite");
        const userStore = userTrans.objectStore("usuarios");
        const userReq = userStore.index("usuario").get(usuarioSesion.usuario);
        userReq.onsuccess = function() {
          const user = userReq.result;
          user.balanceRD = usuarioSesion.balanceRD;
          userStore.put(user);
        };

        // Aplicar cobro a la tarjeta
        aplicarCobroATarjeta(tarjetaEncontrada, monto, "Efectivo", resultadoDiv);
      }
    }
  };
}

function aplicarCobroATarjeta(tarjeta, monto, metodo, resultadoDiv) {
  const nuevoSaldo = Math.max(0, (parseFloat(tarjeta.saldo) || 0) - monto);
  const transT = db.transaction(["tarjetas"], "readwrite");
  const storeT = transT.objectStore("tarjetas");
  const reqT = storeT.get(tarjeta.id);
  reqT.onsuccess = function() {
    const t = reqT.result;
    t.saldo = nuevoSaldo;
    storeT.put(t);

    // Registrar transacci√≥n
    const transaccion = {
      cajero: usuarioSesion.usuario,
      cuenta: tarjeta.numero,
      tipo: "Cobro Tarjeta",
      monto: monto,
      moneda: "RD$",
      referencia: `Cobro v√≠a ${metodo}`,
      fecha: new Date().toLocaleString()
    };
    guardarTransaccion(transaccion, resultadoDiv,
      `‚úÖ Cobro de RD$ ${monto.toFixed(2)} aplicado.\nNuevo saldo: RD$ ${nuevoSaldo.toFixed(2)}.\nM√©todo: ${metodo}.`
    );

    // Actualizar efectivo en pantalla si fue en efectivo
    if (metodo === "Efectivo") calcularEfectivoDisponible();

    // Limpiar formulario
    document.getElementById("numero-tarjeta-cobro").value = "";
    document.getElementById("monto-cobro").value = "";
    document.getElementById("metodo-cobro-tarjeta").value = "efectivo";
    toggleCuentaCobroTarjeta();
  };
}

function procesarCobro(tarjeta, monto, resultadoDiv) {
    if (tarjeta.estado !== "Aprobada") {
        mostrarResultado("error", `‚ùå La tarjeta est√° ${tarjeta.estado.toLowerCase()}. No se pueden realizar cobros.`, resultadoDiv);
        return;
    }
    
    // Verificar saldo actual
    const saldoActual = parseFloat(tarjeta.saldo) || 0;
    
    if (monto > saldoActual) {
        mostrarResultado("warning", 
            `‚ö†Ô∏è El monto a cobrar (RD$ ${monto.toFixed(2)}) es mayor que el saldo actual (RD$ ${saldoActual.toFixed(2)}).\n` +
            `Se aplicar√° como sobrepago.`, 
            resultadoDiv
        );
    }

    // Actualizar saldo de la tarjeta (no permitir saldo negativo)
    const nuevoSaldo = Math.max(0, saldoActual - monto);
    
    // Actualizar en la base de datos
    const updateTransaction = db.transaction(["tarjetas"], "readwrite");
    const updateStore = updateTransaction.objectStore("tarjetas");
    
    const getRequest = updateStore.get(tarjeta.id);
    
    getRequest.onsuccess = function() {
        const tarjetaActual = getRequest.result;
        if (tarjetaActual) {
            tarjetaActual.saldo = nuevoSaldo;
            
            const updateRequest = updateStore.put(tarjetaActual);
            
            updateRequest.onsuccess = function() {
                // ‚úÖ NUEVO: SUMAR EL MONTO AL BALANCE DE CAJA DEL CAJERO
                usuarioSesion.balanceRD += monto;
                
                // ‚úÖ GUARDAR EL NUEVO BALANCE EN LA BASE DE DATOS
                const updateBalanceTrans = db.transaction(["usuarios"], "readwrite");
                const userStore = updateBalanceTrans.objectStore("usuarios");
                const userIndex = userStore.index("usuario");
                const getUserRequest = userIndex.get(usuarioSesion.usuario);
                
                getUserRequest.onsuccess = function() {
                    const user = getUserRequest.result;
                    if (user) {
                        user.balanceRD = usuarioSesion.balanceRD;
                        userStore.put(user);
                        
                        // Registrar la transacci√≥n
                        const transaccion = {
			cajero: usuarioSesion.usuario, // üëà AGREGAR ESTA L√çNEA
                            cuenta: tarjeta.numero,
                            tipo: "Cobro Tarjeta",
                            monto: monto,
                            moneda: "RD$",
                            referencia: `Cobro/Abono a tarjeta de cr√©dito`,
                            fecha: new Date().toLocaleString()
                        };
                        
                        guardarTransaccion(transaccion, resultadoDiv, 
                            `‚úÖ Cobro de RD$ ${monto.toFixed(2)} aplicado a la tarjeta ${tarjeta.numero.match(/.{1,4}/g).join(' ')}.\n` +
                            `Nuevo saldo: RD$ ${nuevoSaldo.toFixed(2)}.\n` +
                            `Balance de caja actualizado: RD$ ${usuarioSesion.balanceRD.toFixed(2)}`
                        );
                        
                        // Recalcular el efectivo disponible en pantalla
                        calcularEfectivoDisponible();
                        
                        // Limpiar formulario
                        document.getElementById("numero-tarjeta-cobro").value = "";
                        document.getElementById("monto-cobro").value = "";
                    }
                };
            };

            updateRequest.onerror = function() {
                mostrarResultado("error", "‚ùå Error al actualizar el saldo de la tarjeta.", resultadoDiv);
            };
        }
    };
    
    getRequest.onerror = function() {
        mostrarResultado("error", "‚ùå Error al obtener datos de la tarjeta para actualizar.", resultadoDiv);
    };
}

      // Funci√≥n para buscar y consultar una tarjeta
      function buscarTarjetaConsulta() {
        const query = document.getElementById("buscar-tarjeta-consulta").value.trim();
        if (!query) {
          alert("Por favor, ingrese un n√∫mero de cuenta, c√©dula o n√∫mero de tarjeta.");
          return;
        }
        const transaction = db.transaction(["tarjetas", "cuentas"], "readonly");
        const tarjetaStore = transaction.objectStore("tarjetas");
        const cuentaStore = transaction.objectStore("cuentas");
        let request;
        // Intentar buscar por n√∫mero de tarjeta primero (16 d√≠gitos)
        if (/^\d{16}$/.test(query.replace(/\s/g, ''))) {
          const indexNumero = tarjetaStore.index("numero");
          request = indexNumero.get(query.replace(/\s/g, ''));
        } else {
          // Buscar por n√∫mero de cuenta
          const indexCuenta = tarjetaStore.index("cuenta");
          request = indexCuenta.get(query);
        }
        request.onsuccess = function() {
          let tarjeta = request.result;
          if (!tarjeta && !/^\d{16}$/.test(query.replace(/\s/g, ''))) {
            // Si no se encontr√≥ por cuenta y el query no es un n√∫mero de tarjeta, buscar por c√©dula
            const indexCedula = cuentaStore.index("cedula");
            const requestCedula = indexCedula.get(query);
            requestCedula.onsuccess = function() {
              const cuenta = requestCedula.result;
              if (cuenta) {
                const indexCuentaTarjeta = tarjetaStore.index("cuenta");
                const requestCuentaTarjeta = indexCuentaTarjeta.get(cuenta.numeroCuenta);
                requestCuentaTarjeta.onsuccess = function() {
                  mostrarResultadoConsulta(requestCuentaTarjeta.result);
                };
              } else {
                mostrarResultadoConsulta(null);
              }
            };
            return;
          }
          mostrarResultadoConsulta(tarjeta);
        };
      }

function mostrarModalCambio(accion, moneda, montoDivisa, montoRD) {
  const modalHtml = `
    <div id="modal-cambio" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 2000;">
      <div class="modal-content" style="background: white; padding: 30px; border-radius: 10px; width: 400px; max-width: 90%; text-align: center;">
        <h3>üí± Operaci√≥n de Cambio Exitosa</h3>
        <p style="font-size: 1.1em; margin: 20px 0; line-height: 1.6;">
          <strong>${accion}</strong><br>
          <span style="font-size: 1.3em; color: #003366;">${moneda} ${montoDivisa}</span><br>
          por<br>
          <span style="font-size: 1.3em; color: #28a745;">RD$ ${montoRD}</span>
        </p>
        <button onclick="cerrarModalCambio()" style="padding: 10px 20px; background: #0056b3; color: white; border: none; border-radius: 5px; cursor: pointer;">
          Cerrar
        </button>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function cerrarModalCambio() {
  const modal = document.getElementById("modal-cambio");
  if (modal) modal.remove();
}

function mostrarModalCuenta(numeroCuenta) {
  const modalHtml = `
    <div id="modal-cuenta" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 2000;">
      <div class="modal-content" style="background: white; padding: 30px; border-radius: 10px; width: 400px; max-width: 90%; text-align: center;">
        <h3>‚úÖ Cuenta Creada Exitosamente</h3>
        <p style="font-size: 1.2em; margin: 20px 0; font-weight: bold; color: #003366;">
          N√∫mero de Cuenta:<br>
          <span style="font-family: monospace; letter-spacing: 2px;">${numeroCuenta}</span>
        </p>
        <button onclick="cerrarModalCuenta()" style="padding: 10px 20px; background: #0056b3; color: white; border: none; border-radius: 5px; cursor: pointer;">
          Cerrar
        </button>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function cerrarModalCuenta() {
  const modal = document.getElementById("modal-cuenta");
  if (modal) modal.remove();
}
      function mostrarResultadoConsulta(tarjeta) {
  const resultadoDiv = document.getElementById("resultado-consulta-tarjeta");
  const detallesDiv = document.getElementById("detalles-tarjeta");
  const historialDiv = document.getElementById("historial-movimientos");
  if (tarjeta) {
    document.getElementById("consulta-num-tarjeta").textContent = tarjeta.numero.match(/.{1,4}/g).join(' ');
    document.getElementById("consulta-nombre-titular").textContent = tarjeta.nombreTitular;
    document.getElementById("consulta-tipo-tarjeta").textContent = tarjeta.tipo;
    document.getElementById("consulta-limite").textContent = parseFloat(tarjeta.limite).toFixed(2);
    document.getElementById("consulta-saldo").textContent = parseFloat(tarjeta.saldo || 0).toFixed(2);
    document.getElementById("consulta-estado").textContent = tarjeta.estado;
    document.getElementById("consulta-fecha-emision").textContent = new Date(tarjeta.fechaEmision).toLocaleString();
    document.getElementById("consulta-fecha-vencimiento").textContent = tarjeta.vencimiento;

    // Limpiar el contenedor de historial antes de cargar nuevos datos
    historialDiv.innerHTML = "<p>Cargando historial de movimientos...</p>";

    // Abrir una transacci√≥n para leer las transacciones relacionadas con esta tarjeta
    const transaccion = db.transaction(["transacciones"], "readonly");
    const store = transaccion.objectStore("transacciones");
    const index = store.index("cuenta");

    // Crear un rango para buscar todas las transacciones con el n√∫mero de tarjeta exacto
    const keyRange = IDBKeyRange.only(tarjeta.numero);

    // Solicitar un cursor para iterar sobre todas las transacciones encontradas
    const request = index.openCursor(keyRange);

    request.onsuccess = function(e) {
      const cursor = e.target.result;
      // Limpiar el historial nuevamente para mostrar los resultados o el mensaje de "sin movimientos"
      historialDiv.innerHTML = "";

      if (!cursor) {
        // Si no hay cursor, no se encontraron transacciones
        historialDiv.innerHTML = "<div class='alert'>No hay movimientos registrados para esta tarjeta.</div>";
        return;
      }

      // Crear una lista no ordenada para los movimientos
      const ul = document.createElement("ul");
      ul.style.listStyleType = "none";
      ul.style.padding = "0";
      ul.style.margin = "0";

      // Funci√≥n recursiva para recorrer todos los registros del cursor
      function procesarCursor(cursorActual) {
        if (!cursorActual) {
          // Cuando no hay m√°s registros, agregar la lista al DOM
          historialDiv.appendChild(ul);
          return;
        }

        const t = cursorActual.value;

        // Crear un elemento de lista para cada transacci√≥n
        const li = document.createElement("li");
        li.style.padding = "12px";
        li.style.margin = "8px 0";
        li.style.backgroundColor = t.tipo === "Cobro Tarjeta" ? "#d4edda" : "#f8d7da"; // Verde para cobros, rojo para d√©bitos
        li.style.borderRadius = "6px";
        li.style.borderLeft = `4px solid ${t.tipo === "Cobro Tarjeta" ? "#28a745" : "#dc3545"}`;
        li.style.boxShadow = "0 1px 3px rgba(0,0,0,0.1)";

        // Formatear la transacci√≥n
        let icono = t.tipo === "Cobro Tarjeta" ? "üü¢" : "üî¥";
        li.innerHTML = `
          <div><strong>${icono} ${t.fecha}</strong></div>
          <div>${t.tipo}: <strong>${t.moneda} ${t.monto.toFixed(2)}</strong></div>
          <div><small>${t.referencia}</small></div>
        `;

        // A√±adir el elemento a la lista
        ul.appendChild(li);

        // Continuar con el siguiente registro
        cursorActual.continue();
      }

      // Iniciar el procesamiento del cursor
      procesarCursor(cursor);
    };

    request.onerror = function() {
      historialDiv.innerHTML = "<div class='alert error'>Error al cargar el historial de movimientos.</div>";
    };

    // Mostrar los detalles de la tarjeta
    detallesDiv.classList.remove("hidden");
    resultadoDiv.innerHTML = "";
  } else {
    // Si no se encuentra la tarjeta
    resultadoDiv.innerHTML = "<div class='alert'>No se encontr√≥ ninguna tarjeta con esos datos.</div>";
    detallesDiv.classList.add("hidden");
  }
}
      function mostrarResultado(tipo, mensaje, elemento) {
        if (!elemento) return;
        elemento.textContent = mensaje;
        elemento.className = `alert ${tipo}`;
        elemento.classList.remove("hidden");
        setTimeout(() => elemento.classList.add("hidden"), 5000);
      }

function guardarTransaccion(transaccion, resultadoDiv, mensaje) {
  const transaction = db.transaction(["transacciones"], "readwrite");
  const store = transaction.objectStore("transacciones");
  const request = store.add(transaccion);
  request.onsuccess = () => {
    mostrarResultado("success", mensaje, resultadoDiv);
    calcularEfectivoDisponible();
    actualizarTotalesResumen(transaccion);
    cargarTodasTransacciones();

    // === IMPRESI√ìN DE RECIBO AUTOM√ÅTICA ===
    if (["Dep√≥sito", "Retiro", "Pago de Servicio", "Transferencia", "Cobro de Pr√©stamo", "D√©bito Tarjeta", "Cobro Tarjeta", "Avance de Efectivo"].includes(transaccion.tipo)) {
      // Buscar datos del titular (solo si es cuenta bancaria, no CAJA ni tarjeta)
      let titular = "Cliente";
      let producto = "Cuenta";
      let moneda = transaccion.moneda;
      let cuenta = transaccion.cuenta;

      // Si es una cuenta bancaria (no tarjeta ni CAJA), buscar el titular
      if (cuenta && cuenta !== "CAJA" && !/^\d{16}$/.test(cuenta)) {
        const cuentaTrans = db.transaction(["cuentas"], "readonly");
        const cuentaStore = cuentaTrans.objectStore("cuentas");
        const cuentaIndex = cuentaStore.index("numeroCuenta");
        const cuentaReq = cuentaIndex.get(cuenta);
        cuentaReq.onsuccess = function() {
          const cuentaData = cuentaReq.result;
          if (cuentaData) {
            titular = cuentaData.nombre;
            producto = cuentaData.tipoCuenta || "Cuenta";
            moneda = cuentaData.moneda || transaccion.moneda;
          }
          const datosRecibo = {
  cuenta: transaccion.cuenta,
  titular: titular,
  moneda: moneda,
  monto: transaccion.monto,
  fecha: transaccion.fecha,
  sucursal: usuarioSesion.sucursal,
  formaPago: {
    efectivo: true,
    cheque: false,
    retiro: false
  }
};
imprimirRecibo(transaccion.tipo, datosRecibo);
        };
        cuentaReq.onerror = () => {
          // Si no se encuentra, usar valores por defecto
          const datosRecibo = {
            cuenta: transaccion.cuenta,
            titular: titular,
            producto: producto,
            moneda: moneda,
            monto: transaccion.monto,
            saldo: 0,
            fecha: transaccion.fecha,
            sucursal: usuarioSesion.sucursal
          };
          imprimirRecibo(transaccion.tipo, datosRecibo);
        };
      } else {
        // Para operaciones sin cuenta espec√≠fica (como CAJA o tarjetas)
        const datosRecibo = {
          cuenta: transaccion.cuenta,
          titular: titular,
          producto: transaccion.tipo,
          moneda: moneda,
          monto: transaccion.monto,
          saldo: 0,
          fecha: transaccion.fecha,
          sucursal: usuarioSesion.sucursal
        };
        imprimirRecibo(transaccion.tipo, datosRecibo);
      }
    }
  };
  request.onerror = () => mostrarResultado("error", "‚ùå Error al registrar la transacci√≥n.", resultadoDiv);
}

// üîÑ NUEVA FUNCI√ìN: Actualizar totales del resumen cuando se hace una transacci√≥n
function actualizarTotalesResumen(transaccion) {
  const monto = transaccion.monto;
  const moneda = transaccion.moneda;
  const tipo = transaccion.tipo;
  
  let elemento = null;
  
  switch(tipo) {
    case "Dep√≥sito":
      if (moneda === "RD$") elemento = document.getElementById("total-depositos-rd");
      else if (moneda === "USD") elemento = document.getElementById("total-depositos-usd");
      else if (moneda === "EUR") elemento = document.getElementById("total-depositos-eur");
      break;
      
    case "Retiro":
      if (moneda === "RD$") elemento = document.getElementById("total-retiros-rd");
      else if (moneda === "USD") elemento = document.getElementById("total-retiros-usd");
      else if (moneda === "EUR") elemento = document.getElementById("total-retiros-eur");
      break;
      
    case "Pago de Servicio":
      elemento = document.getElementById("total-pagos-servicios");
      break;
  }
  
  if (elemento) {
    const totalActual = parseFloat(elemento.textContent.replace(/[^0-9.-]/g, '')) || 0;
    const nuevoTotal = totalActual + monto;
    elemento.textContent = `${moneda} ${nuevoTotal.toFixed(2)}`;
  }
}

function realizarTransferencia() {
  const cuentaOrigen = document.getElementById("cuenta-origen").value.trim();
  const cuentaDestino = document.getElementById("cuenta-destino").value.trim();
  const monto = parseFloat(document.getElementById("monto-transferencia").value);
  const moneda = document.getElementById("moneda-transferencia").value;
  const resultado = document.getElementById("resultado-transferencia");

  if (!cuentaOrigen || !cuentaDestino || isNaN(monto) || monto <= 0) {
    mostrarResultado("error", "‚ùå Complete todos los campos correctamente.", resultado);
    return;
  }
  if (cuentaOrigen === cuentaDestino) {
    mostrarResultado("error", "‚ùå No puede transferir a la misma cuenta.", resultado);
    return;
  }

  const transaccion = db.transaction(["cuentas"], "readwrite");
  const store = transaccion.objectStore("cuentas");
  const indexOrigen = store.index("numeroCuenta");
  const indexDestino = store.index("numeroCuenta");

  const requestOrigen = indexOrigen.get(cuentaOrigen);
  requestOrigen.onsuccess = function() {
    const cuentaOrigenData = requestOrigen.result;
    if (!cuentaOrigenData) {
      mostrarResultado("error", "‚ùå Cuenta de origen no encontrada.", resultado);
      return;
    }

    // üîí VALIDACI√ìN: La moneda del formulario debe coincidir con la moneda de la cuenta origen
    if (cuentaOrigenData.moneda !== moneda) {
      mostrarResultado(
        "error",
        `‚ùå La moneda seleccionada (${moneda}) no coincide con la moneda de la cuenta de origen (${cuentaOrigenData.moneda}).`,
        resultado
      );
      return;
    }

    if (cuentaOrigenData.saldo < monto) {
      mostrarResultado("error", `‚ùå Saldo insuficiente en cuenta de origen. Saldo: ${moneda} ${cuentaOrigenData.saldo.toFixed(2)}`, resultado);
      return;
    }

    const requestDestino = indexDestino.get(cuentaDestino);
    requestDestino.onsuccess = function() {
      const cuentaDestinoData = requestDestino.result;
      if (!cuentaDestinoData) {
        mostrarResultado("error", "‚ùå Cuenta de destino no encontrada.", resultado);
        return;
      }

      // üîí VALIDACI√ìN: Ambas cuentas deben tener la misma moneda (ya impl√≠cito, pero expl√≠cito es mejor)
      if (cuentaOrigenData.moneda !== cuentaDestinoData.moneda) {
        mostrarResultado("error", "‚ùå No se puede transferir entre cuentas de diferentes monedas.", resultado);
        return;
      }

      cuentaOrigenData.saldo -= monto;
      cuentaDestinoData.saldo += monto;
      store.put(cuentaOrigenData);
      store.put(cuentaDestinoData);

      const transaccionData = {
        cuenta: cuentaOrigen,
        tipo: "Transferencia",
        monto,
        moneda,
        referencia: `Transferencia a ${cuentaDestino}`,
        fecha: new Date().toLocaleString()
      };
      guardarTransaccion(transaccionData, resultado, `‚úÖ Transferencia de ${moneda} ${monto.toFixed(2)} realizada exitosamente.`);
      
      // Limpiar campos
      document.getElementById("cuenta-origen").value = "";
      document.getElementById("cuenta-destino").value = "";
      document.getElementById("monto-transferencia").value = "";
    };
  };
}

      function consultarSaldo() {
        const cuenta = document.getElementById("cuenta-saldo").value.trim();
        const resultado = document.getElementById("resultado-saldo");
        const datosCuenta = document.getElementById("datos-cuenta");
        if (!cuenta) {
          mostrarResultado("error", "‚ùå Ingrese un n√∫mero de cuenta.", resultado);
          return;
        }
        const transaction = db.transaction(["cuentas"], "readonly");
        const store = transaction.objectStore("cuentas");
        const index = store.index("numeroCuenta");
        const request = index.get(cuenta);
        request.onsuccess = function() {
          const cuentaData = request.result;
          if (!cuentaData) {
            mostrarResultado("error", "‚ùå Cuenta no encontrada.", resultado);
            datosCuenta.classList.add("hidden");
            return;
          }
          document.getElementById("nombre-titular").textContent = cuentaData.nombre;
          document.getElementById("num-cuenta").textContent = cuentaData.numeroCuenta;
          document.getElementById("tipo-producto").textContent = cuentaData.tipoCuenta;
          document.getElementById("moneda-cuenta").textContent = cuentaData.moneda;
          document.getElementById("saldo-estimado").textContent = `${cuentaData.moneda} ${cuentaData.saldo.toFixed(2)}`;
          datosCuenta.classList.remove("hidden");
          // mostrarResultado("success", `‚úÖ Saldo consultado correctamente.`, resultado); // L√≠nea problem√°tica eliminada
	// Ofrecer imprimir recibo de consulta
	const datosRecibo = {
  	cuenta: cuentaData.numeroCuenta,
  	titular: cuentaData.nombre,
  	producto: cuentaData.tipoCuenta,
  	moneda: cuentaData.moneda,
  	saldo: cuentaData.saldo,
  	fecha: new Date().toLocaleString(),
  	sucursal: usuarioSesion.sucursal
};
imprimirRecibo("Consulta", datosRecibo);
        };
        request.onerror = () => mostrarResultado("error", "‚ùå Error al buscar la cuenta.", resultado);
      }

function mostrarCargando(mensaje = "Buscando...") {
    return `
        <div class="alert" style="text-align: center;">
            <div>‚è≥ ${mensaje}</div>
            <small>Buscando en cuentas, pr√©stamos y tarjetas...</small>
        </div>
    `;
}

// Consultar actividad de un cajero en una fecha espec√≠fica
async function consultarActividadCajero() {
  const usuario = document.getElementById("usuario-cajero-actividad").value.trim();
  const fechaInput = document.getElementById("fecha-actividad").value;
  const resultadoDiv = document.getElementById("resultado-actividad-cajero");
  const tablaBody = document.getElementById("tabla-actividad-cajero");
  const resumenDiv = document.getElementById("resumen-actividad");

  if (!usuario) {
    alert("Por favor, ingrese el usuario del cajero.");
    return;
  }
  if (!fechaInput) {
    alert("Por favor, seleccione una fecha.");
    return;
  }

  // Formatear fecha para coincidir con el formato de transacciones (ej: "5/4/2025")
  const fechaObj = new Date(fechaInput);
  const fechaFormateada = fechaObj.toLocaleDateString(); // Ej: "5/4/2025"

  // Obtener nombre del cajero
  let nombreCajero = "Desconocido";
  try {
    const userTrans = db.transaction(["usuarios"], "readonly");
    const userStore = userTrans.objectStore("usuarios");
    const userIndex = userStore.index("usuario");
    const userReq = userIndex.get(usuario);
    const user = await new Promise((resolve) => {
      userReq.onsuccess = () => resolve(userReq.result);
      userReq.onerror = () => resolve(null);
    });
    if (user) nombreCajero = user.nombre;
  } catch (e) {
    console.warn("No se pudo obtener el nombre del cajero");
  }

  // Filtrar transacciones
  const transaccionesDelDia = transacciones.filter(t => {
    return t.fecha.includes(fechaFormateada) && t.cajero === usuario;
  });

  // Si no hay transacciones, buscar sin filtro de cajero (retrocompatibilidad)
  if (transaccionesDelDia.length === 0) {
    // NOTA: El sistema actual NO almacena el "cajero" en cada transacci√≥n.
    // Por lo tanto, asumiremos que TODAS las transacciones del d√≠a son del cajero activo.
    // Esto es una limitaci√≥n del dise√±o actual.
    const todasDelDia = transacciones.filter(t => t.fecha.includes(fechaFormateada));
    if (todasDelDia.length > 0) {
      // Mostrar advertencia
      alert("‚ö†Ô∏è El sistema no registra el cajero en cada transacci√≥n. Se mostrar√°n TODAS las operaciones del d√≠a.");
      renderizarActividad(todasDelDia, nombreCajero, fechaFormateada);
    } else {
      resultadoDiv.classList.add("hidden");
      alert("No se encontraron operaciones para esa fecha.");
    }
  } else {
    renderizarActividad(transaccionesDelDia, nombreCajero, fechaFormateada);
  }
}

function renderizarActividad(transacciones, nombreCajero, fecha) {
  const tablaBody = document.getElementById("tabla-actividad-cajero");
  const resumenDiv = document.getElementById("resumen-actividad");
  const nombreSpan = document.getElementById("nombre-cajero-actividad");
  const fechaSpan = document.getElementById("fecha-mostrada");

  nombreSpan.textContent = nombreCajero;
  fechaSpan.textContent = fecha;

  tablaBody.innerHTML = "";
  let totalDepositos = 0, totalRetiros = 0, totalPagos = 0, totalOtros = 0;

  transacciones.forEach(t => {
    const tr = document.createElement("tr");
    const hora = t.fecha.split(", ")[1] || t.fecha; // Extraer hora si existe
    tr.innerHTML = `
      <td>${hora}</td>
      <td>${t.tipo}</td>
      <td>${t.monto.toFixed(2)}</td>
      <td>${t.moneda}</td>
      <td>${t.referencia || '‚Äî'}</td>
    `;
    tablaBody.appendChild(tr);

    // Acumular para resumen
    if (t.tipo === "Dep√≥sito") totalDepositos += t.monto;
    else if (t.tipo === "Retiro") totalRetiros += t.monto;
    else if (t.tipo === "Pago de Servicio") totalPagos += t.monto;
    else totalOtros += t.monto;
  });

  // Mostrar resumen
  resumenDiv.innerHTML = `
    <strong>Resumen del D√≠a:</strong><br>
    Dep√≥sitos: RD$ ${totalDepositos.toFixed(2)}<br>
    Retiros: RD$ ${totalRetiros.toFixed(2)}<br>
    Pagos de Servicio: RD$ ${totalPagos.toFixed(2)}<br>
    Otros: RD$ ${totalOtros.toFixed(2)}<br>
    <strong>Total Operaciones:</strong> ${transacciones.length}
  `;

  document.getElementById("resultado-actividad-cajero").classList.remove("hidden");
}

function cargarCajerosRegistrados() {
  const listaDiv = document.getElementById("lista-cajeros");
  listaDiv.innerHTML = "<p>Cargando cajeros...</p>";

  const transaction = db.transaction(["usuarios"], "readonly");
  const store = transaction.objectStore("usuarios");
  const request = store.openCursor();

  const cajeros = [];
  request.onsuccess = function(e) {
    const cursor = e.target.result;
    if (cursor) {
      const user = cursor.value;
      if (user.rol === "cajero" || user.rol === "admin") {
        cajeros.push(user);
      }
      cursor.continue();
    } else {
      if (cajeros.length === 0) {
        listaDiv.innerHTML = "<div class='alert'>No hay cajeros registrados.</div>";
      } else {
        let html = "<div class='grid-2'>";
        cajeros.forEach(c => {
          html += `
            <div class="card" style="padding: 12px; margin: 8px 0;">
              <strong>${c.nombre}</strong><br>
              <small>Usuario: ${c.usuario}</small><br>
              <small>Rol: ${c.rol === 'admin' ? 'Administrador' : 'Cajero'}</small><br>
              <small>Sucursal: ${c.sucursal}</small><br>
              <small>Balance RD$: ${c.balanceRD?.toFixed(2) || '0.00'}</small>
            </div>
          `;
        });
        html += "</div>";
        listaDiv.innerHTML = html;
      }
    }
  };
  request.onerror = function() {
    listaDiv.innerHTML = "<div class='alert error'>Error al cargar la lista de cajeros.</div>";
  };
}

function buscarCliente() {
    const query = document.getElementById("buscar-cliente").value.trim();
    const resultadoDiv = document.getElementById("resultado-busqueda");
    const productosDiv = document.getElementById("productos-cliente");
    const listaProductos = document.getElementById("lista-productos");
    
    if (!query) return;
    
    resultadoDiv.innerHTML = "<div class='alert'>Buscando cliente y productos...</div>";
    productosDiv.classList.add("hidden");
    
    // Buscar por c√©dula o n√∫mero de cuenta
    const transaction = db.transaction(["cuentas", "prestamos", "tarjetas"], "readonly");
    const cuentaStore = transaction.objectStore("cuentas");
    const prestamoStore = transaction.objectStore("prestamos");
    const tarjetaStore = transaction.objectStore("tarjetas");
    
    let clienteEncontrado = null;
    let productos = [];
    
    // Buscar en cuentas
    const cuentaIndex = cuentaStore.index("cedula");
    const cuentaRequest = cuentaIndex.get(query);
    
    cuentaRequest.onsuccess = function(e) {
        const cuenta = e.target.result;
        if (cuenta) {
            clienteEncontrado = cuenta;
            // Agregar como producto de tipo "Cuenta"
            productos.push({
                tipo: "Cuenta Bancaria",
                detalles: `${cuenta.tipoCuenta} - ${cuenta.moneda}`,
                numero: cuenta.numeroCuenta,
                saldo: `${cuenta.moneda} ${cuenta.saldo.toFixed(2)}`,
                estado: "Activa"
            });
        }
        
        // Si no se encontr√≥ por c√©dula, buscar por n√∫mero de cuenta
        if (!clienteEncontrado) {
            const cuentaNumIndex = cuentaStore.index("numeroCuenta");
            const cuentaNumRequest = cuentaNumIndex.get(query);
            
            cuentaNumRequest.onsuccess = function(e2) {
                const cuentaPorNumero = e2.target.result;
                if (cuentaPorNumero) {
                    clienteEncontrado = cuentaPorNumero;
                    productos.push({
                        tipo: "Cuenta Bancaria",
                        detalles: `${cuentaPorNumero.tipoCuenta} - ${cuentaPorNumero.moneda}`,
                        numero: cuentaPorNumero.numeroCuenta,
                        saldo: `${cuentaPorNumero.moneda} ${cuentaPorNumero.saldo.toFixed(2)}`,
                        estado: "Activa"
                    });
                    
                    // Ahora buscar otros productos usando la c√©dula de este cliente
                    buscarProductosPorCedula(clienteEncontrado.cedula, clienteEncontrado, productos);
                } else {
                    // Si no se encontr√≥ por cuenta, buscar por c√©dula en pr√©stamos
                    buscarProductosPorCedula(query, null, productos);
                }
            };
        } else {
            // Buscar otros productos con la misma c√©dula
            buscarProductosPorCedula(query, clienteEncontrado, productos);
        }
    };
    
    function buscarProductosPorCedula(cedula, cliente, productosArray) {
        // Buscar pr√©stamos
        const prestamoIndex = prestamoStore.index("cedula");
        const prestamoRequest = prestamoIndex.openCursor(IDBKeyRange.only(cedula));
        
        prestamoRequest.onsuccess = function(e) {
            const cursor = e.target.result;
            if (cursor) {
                const prestamo = cursor.value;
                productosArray.push({
                    tipo: "Pr√©stamo",
                    detalles: `${prestamo.tipo} - ${prestamo.formaPago}`,
                    numero: prestamo.codigo,
                    saldo: `RD$ ${prestamo.saldoPendiente.toFixed(2)}`,
                    estado: prestamo.estado
                });
                cursor.continue();
            } else {
                // Buscar tarjetas de cr√©dito (necesitamos buscar por cuenta del cliente)
                if (cliente) {
                    buscarTarjetasPorCuenta(cliente.numeroCuenta, cliente, productosArray);
                } else {
                    // Si no tenemos cliente, mostrar solo lo encontrado
                    mostrarResultadoCompleto(cliente, productosArray);
                }
            }
        };
        
        prestamoRequest.onerror = function() {
            if (cliente) {
                buscarTarjetasPorCuenta(cliente.numeroCuenta, cliente, productosArray);
            } else {
                mostrarResultadoCompleto(cliente, productosArray);
            }
        };
    }
    
    function buscarTarjetasPorCuenta(cuenta, cliente, productosArray) {
        const tarjetaIndex = tarjetaStore.index("cuenta");
        const tarjetaRequest = tarjetaIndex.openCursor(IDBKeyRange.only(cuenta));
        
        tarjetaRequest.onsuccess = function(e) {
            const cursor = e.target.result;
            if (cursor) {
                const tarjeta = cursor.value;
                productosArray.push({
                    tipo: "Tarjeta de Cr√©dito",
                    detalles: `${tarjeta.tipo}`,
                    numero: tarjeta.numero.match(/.{1,4}/g).join(' '),
                    saldo: `RD$ ${(tarjeta.saldo || 0).toFixed(2)}`,
                    estado: tarjeta.estado,
                    limite: `RD$ ${tarjeta.limite.toFixed(2)}`
                });
                cursor.continue();
            } else {
                mostrarResultadoCompleto(cliente, productosArray);
            }
        };
        
        tarjetaRequest.onerror = function() {
            mostrarResultadoCompleto(cliente, productosArray);
        };
    }
    
    function mostrarResultadoCompleto(cliente, productosArray) {
        const resultadoDiv = document.getElementById("resultado-busqueda");
        const productosDiv = document.getElementById("productos-cliente");
        const listaProductos = document.getElementById("lista-productos");
        
        if (!cliente && productosArray.length === 0) {
            resultadoDiv.innerHTML = "<div class='alert'>‚ùå Cliente no encontrado.</div>";
            return;
        }
        
        // Mostrar datos del cliente si se encontr√≥
        if (cliente) {
            resultadoDiv.innerHTML = `
                <div class="card">
                    <strong>üë§ Datos del Cliente</strong><br>
                    <strong>Nombre:</strong> ${cliente.nombre}<br>
                    <strong>C√©dula:</strong> ${cliente.cedula}<br>
                    <strong>Tel√©fono:</strong> ${cliente.telefono}<br>
                    <strong>Email:</strong> ${cliente.email || 'No registrado'}<br>
                    <strong>Direcci√≥n:</strong> ${cliente.direccion || 'No registrada'}
                </div>
            `;
        } else {
            resultadoDiv.innerHTML = "<div class='alert'>‚ÑπÔ∏è Se encontraron productos pero no datos completos del cliente.</div>";
        }
        
        // Mostrar todos los productos encontrados
        if (productosArray.length > 0) {
            listaProductos.innerHTML = "";
            
            productosArray.forEach(producto => {
                const productoItem = document.createElement("div");
                productoItem.className = "producto-item";
                
                let contenido = `
                    <div class="producto-titulo">${producto.tipo}</div>
                    <div class="producto-info">
                        <strong>N√∫mero/Referencia:</strong> ${producto.numero}<br>
                        <strong>Detalles:</strong> ${producto.detalles}<br>
                        <strong>Saldo/Monto:</strong> ${producto.saldo}<br>
                        <strong>Estado:</strong> ${producto.estado}
                `;
                
                if (producto.limite) {
                    contenido += `<br><strong>L√≠mite de Cr√©dito:</strong> ${producto.limite}`;
                }
                
                contenido += `</div>`;
                productoItem.innerHTML = contenido;
                listaProductos.appendChild(productoItem);
            });
            
            // Mostrar resumen
            const resumen = document.createElement("div");
            resumen.className = "card";
            resumen.style.background = "#e8f4fd";
            resumen.innerHTML = `
                <strong>üìä Resumen de Productos</strong><br>
                <strong>Total de Productos:</strong> ${productosArray.length}<br>
                <strong>Cuentas:</strong> ${productosArray.filter(p => p.tipo === "Cuenta Bancaria").length}<br>
                <strong>Pr√©stamos:</strong> ${productosArray.filter(p => p.tipo === "Pr√©stamo").length}<br>
                <strong>Tarjetas:</strong> ${productosArray.filter(p => p.tipo === "Tarjeta de Cr√©dito").length}
            `;
            listaProductos.insertBefore(resumen, listaProductos.firstChild);
            
            productosDiv.classList.remove("hidden");
        } else {
            resultadoDiv.innerHTML += "<div class='alert warning'>‚ÑπÔ∏è El cliente no tiene productos registrados con el banco.</div>";
        }
    }
}

      





      function mostrarDatosCliente(cuenta) {
        const resultadoDiv = document.getElementById("resultado-busqueda");
        const productosDiv = document.getElementById("productos-cliente");
        const listaProductos = document.getElementById("lista-productos");
        resultadoDiv.innerHTML = `
          <div class="card">
            <strong>Cliente:</strong> ${cuenta.nombre}<br>
            <strong>C√©dula:</strong> ${cuenta.cedula}<br>
            <strong>Tel√©fono:</strong> ${cuenta.telefono}<br>
            <strong>Email:</strong> ${cuenta.email || 'No registrado'}
          </div>
        `;
        listaProductos.innerHTML = `
          <div class="producto-item">
            <div class="producto-titulo">Cuenta de ${cuenta.tipoCuenta}</div>
            <div class="producto-info">
              <strong>N√∫mero:</strong> ${cuenta.numeroCuenta}<br>
              <strong>Moneda:</strong> ${cuenta.moneda}<br>
              <strong>Saldo:</strong> ${cuenta.moneda} ${cuenta.saldo.toFixed(2)}
            </div>
          </div>
        `;
        productosDiv.classList.remove("hidden");
      }
      function buscarClientePrestamos() {
        const query = document.getElementById("buscar-cliente-prestamo").value.trim().toUpperCase();
        const resultadoDiv = document.getElementById("resultado-cliente-prestamo");
        const listaPrestamos = document.getElementById("lista-prestamos");
        const pagosContainer = document.getElementById("pagos-container");
        const historialPagos = document.getElementById("historial-pagos");
        if (!query) {
          alert("Ingrese una c√©dula o c√≥digo de pr√©stamo.");
          return;
        }
        resultadoDiv.innerHTML = "";
        listaPrestamos.classList.add("hidden");
        pagosContainer.classList.add("hidden");
        historialPagos.innerHTML = "";
        const transaction = db.transaction(["prestamos"], "readonly");
        const store = transaction.objectStore("prestamos");
        const index = query.startsWith("SBPT") ? store.index("codigo") : store.index("cedula");
        index.get(query).onsuccess = function(e) {
          const prestamo = e.target.result;
          if (prestamo) {
            resultadoDiv.innerHTML = `
              <div class="card">
                <strong>Cliente:</strong> ${prestamo.nombre}<br>
                <strong>C√©dula:</strong> ${prestamo.cedula}<br>
                <strong>Tipo de Pr√©stamo:</strong> ${prestamo.tipo}<br>
                <strong>Estado:</strong> ${prestamo.estado}
              </div>
            `;
            const indexCedula = store.index("cedula");
            const request = indexCedula.openCursor(IDBKeyRange.only(prestamo.cedula));
            const prestamosCliente = [];
            request.onsuccess = function(event) {
              const cursor = event.target.result;
              if (cursor) {
                prestamosCliente.push(cursor.value);
                cursor.continue();
              } else {
                listaPrestamos.classList.remove("hidden");
                const container = document.getElementById("prestamos-container");
                container.innerHTML = "";
                prestamosCliente.forEach(p => {
                  const div = document.createElement("div");
                  div.className = "prestamo-item";
                  div.innerHTML = `
                    <h4>${p.tipo} - ${p.codigo}</h4>
                    <p>Monto: RD$ ${p.monto.toFixed(2)} | Estado: ${p.estado} | Saldo: RD$ ${p.saldoPendiente.toFixed(2)}</p>
                  `;
                  div.onclick = () => mostrarHistorialPagos(p);
                  container.appendChild(div);
                });
              }
            };
          } else {
            resultadoDiv.innerHTML = "<div class='alert'>No se encontr√≥ ning√∫n pr√©stamo con ese c√≥digo o c√©dula.</div>";
          }
        };
      }
      function mostrarHistorialPagos(prestamo) {
        const pagosContainer = document.getElementById("pagos-container");
        const historialPagos = document.getElementById("historial-pagos");
        pagosContainer.classList.remove("hidden");
        historialPagos.innerHTML = "";
        if (prestamo.cuotas && prestamo.cuotas.length > 0) {
          const pagosRealizados = prestamo.cuotas.filter(c => c.pagada);
          if (pagosRealizados.length === 0) {
            historialPagos.innerHTML = "<div class='alert'>No se han realizado pagos para este pr√©stamo.</div>";
          } else {
            pagosRealizados.forEach(pago => {
              const div = document.createElement("div");
              div.className = "pago-item";
              div.innerHTML = `
                <strong>Pago de Cuota #${pago.numero}</strong><br>
                Monto: RD$ ${pago.monto.toFixed(2)}<br>
                Fecha de Pago: ${pago.fechaPago}
              `;
              historialPagos.appendChild(div);
            });
          }
        } else {
          historialPagos.innerHTML = "<div class='alert'>Este pr√©stamo no tiene cuotas registradas.</div>";
        }
      }
	async function limpiarSistema() {
  // Pedir credenciales mediante prompts (puedes mejorar esto con un modal si lo deseas)
  const usuario = prompt("üîí Para limpiar el sistema, ingrese el usuario administrador:");
  if (usuario === null) return; // Cancelado

  const password = prompt("üîí Ingrese la contrase√±a del administrador:");
  if (password === null) return; // Cancelado

  if (!usuario || !password) {
    alert("‚ùå Ambos campos son obligatorios.");
    return;
  }

  try {
    const hash = await hashPassword(password);
    const transaction = db.transaction(["usuarios"], "readonly");
    const store = transaction.objectStore("usuarios");
    const index = store.index("usuario");
    const request = index.get("admin"); // Solo permitimos al admin

    request.onsuccess = async function() {
      const admin = request.result;
      if (admin && admin.usuario === usuario && admin.password === hash) {
        // Credenciales correctas ‚Üí proceder con la limpieza
        if (!confirm("‚ö†Ô∏è ¬°ADVERTENCIA! Esta acci√≥n borrar√° TODOS los datos del sistema (cuentas, pr√©stamos, transacciones, etc.) de forma permanente. ¬øEst√° absolutamente seguro?")) {
          return;
        }

        if (db) db.close();
        const deleteRequest = indexedDB.deleteDatabase(dbName);
        deleteRequest.onsuccess = function() {
          console.log("Base de datos eliminada exitosamente.");
          alert("‚úÖ ¬°Sistema limpiado! Todos los datos han sido borrados. La p√°gina se recargar√°.");
          location.reload();
        };
        deleteRequest.onerror = function(event) {
          console.error("Error al eliminar la base de datos:", event);
          alert("‚ùå Error al intentar limpiar el sistema.");
        };
        deleteRequest.onblocked = function() {
          console.warn("La base de datos est√° bloqueada.");
          alert("‚ö†Ô∏è La base de datos est√° en uso. Cierre todas las pesta√±as y vuelva a intentarlo.");
        };
      } else {
        alert("‚ùå Credenciales incorrectas. Solo el administrador puede limpiar el sistema.");
      }
    };

    request.onerror = function() {
      alert("‚ùå Error al verificar credenciales del administrador.");
    };
  } catch (error) {
    console.error("Error en autenticaci√≥n para limpieza:", error);
    alert("‚ùå Error interno al validar credenciales.");
  }
}

// Funci√≥n para mostrar pesta√±as dentro del m√≥dulo de copia de seguridad
function mostrarTabBackup(tabName) {
  document.querySelectorAll("#backup .tab-content").forEach(t => t.classList.remove("active"));
  document.querySelectorAll("#backup .tab-btn").forEach(t => t.classList.remove("active"));
  document.getElementById(`tab-backup-${tabName}`).classList.add("active");
  const index = { exportar: 0, importar: 1 }[tabName];
  document.querySelectorAll("#backup .tab-btn")[index].classList.add("active");
}

// Funci√≥n para exportar toda la base de datos a un archivo JSON
async function exportarBackup() {
  const data = {};
  const stores = ["cuentas", "prestamos", "transacciones", "sesiones", "tarjetas", "usuarios", "tasas", "cheques"];
  
  for (const storeName of stores) {
    data[storeName] = [];
    const transaction = db.transaction([storeName], "readonly");
    const store = transaction.objectStore(storeName);
    const request = store.openCursor();
    
    const records = await new Promise((resolve) => {
      const results = [];
      request.onsuccess = function(e) {
        const cursor = e.target.result;
        if (cursor) {
          results.push(cursor.value);
          cursor.continue();
        } else {
          resolve(results);
        }
      };
      request.onerror = () => resolve([]);
    });
    data[storeName] = records;
  }

  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `simubank_backup_${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// Funci√≥n para importar un archivo JSON y restaurar la base de datos
async function importarBackup() {
  const fileInput = document.getElementById("archivo-backup");
  const resultadoDiv = document.getElementById("resultado-backup");
  if (!fileInput.files.length) {
    mostrarResultado("error", "‚ùå Seleccione un archivo JSON.", resultadoDiv);
    return;
  }

  const file = fileInput.files[0];
  if (!file.name.endsWith(".json")) {
    mostrarResultado("error", "‚ùå El archivo debe ser un JSON v√°lido.", resultadoDiv);
    return;
  }

  const reader = new FileReader();
  reader.onload = async function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (!confirm("‚ö†Ô∏è Esta acci√≥n reemplazar√° TODOS los datos actuales. ¬øDesea continuar?")) return;

      // Cerrar y eliminar la base actual
      db.close();
      const deleteReq = indexedDB.deleteDatabase(dbName);
      await new Promise((resolve, reject) => {
        deleteReq.onsuccess = resolve;
        deleteReq.onerror = reject;
      });

      // Recrear la base con la versi√≥n actual
      await initDB();

      // Restaurar cada store
      for (const [storeName, records] of Object.entries(data)) {
        if (!Array.isArray(records)) continue;
        const transaction = db.transaction([storeName], "readwrite");
        const store = transaction.objectStore(storeName);
        for (const record of records) {
          store.put(record);
        }
        await new Promise((resolve) => {
          transaction.oncomplete = resolve;
          transaction.onerror = () => resolve(); // Ignorar errores por inconsistencias
        });
      }

      mostrarResultado("success", "‚úÖ Copia de seguridad restaurada exitosamente. La p√°gina se recargar√°.", resultadoDiv);
      setTimeout(() => location.reload(), 2000);
    } catch (err) {
      console.error("Error al importar backup:", err);
      mostrarResultado("error", "‚ùå Error al procesar el archivo de respaldo.", resultadoDiv);
    }
  };
  reader.readAsText(file);
}      
      // =============================================
      // NUEVAS FUNCIONES PARA TASAS DE CAMBIO
      // =============================================
      
      // Cargar las tasas actuales desde el usuarioSesion y mostrarlas en la interfaz
      function cargarTasasActuales() {
        if (!usuarioSesion) return;
        
        // Actualizar tasas en el m√≥dulo de cambio de divisas
        document.getElementById("tasa-usd-compra-actual").textContent = usuarioSesion.tasaUsdCompra.toFixed(2);
        document.getElementById("tasa-usd-venta-actual").textContent = usuarioSesion.tasaUsdVenta.toFixed(2);
        document.getElementById("tasa-eur-compra-actual").textContent = usuarioSesion.tasaEurCompra.toFixed(2);
        document.getElementById("tasa-eur-venta-actual").textContent = usuarioSesion.tasaEurVenta.toFixed(2);
        
        // Cargar valores en el m√≥dulo de tasas
        document.getElementById("tasa-usd-compra-actualizar").value = usuarioSesion.tasaUsdCompra.toFixed(2);
        document.getElementById("tasa-usd-venta-actualizar").value = usuarioSesion.tasaUsdVenta.toFixed(2);
        document.getElementById("tasa-eur-compra-actualizar").value = usuarioSesion.tasaEurCompra.toFixed(2);
        document.getElementById("tasa-eur-venta-actualizar").value = usuarioSesion.tasaEurVenta.toFixed(2);
      }

function actualizarTasasEnHeader() {
  const tasasDiv = document.getElementById("tasas-header");
  if (!tasasDiv || !usuarioSesion) return;
  // Tasas de cambio: USD y EUR (compra y venta)
  const usdCompra = usuarioSesion.tasaUsdCompra?.toFixed(2) || "--";
  const usdVenta  = usuarioSesion.tasaUsdVenta?.toFixed(2)  || "--";
  const eurCompra = usuarioSesion.tasaEurCompra?.toFixed(2) || "--";
  const eurVenta  = usuarioSesion.tasaEurVenta?.toFixed(2)  || "--";
  // Tasas de inversi√≥n
  const invRD = window.tasasInversion?.["RD$"] !== undefined ? `RD$:${window.tasasInversion["RD$"].toFixed(2)}%` : "";
  const invUSD = window.tasasInversion?.["USD"] !== undefined ? `USD:${window.tasasInversion["USD"].toFixed(2)}%` : "";
  const invEUR = window.tasasInversion?.["EUR"] !== undefined ? `EUR:${window.tasasInversion["EUR"].toFixed(2)}%` : "";
  const tasasInversion = [invRD, invUSD, invEUR].filter(t => t).join(" ");

  tasasDiv.innerHTML = `
    <span class="moneda">USD C:${usdCompra} V:${usdVenta}</span> |
    <span class="euro">EUR C:${eurCompra} V:${eurVenta}</span> |
    <span class="inversion">Inv. ${tasasInversion || "‚Äì"}</span>
  `;
}

// Funci√≥n para verificar credenciales de administrador
async function verificarAdmin() {
  const usuario = prompt("üîí Ingrese el usuario de administrador:");
  if (usuario === null) return false; // Cancelado
  const password = prompt("üîí Ingrese la contrase√±a de administrador:");
  if (password === null) return false; // Cancelado

  if (usuario !== "admin") {
    alert("‚ùå Solo el usuario 'admin' puede modificar las tasas de cambio.");
    return false;
  }

  try {
    const hash = await hashPassword(password);
    const transaction = db.transaction(["usuarios"], "readonly");
    const store = transaction.objectStore("usuarios");
    const request = store.index("usuario").get("admin");
    return new Promise((resolve) => {
      request.onsuccess = function() {
        const admin = request.result;
        resolve(admin && admin.password === hash);
      };
      request.onerror = function() {
        alert("‚ùå Error al verificar credenciales.");
        resolve(false);
      };
    });
  } catch (error) {
    console.error("Error en verificaci√≥n de admin:", error);
    alert("‚ùå Error interno al validar credenciales.");
    return false;
  }
}


// Actualizar tasas de USD (con autenticaci√≥n de admin)
async function actualizarTasaUSD() {
  const tasaCompra = parseFloat(document.getElementById("tasa-usd-compra-actualizar").value);
  const tasaVenta = parseFloat(document.getElementById("tasa-usd-venta-actualizar").value);
  const resultadoDiv = document.getElementById("resultado-tasas");
	actualizarTasasEnHeader();

  // Validaciones b√°sicas
  if (isNaN(tasaCompra) || isNaN(tasaVenta)) {
    mostrarResultado("error", "‚ùå Por favor, ingrese valores num√©ricos v√°lidos para las tasas de USD.", resultadoDiv);
    return;
  }
  if (tasaCompra <= 0 || tasaVenta <= 0) {
    mostrarResultado("error", "‚ùå Las tasas deben ser mayores que cero.", resultadoDiv);
    return;
  }
  if (tasaCompra >= tasaVenta) {
    mostrarResultado("error", "‚ùå La tasa de compra debe ser menor que la tasa de venta.", resultadoDiv);
    return;
  }

  // üîê Verificar credenciales de administrador
  const esAdmin = await verificarAdmin();
  if (!esAdmin) {
    mostrarResultado("error", "‚ùå Autenticaci√≥n fallida. No se guardaron los cambios.", resultadoDiv);
    return;
  }

  // ‚úÖ Actualizar en el objeto de sesi√≥n
  usuarioSesion.tasaUsdCompra = tasaCompra;
  usuarioSesion.tasaUsdVenta = tasaVenta;

  // Guardar en la base de datos
  const transaction = db.transaction(["usuarios"], "readwrite");
  const store = transaction.objectStore("usuarios");
  const index = store.index("usuario");
  const request = index.get(usuarioSesion.usuario);
  request.onsuccess = function() {
    const user = request.result;
    if (user) {
      user.tasaUsdCompra = tasaCompra;
      user.tasaUsdVenta = tasaVenta;
      store.put(user);
      registrarHistorialTasa("USD", tasaCompra, tasaVenta, usuarioSesion.nombre);
      mostrarResultado("success", `‚úÖ Tasas de USD actualizadas correctamente:
Compra: ${tasaCompra.toFixed(2)}
Venta: ${tasaVenta.toFixed(2)}`, resultadoDiv);
      cargarTasasActuales();
      document.getElementById("tasa-usd-compra-actualizar").value = "";
      document.getElementById("tasa-usd-venta-actualizar").value = "";
    }
  };
  request.onerror = function() {
    mostrarResultado("error", "‚ùå Error al actualizar las tasas en la base de datos.", resultadoDiv);
  };
}

// Actualizar tasas de EUR (con autenticaci√≥n de admin)
async function actualizarTasaEUR() {
  const tasaCompra = parseFloat(document.getElementById("tasa-eur-compra-actualizar").value);
  const tasaVenta = parseFloat(document.getElementById("tasa-eur-venta-actualizar").value);
  const resultadoDiv = document.getElementById("resultado-tasas");
	
  // Validaciones b√°sicas
  if (isNaN(tasaCompra) || isNaN(tasaVenta)) {
    mostrarResultado("error", "‚ùå Por favor, ingrese valores num√©ricos v√°lidos para las tasas de EUR.", resultadoDiv);
    return;
  }
  if (tasaCompra <= 0 || tasaVenta <= 0) {
    mostrarResultado("error", "‚ùå Las tasas deben ser mayores que cero.", resultadoDiv);
    return;
  }
  if (tasaCompra >= tasaVenta) {
    mostrarResultado("error", "‚ùå La tasa de compra debe ser menor que la tasa de venta.", resultadoDiv);
    return;
  }

  // üîê Verificar credenciales de administrador
  const esAdmin = await verificarAdmin();
  if (!esAdmin) {
    mostrarResultado("error", "‚ùå Autenticaci√≥n fallida. No se guardaron los cambios.", resultadoDiv);
    return;
  }

  // ‚úÖ Actualizar en el objeto de sesi√≥n
  usuarioSesion.tasaEurCompra = tasaCompra;
  usuarioSesion.tasaEurVenta = tasaVenta;

  // Guardar en la base de datos
  const transaction = db.transaction(["usuarios"], "readwrite");
  const store = transaction.objectStore("usuarios");
  const index = store.index("usuario");
  const request = index.get(usuarioSesion.usuario);
  request.onsuccess = function() {
    const user = request.result;
    if (user) {
      user.tasaEurCompra = tasaCompra;
      user.tasaEurVenta = tasaVenta;
      store.put(user);
      registrarHistorialTasa("EUR", tasaCompra, tasaVenta, usuarioSesion.nombre);
      mostrarResultado("success", `‚úÖ Tasas de EUR actualizadas correctamente:
Compra: ${tasaCompra.toFixed(2)}
Venta: ${tasaVenta.toFixed(2)}`, resultadoDiv);
      cargarTasasActuales();
	actualizarTasasEnHeader();
      document.getElementById("tasa-eur-compra-actualizar").value = "";
      document.getElementById("tasa-eur-venta-actualizar").value = "";
    }
  };
  request.onerror = function() {
    mostrarResultado("error", "‚ùå Error al actualizar las tasas en la base de datos.", resultadoDiv);
  };
}   

      
      // Registrar una actualizaci√≥n de tasa en el historial
      function registrarHistorialTasa(divisa, compra, venta, cajero) {
        const transaccion = db.transaction(["tasas"], "readwrite");
        const store = transaccion.objectStore("tasas");
        
        const registro = {
          fecha: new Date().toISOString(),
          divisa: divisa,
          compra: compra,
          venta: venta,
          cajero: cajero
        };
        
        const request = store.add(registro);
        request.onsuccess = function() {
          console.log("Registro de tasa guardado en historial:", registro);
        };
        request.onerror = function() {
          console.error("Error al guardar registro de tasa:", request.error);
        };
      }
      
      // Cargar el historial de tasas
      function cargarHistorialTasas() {
        const historialDiv = document.getElementById("historial-tasas");
        historialDiv.innerHTML = "<p>Cargando historial...</p>";
        
        const transaction = db.transaction(["tasas"], "readonly");
        const store = transaction.objectStore("tasas");
        const request = store.openCursor();
        
        let registros = [];
        
        request.onsuccess = function(e) {
          const cursor = e.target.result;
          if (cursor) {
            registros.push(cursor.value);
            cursor.continue();
          } else {
            // Ordenar por fecha descendente (m√°s recientes primero)
            registros.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            // Mostrar los √∫ltimos 10 registros
            historialDiv.innerHTML = "";
            const limite = Math.min(10, registros.length);
            
            if (registros.length === 0) {
              historialDiv.innerHTML = "<p>No hay registros de cambios de tasas.</p>";
            } else {
              const ul = document.createElement("ul");
              ul.style.listStyleType = "none";
              ul.style.padding = "0";
              
              for (let i = 0; i < limite; i++) {
                const registro = registros[i];
                const fecha = new Date(registro.fecha).toLocaleString();
                
                const li = document.createElement("li");
                li.style.padding = "10px";
                li.style.margin = "5px 0";
                li.style.backgroundColor = "#f8f9fa";
                li.style.borderRadius = "5px";
                li.style.borderLeft = "4px solid #0056b3";
                
                let divisa = registro.divisa === "USD" ? "D√≥lar Estadounidense" : "Euro";
                li.innerHTML = `
                  <strong>${divisa}</strong><br>
                  <small>${fecha}</small><br>
                  <strong>Compr√≥:</strong> ${registro.compra.toFixed(2)} | <strong>Vendi√≥:</strong> ${registro.venta.toFixed(2)}<br>
                  <small>Por: ${registro.cajero}</small>
                `;
                ul.appendChild(li);
              }
              
              historialDiv.appendChild(ul);
            }
          }
        };
        
        request.onerror = function() {
          historialDiv.innerHTML = "<p>Error al cargar el historial de tasas.</p>";
        };
      }

// Guardar tasa global de inversi√≥n
function guardarTasaInversion() {
  const tasaGlobal = parseFloat(document.getElementById("tasa-inversion-global").value);
  const moneda = document.getElementById("moneda-tasa-inversion").value;
  const resultadoDiv = document.getElementById("resultado-tasa-inversion");
	actualizarTasasEnHeader();

  if (isNaN(tasaGlobal) || tasaGlobal <= 0) {
    mostrarResultado("error", "‚ùå La tasa debe ser un valor positivo.", resultadoDiv);
    return;
  }

  // Guardar en memoria
  if (!window.tasasInversion) window.tasasInversion = {};
  window.tasasInversion[moneda] = tasaGlobal;

  // ‚úÖ ACTUALIZAR EL CAMPO DEL FORMULARIO SI LA MONEDA COINCIDE
  const formularioActivo = document.getElementById("tab-inversion-apertura").classList.contains("active");
  const monedaFormulario = document.getElementById("moneda-inversion")?.value;
  const campoTasaForm = document.getElementById("tasa-interes");

  if (formularioActivo && campoTasaForm && monedaFormulario === moneda) {
    campoTasaForm.value = tasaGlobal;
  }

  mostrarResultado("success", `‚úÖ Tasa global para ${moneda} guardada: ${tasaGlobal}%`, resultadoDiv);
actualizarTasasEnHeader();
}
      
      // Funci√≥n para generar el informe diario
async function generarInformeDiario() {
  const hoy = new Date().toLocaleDateString();
  let totalDepositos = 0, totalRetiros = 0, totalPagos = 0, totalCambios = 0, totalCobrosPrestamos = 0;
  let totalDebitosTarjeta = 0, totalCobrosTarjeta = 0, totalTransferencias = 0;

  // Obtener todas las transacciones del d√≠a
  const transaction = db.transaction(["transacciones"], "readonly");
  const store = transaction.objectStore("transacciones");
  const request = store.openCursor();
  const transaccionesHoy = [];

  request.onsuccess = function(e) {
    const cursor = e.target.result;
    if (cursor) {
      const t = cursor.value;
      if (t.fecha.includes(hoy)) {
        transaccionesHoy.push(t);
        switch (t.tipo) {
          case "Dep√≥sito":
            totalDepositos += t.monto;
            break;
          case "Retiro":
            totalRetiros += t.monto;
            break;
          case "Pago de Servicio":
            totalPagos += t.monto;
            break;
          case "Cambio de Divisa":
            totalCambios += t.monto;
            break;
          case "Cobro de Pr√©stamo":
            totalCobrosPrestamos += t.monto;
            break;
          case "D√©bito Tarjeta":
            totalDebitosTarjeta += t.monto;
            break;
          case "Cobro Tarjeta":
            totalCobrosTarjeta += t.monto;
            break;
          case "Transferencia":
            totalTransferencias += t.monto;
            break;
        }
      }
      cursor.continue();
    } else {
      // Mostrar resultados
      const contenidoDiv = document.getElementById("contenido-informe-diario");
      contenidoDiv.innerHTML = `
        <p><strong>Fecha del Informe:</strong> ${hoy}</p>
        <p><strong>Total Dep√≥sitos:</strong> RD$ ${totalDepositos.toFixed(2)}</p>
        <p><strong>Total Retiros:</strong> RD$ ${totalRetiros.toFixed(2)}</p>
        <p><strong>Total Pagos de Servicios:</strong> RD$ ${totalPagos.toFixed(2)}</p>
        <p><strong>Total Cambios de Divisa:</strong> RD$ ${totalCambios.toFixed(2)}</p>
        <p><strong>Total Cobros de Pr√©stamos:</strong> RD$ ${totalCobrosPrestamos.toFixed(2)}</p>
        <p><strong>Total D√©bitos de Tarjeta:</strong> RD$ ${totalDebitosTarjeta.toFixed(2)}</p>
        <p><strong>Total Cobros de Tarjeta:</strong> RD$ ${totalCobrosTarjeta.toFixed(2)}</p>
        <p><strong>Total Transferencias:</strong> RD$ ${totalTransferencias.toFixed(2)}</p>
        <hr>
        <p><strong>Balance Neto del D√≠a (Dep√≥sitos - Retiros):</strong> RD$ ${(totalDepositos - totalRetiros).toFixed(2)}</p>
      `;
      document.getElementById("resultado-informe-diario").classList.remove("hidden");
    }
  };
}

// Funci√≥n para generar informe de pr√©stamos
function generarInformePrestamos() {
  const estado = document.getElementById("filtro-estado-prestamo").value;
  const tipo = document.getElementById("filtro-tipo-prestamo").value;

  const transaction = db.transaction(["prestamos"], "readonly");
  const store = transaction.objectStore("prestamos");
  const request = store.openCursor();
  const prestamosFiltrados = [];

  request.onsuccess = function(e) {
    const cursor = e.target.result;
    if (cursor) {
      const p = cursor.value;
      const cumpleEstado = estado === "todos" || p.estado === estado;
      const cumpleTipo = tipo === "todos" || p.tipo === tipo;
      if (cumpleEstado && cumpleTipo) {
        prestamosFiltrados.push(p);
      }
      cursor.continue();
    } else {
      const contenidoDiv = document.getElementById("contenido-informe-prestamos");
      if (prestamosFiltrados.length === 0) {
        contenidoDiv.innerHTML = "<p>No se encontraron pr√©stamos con los filtros seleccionados.</p>";
      } else {
        let html = `<p><strong>Total de Pr√©stamos Encontrados:</strong> ${prestamosFiltrados.length}</p>`;
        html += `<p><strong>Monto Total Solicitado:</strong> RD$ ${prestamosFiltrados.reduce((sum, p) => sum + p.monto, 0).toFixed(2)}</p>`;
        html += `<p><strong>Monto Total Pendiente:</strong> RD$ ${prestamosFiltrados.reduce((sum, p) => sum + p.saldoPendiente, 0).toFixed(2)}</p>`;
        html += "<h4>Lista de Pr√©stamos</h4>";
        html += "<ul style='list-style-type: none; padding: 0;'>";
        prestamosFiltrados.forEach(p => {
          html += `
            <li style='padding: 10px; margin: 5px 0; background: #f8f9fa; border-radius: 5px;'>
              <strong>C√≥digo:</strong> ${p.codigo} | <strong>Cliente:</strong> ${p.nombre}<br>
              <strong>Tipo:</strong> ${p.tipo} | <strong>Estado:</strong> ${p.estado}<br>
              <strong>Monto:</strong> RD$ ${p.monto.toFixed(2)} | <strong>Saldo Pendiente:</strong> RD$ ${p.saldoPendiente.toFixed(2)}
            </li>
          `;
        });
        html += "</ul>";
        contenidoDiv.innerHTML = html;
      }
      document.getElementById("resultado-informe-prestamos").classList.remove("hidden");
    }
  };
}

// Funci√≥n para generar informe de tarjetas
function generarInformeTarjetas() {
  const estado = document.getElementById("filtro-estado-tarjeta").value;
  const tipo = document.getElementById("filtro-tipo-tarjeta").value;

  const transaction = db.transaction(["tarjetas"], "readonly");
  const store = transaction.objectStore("tarjetas");
  const request = store.openCursor();
  const tarjetasFiltradas = [];

  request.onsuccess = function(e) {
    const cursor = e.target.result;
    if (cursor) {
      const t = cursor.value;
      const cumpleEstado = estado === "todos" || t.estado === estado;
      const cumpleTipo = tipo === "todos" || t.tipo === tipo;
      if (cumpleEstado && cumpleTipo) {
        tarjetasFiltradas.push(t);
      }
      cursor.continue();
    } else {
      const contenidoDiv = document.getElementById("contenido-informe-tarjetas");
      if (tarjetasFiltradas.length === 0) {
        contenidoDiv.innerHTML = "<p>No se encontraron tarjetas con los filtros seleccionados.</p>";
      } else {
        let html = `<p><strong>Total de Tarjetas Encontradas:</strong> ${tarjetasFiltradas.length}</p>`;
        html += `<p><strong>L√≠mite de Cr√©dito Total:</strong> RD$ ${tarjetasFiltradas.reduce((sum, t) => sum + t.limite, 0).toFixed(2)}</p>`;
        html += `<p><strong>Saldo Total Utilizado:</strong> RD$ ${tarjetasFiltradas.reduce((sum, t) => sum + (t.saldo || 0), 0).toFixed(2)}</p>`;
        html += "<h4>Lista de Tarjetas</h4>";
        html += "<ul style='list-style-type: none; padding: 0;'>";
        tarjetasFiltradas.forEach(t => {
          html += `
            <li style='padding: 10px; margin: 5px 0; background: #f8f9fa; border-radius: 5px;'>
              <strong>N√∫mero:</strong> ${t.numero.match(/.{1,4}/g).join(' ')}<br>
              <strong>Titular:</strong> ${t.nombreTitular}<br>
              <strong>Tipo:</strong> ${t.tipo} | <strong>Estado:</strong> ${t.estado}<br>
              <strong>L√≠mite:</strong> RD$ ${t.limite.toFixed(2)} | <strong>Saldo:</strong> RD$ ${(t.saldo || 0).toFixed(2)}
            </li>
          `;
        });
        html += "</ul>";
        contenidoDiv.innerHTML = html;
      }
      document.getElementById("resultado-informe-tarjetas").classList.remove("hidden");
    }
  };
}

// Funci√≥n para generar informe de transacciones
function generarInformeTransacciones() {
  const tipo = document.getElementById("filtro-tipo-transaccion").value;
  const moneda = document.getElementById("filtro-moneda-transaccion").value;
  const fechaDesde = document.getElementById("fecha-desde").value;
  const fechaHasta = document.getElementById("fecha-hasta").value;

  const transaction = db.transaction(["transacciones"], "readonly");
  const store = transaction.objectStore("transacciones");
  const request = store.openCursor();
  const transaccionesFiltradas = [];

  request.onsuccess = function(e) {
    const cursor = e.target.result;
    if (cursor) {
      const t = cursor.value;
      let incluir = true;

      // Filtro por tipo
      if (tipo !== "todos" && t.tipo !== tipo) incluir = false;
      // Filtro por moneda
      if (moneda !== "todos" && t.moneda !== moneda) incluir = false;
      // Filtro por fecha
      if (fechaDesde && new Date(t.fecha) < new Date(fechaDesde)) incluir = false;
      if (fechaHasta && new Date(t.fecha) > new Date(fechaHasta)) incluir = false;

      if (incluir) transaccionesFiltradas.push(t);
      cursor.continue();
    } else {
      const tbody = document.getElementById("cuerpo-tabla-informe-transacciones");
      tbody.innerHTML = "";

      if (transaccionesFiltradas.length === 0) {
        tbody.innerHTML = "<tr><td colspan='5'>No se encontraron transacciones con los filtros seleccionados.</td></tr>";
      } else {
        transaccionesFiltradas.forEach(t => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${t.fecha}</td>
            <td>${t.tipo}</td>
            <td>${t.monto.toFixed(2)}</td>
            <td>${t.moneda}</td>
            <td>${t.referencia}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      document.getElementById("resultado-informe-transacciones").classList.remove("hidden");
      document.getElementById("btn-exportar-csv").style.display = transaccionesFiltradas.length > 0 ? "block" : "none";
      window.transaccionesParaExportar = transaccionesFiltradas; // Guardar para exportar
    }
  };
}

// Funci√≥n para exportar el informe de transacciones a CSV
function exportarInformeTransaccionesCSV() {
  if (!window.transaccionesParaExportar || window.transaccionesParaExportar.length === 0) {
    alert("No hay datos para exportar.");
    return;
  }

  let csv = "Fecha,Tipo,Monto,Moneda,Referencia\n";
  window.transaccionesParaExportar.forEach(t => {
    csv += `"${t.fecha}","${t.tipo}","${t.monto.toFixed(2)}","${t.moneda}","${t.referencia}"\n`;
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `informe_transacciones_${new Date().toISOString().slice(0,10)}.csv`;
  link.click();
}

function mostrarTabCuentas(tabName) {
  document.querySelectorAll("#gestion-cuentas .tab-content").forEach(t => t.classList.remove("active"));
  document.querySelectorAll("#gestion-cuentas .tab-btn").forEach(t => t.classList.remove("active"));
  document.getElementById(`tab-cuenta-${tabName}`).classList.add("active");
  const index = {apertura:0, deposito:1, retiro:2, consulta:3, historial:4, transferencia:5, 'estado-cuenta':6, reposicion:7}[tabName];
  const btns = document.querySelectorAll("#gestion-cuentas .tab-btn");
  if (btns[index]) btns[index].classList.add("active");
}

// Funci√≥n para generar e imprimir el estado de cuenta
function generarEstadoCuenta() {
  const cuenta = document.getElementById("cuenta-estado").value.trim();
  const fechaDesdeStr = document.getElementById("fecha-desde-estado").value;
  const fechaHastaStr = document.getElementById("fecha-hasta-estado").value;
  const resultadoDiv = document.getElementById("resultado-estado-cuenta");

  if (!cuenta) {
    mostrarResultado("error", "‚ùå Ingrese el n√∫mero de cuenta.", resultadoDiv);
    return;
  }
  if (!fechaDesdeStr || !fechaHastaStr) {
    mostrarResultado("error", "‚ùå Seleccione ambas fechas.", resultadoDiv);
    return;
  }
  if (new Date(fechaDesdeStr) > new Date(fechaHastaStr)) {
    mostrarResultado("error", "‚ùå La fecha 'desde' no puede ser mayor que 'hasta'.", resultadoDiv);
    return;
  }

  // Buscar datos del titular
  const cuentaTrans = db.transaction(["cuentas"], "readonly");
  const cuentaStore = cuentaTrans.objectStore("cuentas");
  const cuentaIndex = cuentaStore.index("numeroCuenta");
  const cuentaReq = cuentaIndex.get(cuenta);
  cuentaReq.onsuccess = function() {
    const cuentaData = cuentaReq.result;
    if (!cuentaData) {
      mostrarResultado("error", "‚ùå Cuenta no encontrada.", resultadoDiv);
      return;
    }

    // Convertir fechas de entrada a objetos Date al inicio del d√≠a
    const fechaDesde = new Date(fechaDesdeStr);
    fechaDesde.setHours(0, 0, 0, 0);
    const fechaHasta = new Date(fechaHastaStr);
    fechaHasta.setHours(23, 59, 59, 999);

    // Filtrar transacciones por cuenta Y rango de fechas (comparando Date correctamente)
    const transaccionesFiltradas = transacciones.filter(t => {
  if (t.cuenta !== cuenta) return false;
  const partes = t.fecha.split(",")[0].trim(); // Ej: "23/10/2025"
  const fechaTrans = parsearFechaDDMMYYYY(partes);
  if (!fechaTrans || isNaN(fechaTrans.getTime())) return false;
  return fechaTrans >= fechaDesde && fechaTrans <= fechaHasta;
});

    // Calcular saldo inicial: buscar transacciones ANTERIORES a fechaDesde
    const transaccionesAntes = transacciones.filter(t => {
      if (t.cuenta !== cuenta) return false;
      const partes = t.fecha.split(",")[0].trim();
      const fechaTrans = new Date(partes);
      return !isNaN(fechaTrans.getTime()) && fechaTrans < fechaDesde;
    });
    let saldoInicial = cuentaData.saldo;
    transaccionesAntes.forEach(t => {
      if (t.tipo === "Dep√≥sito") saldoInicial -= t.monto;
      else if (t.tipo === "Retiro" || t.tipo === "Transferencia") saldoInicial += t.monto;
    });

    // Generar filas del estado de cuenta con saldo evolutivo
    let contenido = `
      <h2>Estado de Cuenta</h2>
      <p><strong>Cliente:</strong> ${cuentaData.nombre}</p>
      <p><strong>Cuenta:</strong> ${cuentaData.numeroCuenta} (${cuentaData.moneda})</p>
      <p><strong>Periodo:</strong> ${fechaDesde.toLocaleDateString()} - ${fechaHasta.toLocaleDateString()}</p>
      <hr>
      <table border="1" cellpadding="6" cellspacing="0" style="width:100%; border-collapse: collapse;">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Descripci√≥n</th>
            <th>Dep√≥sitos (${cuentaData.moneda})</th>
            <th>Retiros (${cuentaData.moneda})</th>
            <th>Saldo (${cuentaData.moneda})</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="4"><strong>Saldo Inicial</strong></td>
            <td style="text-align:right;"><strong>${saldoInicial.toFixed(2)}</strong></td>
          </tr>
    `;

    let saldoActual = saldoInicial;
    if (transaccionesFiltradas.length === 0) {
      contenido += `<tr><td colspan="5" style="text-align:center;">No hay movimientos en este periodo.</td></tr>`;
    } else {
      transaccionesFiltradas.forEach(t => {
        let deposito = "", retiro = "";
        if (t.tipo === "Dep√≥sito") {
          deposito = t.monto.toFixed(2);
          saldoActual += t.monto;
        } else if (t.tipo === "Retiro" || t.tipo === "Transferencia") {
          retiro = t.monto.toFixed(2);
          saldoActual -= t.monto;
        } else {
          // Otras transacciones (ej: pagos) se tratan como retiros
          retiro = t.monto.toFixed(2);
          saldoActual -= t.monto;
        }
        contenido += `
          <tr>
            <td>${t.fecha.split(",")[0]}</td>
            <td>${t.referencia}</td>
            <td style="text-align:right;">${deposito}</td>
            <td style="text-align:right;">${retiro}</td>
            <td style="text-align:right;">${saldoActual.toFixed(2)}</td>
          </tr>
        `;
      });
    }

    contenido += `
        </tbody>
      </table>
      <p style="margin-top:20px;"><strong>Saldo Final:</strong> ${cuentaData.moneda} ${saldoActual.toFixed(2)}</p>
    `;

    // Abrir en nueva ventana para impresi√≥n
    const ventana = window.open("", "Estado de Cuenta", "width=800,height=600");
    ventana.document.write(`
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <title>Estado de Cuenta - ${cuenta}</title>
        <style>
          body { font-family: Arial, sans-serif; padding: 20px; }
          table { width: 100%; border-collapse: collapse; margin: 15px 0; }
          th, td { border: 1px solid #333; padding: 8px; text-align: left; }
          th { background-color: #f2f2f2; }
          h2 { color: #003366; }
          td { text-align: right; }
          td:first-child, td:nth-child(2) { text-align: left; }
        </style>
      </head>
      <body>
        ${contenido}
        <button onclick="window.print()" style="margin-top:20px;padding:8px 16px;background:#0056b3;color:white;border:none;border-radius:4px;">üñ®Ô∏è Imprimir</button>
      </body>
      </html>
    `);
    ventana.document.close();
    mostrarResultado("success", "‚úÖ Estado de cuenta generado. Revise la nueva ventana.", resultadoDiv);
  };
  cuentaReq.onerror = function() {
    mostrarResultado("error", "‚ùå Error al buscar la cuenta.", resultadoDiv);
  };
}

function mostrarTarjetaDesdeURL() {
  const hash = window.location.hash;
  if (hash.startsWith("#tarjeta=")) {
    try {
      const datosB64 = hash.substring(9); // "#tarjeta=".length = 9
      const json = atob(decodeURIComponent(datosB64));
      const datos = JSON.parse(json);

      // Crear vista de tarjeta en una nueva ventana/p√°gina
      const html = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1">
          <title>Tarjeta - Simubank</title>
          <style>
            body { font-family: Arial, sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; background: #f0f2f5; }
            .tarjeta {
              width: 320px;
              height: 200px;
              border-radius: 15px;
              padding: 20px;
              color: white;
              position: relative;
              box-shadow: 0 8px 20px rgba(0,0,0,0.2);
              font-size: 14px;
            }
            .tarjeta.clasica { background: linear-gradient(135deg, #1e3c72, #2a5298); }
            .tarjeta.oro { background: linear-gradient(135deg, #d4af37, #f9d71c); color: #1a1a1a; }
            .tarjeta.platino { background: linear-gradient(135deg, #c0c0c0, #e6e6e6); color: #1a1a1a; }
            .chip { width: 50px; height: 40px; background: #ccc; border-radius: 8px; float: right; }
            .logo-tarjeta { position: absolute; bottom: 20px; right: 20px; font-weight: bold; font-size: 1.5em; }
            .tarjeta-numero { letter-spacing: 2px; font-family: monospace; font-size: 1.4em; margin: 10px 0; }
            .tarjeta-info { display: flex; justify-content: space-between; margin-top: 30px; font-size: 0.9em; }
          </style>
        </head>
        <body>
          <div class="tarjeta ${datos.tipo.toLowerCase()}">
            <div class="chip"></div>
            <h3>Tarjeta Simubank</h3>
            <div class="tarjeta-numero">${datos.numero}</div>
            <div class="tarjeta-info">
              <div><strong>Titular:</strong><br>${datos.titular}</div>
              <div><strong>Vencimiento:</strong><br>${datos.vencimiento}</div>
            </div>
            <div class="logo-tarjeta">${datos.marca}</div>
          </div>
        </body>
        </html>
      `;
      document.open();
      document.write(html);
      document.close();
    } catch (e) {
      alert("‚ùå No se pudo cargar la tarjeta.");
    }
  }
}
	window.onload = async function() {
        if (!window.indexedDB) {
          alert("Tu navegador no soporta IndexedDB.");
          return;
        }
        try {
          await initDB();
          await initUsuarios();
          console.log("IndexedDB inicializada correctamente.");
        } catch (error) {
          alert("Error al inicializar la base de datos. Revisa la consola.");
          console.error("Error de IndexedDB:", error);
        }
      };

async function exportarDashboardPDF() {
  const dashboard = document.getElementById("dashboard");
  if (!dashboard) {
    alert("‚ùå No se encontr√≥ el contenedor del dashboard.");
    return;
  }

  try {
    // Capturar el dashboard como imagen
    const canvas = await html2canvas(dashboard, {
      scale: 2, // Mejor calidad
      useCORS: true,
      allowTaint: true
    });

    // Crear PDF
    const { jsPDF } = window.jspdf;
    const imgData = canvas.toDataURL("image/png");
    const pdf = new jsPDF({
      orientation: 'landscape',
      unit: 'mm',
      format: 'a4'
    });

    const imgWidth = 297; // ancho A4 en mm (landscape)
    const pageHeight = 210; // alto A4 en mm
    const imgHeight = (canvas.height * imgWidth) / canvas.width;

    let heightLeft = imgHeight;
    let position = 0;

    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
    heightLeft -= pageHeight;

    // Si el contenido es m√°s alto que una p√°gina, a√±ade nuevas p√°ginas
    while (heightLeft >= 0) {
      position = heightLeft - imgHeight;
      pdf.addPage();
      pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;
    }

    // Guardar PDF
    pdf.save(`dashboard_simubank_${new Date().toISOString().slice(0, 10)}.pdf`);

  } catch (error) {
    console.error("Error al exportar el dashboard a PDF:", error);
    alert("‚ùå Error al generar el PDF. Verifique la conexi√≥n o recargue la p√°gina.");
  }
}

// Funci√≥n para exportar el Informe Diario a PDF
function exportarInformeDiarioPDF() {
  const contenido = document.getElementById("contenido-informe-diario");
  if (!contenido || contenido.children.length === 0) {
    alert("Primero debe generar el informe diario.");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(16);
  doc.text("Informe Diario de Operaciones", 14, 20);
  doc.setFontSize(12);
  let y = 30;
  const lines = contenido.innerText.split("\n");
  lines.forEach(line => {
    if (y > 280) {
      doc.addPage();
      y = 20;
    }
    doc.text(line, 14, y);
    y += 8;
  });

  doc.save(`informe_diario_${new Date().toISOString().slice(0, 10)}.pdf`);
}

// Funci√≥n para descargar todas las tarjetas aprobadas en un PDF
async function descargarTarjetasAprobadasPDF() {
  const { jsPDF } = window.jspdf;

  // Obtener todas las tarjetas aprobadas
  const trans = db.transaction(["tarjetas"], "readonly");
  const store = trans.objectStore("tarjetas");
  const index = store.index("estado");
  const request = index.getAll("Aprobada");

  const tarjetas = await new Promise((resolve) => {
    request.onsuccess = () => resolve(request.result || []);
    request.onerror = () => resolve([]);
  });

  if (tarjetas.length === 0) {
    alert("‚ùå No hay tarjetas aprobadas para exportar.");
    return;
  }

  const doc = new jsPDF({
    orientation: 'landscape',
    unit: 'mm',
    format: 'a4'
  });

  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  const cardWidth = 85; // mm (aprox. tama√±o de tarjeta real)
  const cardHeight = 53;
  const margin = 10;
  const cols = 2;
  const rows = 4;

  let x, y, col, row;

  tarjetas.forEach((tarjeta, i) => {
    if (i > 0 && i % (cols * rows) === 0) {
      doc.addPage();
    }

    col = (i % cols);
    row = Math.floor((i % (cols * rows)) / cols);

    x = margin + col * (cardWidth + margin);
    y = margin + row * (cardHeight + margin);

    // Determinar color seg√∫n tipo
    let bgColor1, bgColor2, textColor;
    if (tarjeta.tipo === "Oro") {
      bgColor1 = [212, 175, 55]; // Dorado
      bgColor2 = [249, 215, 28];
      textColor = [26, 26, 26];
    } else if (tarjeta.tipo === "Platino") {
      bgColor1 = [192, 192, 192]; // Plata
      bgColor2 = [230, 230, 230];
      textColor = [26, 26, 26];
    } else {
      bgColor1 = [30, 60, 114]; // Azul cl√°sico
      bgColor2 = [42, 82, 152];
      textColor = [255, 255, 255];
    }

    // Dibujar fondo degradado aproximado (jsPDF no soporta gradientes reales, as√≠ que usamos un rect√°ngulo s√≥lido)
    doc.setFillColor(...bgColor1);
    doc.rect(x, y, cardWidth, cardHeight, 'F');

    // Estilo de texto
    doc.setTextColor(...textColor);
    doc.setFont("helvetica", "bold");
    doc.setFontSize(14);
    doc.text("TARJETA SIMUBANK", x + 5, y + 12);

    // Chip simulado (cuadrado gris)
    if (tarjeta.tipo !== "Cl√°sica") {
      doc.setFillColor(200, 200, 200);
      doc.rect(x + cardWidth - 20, y + 5, 15, 10, 'F');
    } else {
      doc.setFillColor(200, 200, 200);
      doc.rect(x + cardWidth - 18, y + 6, 12, 8, 'F');
    }

    // N√∫mero de tarjeta (con m√°scara)
    const numMask = "**** **** **** " + (tarjeta.numero.slice(-4));
    doc.setFontSize(12);
    doc.text(numMask, x + 5, y + 25);

    // Titular
    doc.setFontSize(10);
    doc.text("TITULAR:", x + 5, y + 32);
    doc.setFont("helvetica", "normal");
    doc.text(tarjeta.nombreTitular.toUpperCase(), x + 5, y + 37);

    // Vencimiento
    doc.setFont("helvetica", "bold");
    doc.text("VENCIMIENTO:", x + 5, y + 44);
    doc.setFont("helvetica", "normal");
    doc.text(tarjeta.vencimiento, x + 5, y + 49);

    // Logo (VISA/MASTERCARD simulado)
    doc.setFont("helvetica", "bold");
    doc.setFontSize(16);
    doc.text("VISA", x + cardWidth - 20, y + cardHeight - 5);
  });

  doc.save(`tarjetas_aprobadas_${new Date().toISOString().slice(0, 10)}.pdf`);
}

// Funci√≥n para exportar el Informe de Pr√©stamos a PDF
function exportarInformePrestamosPDF() {
  const contenido = document.getElementById("contenido-informe-prestamos");
  if (!contenido || contenido.children.length === 0) {
    alert("Primero debe generar el informe de pr√©stamos.");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(16);
  doc.text("Informe de Pr√©stamos", 14, 20);
  doc.setFontSize(12);
  let y = 30;
  const text = contenido.innerText;
  const lines = doc.splitTextToSize(text, 180); // Ajusta al ancho de la p√°gina
  lines.forEach(line => {
    if (y > 280) {
      doc.addPage();
      y = 20;
    }
    doc.text(line, 14, y);
    y += 8;
  });

  doc.save(`informe_prestamos_${new Date().toISOString().slice(0, 10)}.pdf`);
}

// Funci√≥n para exportar el Informe de Tarjetas a PDF
function exportarInformeTarjetasPDF() {
  const contenido = document.getElementById("contenido-informe-tarjetas");
  if (!contenido || contenido.children.length === 0) {
    alert("Primero debe generar el informe de tarjetas.");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(16);
  doc.text("Informe de Tarjetas de Cr√©dito", 14, 20);
  doc.setFontSize(12);
  let y = 30;
  const text = contenido.innerText;
  const lines = doc.splitTextToSize(text, 180);
  lines.forEach(line => {
    if (y > 280) {
      doc.addPage();
      y = 20;
    }
    doc.text(line, 14, y);
    y += 8;
  });

  doc.save(`informe_tarjetas_${new Date().toISOString().slice(0, 10)}.pdf`);
}

// Funci√≥n para exportar el Informe de Transacciones a PDF
function exportarInformeTransaccionesPDF() {
  const tbody = document.getElementById("cuerpo-tabla-informe-transacciones");
  if (!tbody || !window.transaccionesParaExportar || window.transaccionesParaExportar.length === 0) {
    alert("No hay datos para exportar. Genere el informe primero.");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(16);
  doc.text("Informe Detallado de Transacciones", 14, 20);
  doc.setFontSize(10);
  let y = 30;

  // Encabezados

  doc.text("Fecha", 14, y);
  doc.text("Tipo", 50, y);
  doc.text("Monto", 100, y);
  doc.text("Moneda", 130, y);
  doc.text("Referencia", 150, y);
  y += 8;
  doc.line(10, y, 200, y); // L√≠nea separadora
  y += 4;

  window.transaccionesParaExportar.forEach(t => {
    if (y > 280) {
      doc.addPage();
      y = 20;
    }
    doc.text(t.fecha || "", 14, y);
    doc.text(t.tipo || "", 50, y);
    doc.text(t.monto.toFixed(2), 100, y);
    doc.text(t.moneda || "", 130, y);
    doc.text(t.referencia || "", 150, y);
    y += 6;
  });

  doc.save(`informe_transacciones_${new Date().toISOString().slice(0, 10)}.pdf`);
}
// Funci√≥n para mostrar pesta√±as de cheques
function mostrarTabCheque(tabName) {
  document.querySelectorAll("#cheques .tab-content").forEach(t => t.classList.remove("active"));
  document.querySelectorAll("#cheques .tab-btn").forEach(t => t.classList.remove("active"));
  document.getElementById(`tab-cheque-${tabName}`).classList.add("active");
  const index = {generar:0, cambiar:1, consulta:2, 'cambiar-externo':3}[tabName];
  document.querySelectorAll("#cheques .tab-btn")[index].classList.add("active");
}

// Generar n√∫mero de cheque √∫nico
async function generarNumeroCheque() {
  return new Promise((resolve) => {
    const trans = db.transaction(["cheques"], "readonly");
    const store = trans.objectStore("cheques");
    const request = store.count();
    request.onsuccess = function() {
      const next = request.result + 1;
      resolve(`SBCH${String(next).padStart(4, '0')}`);
    };
  });
}

// Formulario: Generar cheque
document.getElementById("form-generar-cheque").addEventListener("submit", async function(e) {
  e.preventDefault();
  const cuenta = document.getElementById("cuenta-cheque-generar").value.trim();
  const beneficiario = document.getElementById("beneficiario-cheque").value.trim();
  const monto = parseFloat(document.getElementById("monto-cheque").value);
  const concepto = document.getElementById("concepto-cheque").value.trim() || "‚Äî";
  const resultadoDiv = document.getElementById("resultado-generar-cheque");
  const vistaCheque = document.getElementById("vista-cheque");

  if (!cuenta || !beneficiario || isNaN(monto) || monto <= 0) {
    mostrarResultado("error", "‚ùå Complete todos los campos correctamente.", resultadoDiv);
    return;
  }

  // Verificar que la cuenta sea tipo "corriente"
  const cuentaTrans = db.transaction(["cuentas"], "readonly");
  const cuentaStore = cuentaTrans.objectStore("cuentas");
  const cuentaIndex = cuentaStore.index("numeroCuenta");
  const cuentaReq = cuentaIndex.get(cuenta);
  cuentaReq.onsuccess = async function() {
    const cuentaData = cuentaReq.result;
    if (!cuentaData) {
      mostrarResultado("error", "‚ùå Cuenta no encontrada.", resultadoDiv);
      return;
    }
    if (cuentaData.tipoCuenta !== "corriente") {
      mostrarResultado("error", "‚ùå Solo se pueden emitir cheques desde cuentas corrientes.", resultadoDiv);
      return;
    }
    if (cuentaData.saldo < monto) {
      mostrarResultado("error", `‚ùå Saldo insuficiente. Saldo actual: RD$ ${cuentaData.saldo.toFixed(2)}`, resultadoDiv);
      return;
    }

    // Generar n√∫mero de cheque
    const numeroCheque = await generarNumeroCheque();

    // Crear registro de cheque
    const cheque = {
      numero: numeroCheque,
      cuentaOrigen: cuenta,
      beneficiario,
      monto,
      concepto,
      fecha: new Date().toISOString(),
      estado: "emitido",
      cobradoPor: null,
      fechaCobro: null
    };

    // Guardar en base de datos
    const trans = db.transaction(["cheques"], "readwrite");
    const store = trans.objectStore("cheques");
    store.add(cheque);
    trans.oncomplete = function() {
      // Mostrar vista previa
      document.getElementById("num-cheque-generado").textContent = numeroCheque;
      document.getElementById("fecha-cheque").textContent = new Date().toLocaleDateString();
      document.getElementById("cuenta-origen-cheque").textContent = cuenta;
      document.getElementById("beneficiario-vista").textContent = beneficiario;
      document.getElementById("monto-vista").textContent = monto.toFixed(2);
      document.getElementById("concepto-vista").textContent = concepto;
      vistaCheque.classList.remove("hidden");

      mostrarResultado("success", `‚úÖ Cheque ${numeroCheque} generado exitosamente.`, resultadoDiv);
    };
  };
});

// Cambiar cheque interno (cobrar)
async function cambiarChequeInterno() {
  const numero = document.getElementById("numero-cheque-cambiar").value.trim();
  const nombreCliente = document.getElementById("nombre-cliente-cobro").value.trim();
  const resultadoDiv = document.getElementById("resultado-cambiar-cheque");

  if (!numero || !nombreCliente) {
    mostrarResultado("error", "‚ùå Ingrese n√∫mero de cheque y nombre del cliente.", resultadoDiv);
    return;
  }

  try {
    // 1. Buscar el cheque
    const chequeTrans = db.transaction(["cheques"], "readonly");
    const chequeStore = chequeTrans.objectStore("cheques");
    const chequeIndex = chequeStore.index("numero");
    const chequeReq = chequeIndex.get(numero);

    const cheque = await new Promise((resolve, reject) => {
      chequeReq.onsuccess = () => resolve(chequeReq.result);
      chequeReq.onerror = () => reject(chequeReq.error);
    });

    if (!cheque) {
      mostrarResultado("error", "‚ùå Cheque no encontrado.", resultadoDiv);
      return;
    }

    if (cheque.estado !== "emitido") {
      mostrarResultado("error", `‚ùå Este cheque ya fue ${cheque.estado}.`, resultadoDiv);
      return;
    }

    // 2. Verificar y actualizar la cuenta origen
    const cuentaTrans = db.transaction(["cuentas"], "readwrite");
    const cuentaStore = cuentaTrans.objectStore("cuentas");
    const cuentaIndex = cuentaStore.index("numeroCuenta");
    const cuentaReq = cuentaIndex.get(cheque.cuentaOrigen);

    const cuentaData = await new Promise((resolve, reject) => {
      cuentaReq.onsuccess = () => resolve(cuentaReq.result);
      cuentaReq.onerror = () => reject(cuentaReq.error);
    });

    if (!cuentaData) {
      mostrarResultado("error", "‚ùå Cuenta origen del cheque no encontrada.", resultadoDiv);
      return;
    }

    if (cuentaData.saldo < cheque.monto) {
      mostrarResultado("error", `‚ùå Saldo insuficiente en la cuenta origen. Saldo: RD$ ${cuentaData.saldo.toFixed(2)}`, resultadoDiv);
      return;
    }

    cuentaData.saldo -= cheque.monto;
    cuentaStore.put(cuentaData);

    // Esperar a que la transacci√≥n de cuenta se complete
    await new Promise((resolve, reject) => {
      cuentaTrans.oncomplete = resolve;
      cuentaTrans.onerror = reject;
    });

    // 3. Actualizar el estado del cheque
    const updateChequeTrans = db.transaction(["cheques"], "readwrite");
    const updateStore = updateChequeTrans.objectStore("cheques");
    const updateIndex = updateStore.index("numero");
    const updateReq = updateIndex.get(numero);

    const existingCheque = await new Promise((resolve) => {
      updateReq.onsuccess = () => resolve(updateReq.result);
    });

    existingCheque.estado = "cobrado";
    existingCheque.cobradoPor = nombreCliente;
    existingCheque.fechaCobro = new Date().toISOString();
    updateStore.put(existingCheque);

    await new Promise((resolve) => {
      updateChequeTrans.oncomplete = resolve;
    });

    // 4. Registrar transacci√≥n de retiro
    const transaccion = {
	cajero: usuarioSesion.usuario, // üëà AGREGAR ESTA L√çNEA
      cuenta: cheque.cuentaOrigen,
      tipo: "Retiro",
      monto: cheque.monto,
      moneda: "RD$",
      referencia: `Cheque cobrado: ${numero} por ${nombreCliente}`,
      fecha: new Date().toLocaleString()
    };
    guardarTransaccion(transaccion, resultadoDiv, `‚úÖ Cheque ${numero} cobrado. RD$ ${cheque.monto.toFixed(2)} descontado de la cuenta.`);

    // 5. Actualizar balance del cajero
    usuarioSesion.balanceRD -= cheque.monto;

    const userTrans = db.transaction(["usuarios"], "readwrite");
    const userStore = userTrans.objectStore("usuarios");
    const userIndex = userStore.index("usuario");
    const userReq = userIndex.get(usuarioSesion.usuario);

    const user = await new Promise((resolve) => {
      userReq.onsuccess = () => resolve(userReq.result);
    });

    if (user) {
      user.balanceRD = usuarioSesion.balanceRD;
      userStore.put(user);
    }

    calcularEfectivoDisponible();

    // Limpiar campos
    document.getElementById("numero-cheque-cambiar").value = "";
    document.getElementById("nombre-cliente-cobro").value = "";

  } catch (error) {
    console.error("Error al cambiar cheque interno:", error);
    mostrarResultado("error", "‚ùå Error interno al procesar el cobro del cheque.", resultadoDiv);
  }
}

// Consulta de cheques
function buscarCheques() {
  const query = document.getElementById("buscar-cheque").value.trim();
  const listaDiv = document.getElementById("lista-cheques");
  if (!query) {
    listaDiv.innerHTML = "<div class='alert'>Ingrese un n√∫mero de cheque o cuenta.</div>";
    return;
  }

  const trans = db.transaction(["cheques"], "readonly");
  const store = trans.objectStore("cheques");

  if (query.startsWith("SBCH")) {
    // B√∫squeda por n√∫mero de cheque (√∫nico)
    const request = store.index("numero").get(query);
    request.onsuccess = function() {
      const cheque = request.result;
      if (cheque) {
        mostrarResultadosCheques([cheque], listaDiv);
      } else {
        listaDiv.innerHTML = "<div class='alert'>Cheque no encontrado.</div>";
      }
    };
    request.onerror = () => listaDiv.innerHTML = "<div class='alert error'>Error al buscar el cheque.</div>";
  } else {
    // B√∫squeda por cuenta origen (m√∫ltiples)
    const request = store.index("cuentaOrigen").openCursor(IDBKeyRange.only(query));
    const resultados = [];
    request.onsuccess = function(e) {
      const cursor = e.target.result;
      if (cursor) {
        resultados.push(cursor.value);
        cursor.continue(); // ‚úÖ Continuar al siguiente registro
      } else {
        // No hay m√°s registros
        if (resultados.length > 0) {
          mostrarResultadosCheques(resultados, listaDiv);
        } else {
          listaDiv.innerHTML = "<div class='alert'>No se encontraron cheques para esa cuenta.</div>";
        }
      }
    };
    request.onerror = () => listaDiv.innerHTML = "<div class='alert error'>Error al buscar cheques por cuenta.</div>";
  }
}

function mostrarResultadosCheques(cheques, contenedor) {
  if (cheques.length === 0) {
    contenedor.innerHTML = "<div class='alert'>No se encontraron cheques.</div>";
    return;
  }
  let html = "<h4>Resultados:</h4>";
  cheques.forEach(c => {
    html += `
      <div class="card" style="margin:10px 0; padding:12px;">
        <strong>Cheque:</strong> ${c.numero}<br>
        <strong>Cuenta:</strong> ${c.cuentaOrigen}<br>
        <strong>Beneficiario:</strong> ${c.beneficiario}<br>
        <strong>Monto:</strong> RD$ ${c.monto.toFixed(2)}<br>
        <strong>Estado:</strong> ${c.estado}<br>
        ${c.fechaCobro ? `<strong>Cobrado por:</strong> ${c.cobradoPor} el ${new Date(c.fechaCobro).toLocaleDateString()}` : ''}
      </div>
    `;
  });
  contenedor.innerHTML = html;
}

// Cambiar cheque externo
function cambiarChequeExterno() {
  const cuentaDestino = document.getElementById("cuenta-destino-externo").value.trim();
  const nombreCliente = document.getElementById("nombre-cliente-externo").value.trim();
  const monto = parseFloat(document.getElementById("monto-cheque-externo").value);
  const bancoEmisor = document.getElementById("banco-emisor").value.trim();
  const resultadoDiv = document.getElementById("resultado-cheque-externo");

  if (!cuentaDestino || !nombreCliente || isNaN(monto) || monto <= 0 || !bancoEmisor) {
    mostrarResultado("error", "‚ùå Complete todos los campos.", resultadoDiv);
    return;
  }

  const trans = db.transaction(["cuentas"], "readwrite");
  const store = trans.objectStore("cuentas");
  const index = store.index("numeroCuenta");
  const req = index.get(cuentaDestino);
  req.onsuccess = function() {
    const cuenta = req.result;
    if (!cuenta) {
      mostrarResultado("error", "‚ùå Cuenta destino no encontrada.", resultadoDiv);
      return;
    }
    cuenta.saldo += monto;
    store.put(cuenta);

    const transaccion = {
	cajero: usuarioSesion.usuario, // üëà AGREGAR ESTA L√çNEA
      cuenta: cuentaDestino,
      tipo: "Dep√≥sito",
      monto: monto,
      moneda: "RD$",
      referencia: `Cheque externo de ${bancoEmisor} depositado`,
      fecha: new Date().toLocaleString()
    };
    guardarTransaccion(transaccion, resultadoDiv, `‚úÖ Cheque externo por RD$ ${monto.toFixed(2)} depositado en cuenta ${cuentaDestino}.`);

    // Actualizar balance del cajero
    usuarioSesion.balanceRD += monto;
    const userTrans = db.transaction(["usuarios"], "readwrite");
    const userStore = userTrans.objectStore("usuarios");
    const userIndex = userStore.index("usuario");
    const userReq = userIndex.get(usuarioSesion.usuario);
    userReq.onsuccess = function() {
      const user = userReq.result;
      user.balanceRD = usuarioSesion.balanceRD;
      userStore.put(user);
      calcularEfectivoDisponible();
    };
  };
}

function mostrarModalCertificado(datos) {
  const modalHtml = `
    <div id="modal-certificado" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 2000;">
      <div class="modal-content" style="background: white; padding: 30px; border-radius: 10px; width: 500px; max-width: 90%; text-align: left; font-family: 'Courier New', monospace;">
        <h3 style="text-align: center; color: #003366;">üìÑ Certificado de Inversi√≥n</h3>
        <hr>
        <p><strong>C√≥digo:</strong> ${datos.codigo}</p>
        <p><strong>Titular:</strong> ${datos.nombre}</p>
        <p><strong>Cuenta Vinculada:</strong> ${datos.cuenta}</p>
        <p><strong>Moneda:</strong> ${datos.moneda}</p>
        <p><strong>Monto Invertido:</strong> ${datos.moneda} ${parseFloat(datos.monto).toFixed(2)}</p>
        <p><strong>Plazo:</strong> ${datos.plazo} d√≠as</p>
        <p><strong>Tasa de Inter√©s Anual:</strong> ${parseFloat(datos.tasa).toFixed(2)}%</p>
        <p><strong>Inter√©s Estimado:</strong> ${datos.moneda} ${parseFloat(datos.interes).toFixed(2)}</p>
        <p><strong>Total al Vencimiento:</strong> ${datos.moneda} ${parseFloat(datos.total).toFixed(2)}</p>
        <p><strong>Fecha de Inicio:</strong> ${datos.fechaInicio}</p>
        <p><strong>Fecha de Vencimiento:</strong> ${datos.fechaVencimiento}</p>
        <hr>
        <div style="text-align: center; margin-top: 20px;">
          <button onclick="cerrarModalCertificado()" style="padding: 10px 20px; background: #0056b3; color: white; border: none; border-radius: 5px; cursor: pointer;">
            Cerrar
          </button>
          <button onclick="imprimirCertificado()" style="margin-left: 10px; padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
            üñ®Ô∏è Imprimir
          </button>
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function cerrarModalCertificado() {
  const modal = document.getElementById("modal-certificado");
  if (modal) modal.remove();
}

function imprimirCertificado() {
  const contenido = document.getElementById("modal-certificado").querySelector('.modal-content').innerHTML;
  const ventana = window.open("", "Certificado de Inversi√≥n", "width=600,height=700");
  ventana.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>Certificado de Inversi√≥n</title>
      <style>
        body { font-family: 'Courier New', monospace; padding: 20px; }
        h3 { text-align: center; color: #003366; }
        hr { margin: 15px 0; }
        button { display: none; }
      </style>
    </head>
    <body>
      ${contenido}
    </body>
    </html>
  `);
  ventana.document.close();
  ventana.onload = () => {
    ventana.print();
    // ventana.close(); // Opcional: cerrar tras imprimir
  };
}

function mostrarModalPrestamo(codigo) {
  const modalHtml = `
    <div id="modal-prestamo" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 2000;">
      <div class="modal-content" style="background: white; padding: 30px; border-radius: 10px; width: 400px; max-width: 90%; text-align: center;">
        <h3>‚úÖ Solicitud de Pr√©stamo Registrada</h3>
        <p style="font-size: 1.2em; margin: 20px 0; font-weight: bold; color: #003366;">
          C√≥digo de Pr√©stamo:<br>
          <span style="font-family: monospace; letter-spacing: 2px;">${codigo}</span>
        </p>
        <button onclick="cerrarModalPrestamo()" style="padding: 10px 20px; background: #0056b3; color: white; border: none; border-radius: 5px; cursor: pointer;">
          Cerrar
        </button>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function cerrarModalPrestamo() {
  const modal = document.getElementById("modal-prestamo");
  if (modal) modal.remove();
}

function mostrarBienvenida() {
  const modalHtml = `
    <div id="modal-bienvenida" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 3000;">
      <div class="modal-content" style="background: white; padding: 30px; border-radius: 10px; width: 400px; max-width: 90%; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <h2 style="color: #003366; margin-bottom: 15px;">üëã ¬°Bienvenido!</h2>
        <p style="font-size: 1.1em; line-height: 1.5; color: #333;">
          Bienvenido a <strong>Simubank</strong>, tu banco educativo por excelencia.
        </p>
        <p style="margin-top: 15px; font-size: 0.95em; color: #666;">
          Cajero: <strong>${usuarioSesion.nombre}</strong><br>
          Sucursal: ${usuarioSesion.sucursal}
        </p>
        <button onclick="cerrarBienvenida()" style="margin-top: 20px; padding: 10px 25px; background: #0056b3; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
          Comenzar
        </button>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function cerrarBienvenida() {
  const modal = document.getElementById("modal-bienvenida");
  if (modal) modal.remove();
}

// Detectar actividad del usuario
document.addEventListener("mousemove", reiniciarTemporizadorInactividad);
document.addEventListener("keypress", reiniciarTemporizadorInactividad);
document.addEventListener("click", reiniciarTemporizadorInactividad);
document.addEventListener("scroll", reiniciarTemporizadorInactividad);
document.addEventListener("touchstart", reiniciarTemporizadorInactividad); // Para m√≥viles

function registrarDepositoTab() {
  const cuenta = document.getElementById("cuenta-deposito-tab").value.trim();
  const moneda = document.getElementById("moneda-deposito-tab").value;
  const monto = parseFloat(document.getElementById("total-calculado-deposito").textContent);
  const resultado = document.getElementById("resultado-deposito-tab");

  if (!cuenta || !moneda || isNaN(monto) || monto <= 0) {
    mostrarResultado("error", "‚ùå Complete la cuenta, seleccione moneda y agregue billetes.", resultado);
    return;
  }

  // Asignar al formulario global para reutilizar l√≥gica existente
  document.getElementById("cuenta-deposito").value = cuenta;
  document.getElementById("moneda-deposito").value = moneda;
  document.getElementById("monto-deposito").value = monto;

  // Reutilizar la l√≥gica original de dep√≥sito
  const original = document.getElementById("resultado-deposito");
  resultado.innerHTML = "";
  resultado.className = "alert hidden";

  const observer = new MutationObserver(() => {
    if (!original.classList.contains("hidden")) {
      resultado.textContent = original.textContent;
      resultado.className = original.className;
      resultado.classList.remove("hidden");
      if (original.classList.contains("success")) {
        // Limpiar formulario de la pesta√±a
        document.getElementById("cuenta-deposito-tab").value = "";
        document.getElementById("moneda-deposito-tab").value = "";
        document.getElementById("calculadora-deposito-container").classList.add("hidden");
      }
      observer.disconnect();
    }
  });
  observer.observe(original, { attributes: true, attributeFilter: ['class'] });

  registrarDeposito();
}

function registrarRetiroTab() {
  const cuenta = document.getElementById("cuenta-retiro-tab").value.trim();
  const moneda = document.getElementById("moneda-retiro-tab").value;
  const monto = parseFloat(document.getElementById("total-calculado-retiro").textContent);
  const resultado = document.getElementById("resultado-retiro-tab");

  if (!cuenta || !moneda || isNaN(monto) || monto <= 0) {
    mostrarResultado("error", "‚ùå Complete la cuenta, seleccione moneda y agregue billetes.", resultado);
    return;
  }

  // Asignar al formulario global para reutilizar l√≥gica existente
  document.getElementById("cuenta-retiro").value = cuenta;
  document.getElementById("moneda-retiro").value = moneda;
  document.getElementById("monto-retiro").value = monto;

  // Reutilizar la l√≥gica original de retiro
  const original = document.getElementById("resultado-retiro");
  resultado.innerHTML = "";
  resultado.className = "alert hidden";

  const observer = new MutationObserver(() => {
    if (!original.classList.contains("hidden")) {
      resultado.textContent = original.textContent;
      resultado.className = original.className;
      resultado.classList.remove("hidden");
      if (original.classList.contains("success")) {
        // Limpiar formulario de la pesta√±a
        document.getElementById("cuenta-retiro-tab").value = "";
        document.getElementById("moneda-retiro-tab").value = "";
        document.getElementById("calculadora-retiro-container").classList.add("hidden");
      }
      observer.disconnect();
    }
  });
  observer.observe(original, { attributes: true, attributeFilter: ['class'] });

  registrarRetiro();
}

// CONSULTA desde pesta√±a
function consultarSaldoTab() {
  document.getElementById("cuenta-saldo").value = document.getElementById("cuenta-saldo-tab").value;
  const original = document.getElementById("resultado-saldo");
  const datosOriginal = document.getElementById("datos-cuenta");
  const temp = document.getElementById("resultado-saldo-tab");
  const datosTemp = document.getElementById("datos-cuenta-tab");
  original.classList.remove("hidden");
  original.style.display = "none";
  datosOriginal.style.display = "none";
  temp.innerHTML = "";
  temp.className = "alert hidden";
  datosTemp.classList.add("hidden");
  const observer = new MutationObserver(() => {
    if (!original.classList.contains("hidden")) {
      temp.textContent = original.textContent;
      temp.className = original.className;
      temp.classList.remove("hidden");
    }
    if (!datosOriginal.classList.contains("hidden")) {
      document.querySelectorAll("#datos-cuenta > span").forEach((orig, i) => {
        document.querySelectorAll("#datos-cuenta-tab > span")[i].textContent = orig.textContent;
      });
      datosTemp.classList.remove("hidden");
    }
  });
  observer.observe(original, { attributes: true, attributeFilter: ['class'] });
  observer.observe(datosOriginal, { attributes: true, attributeFilter: ['class'] });
  consultarSaldo();
}

// HISTORIAL POR CUENTA
function filtrarHistorialPorCuenta() {
  const cuenta = document.getElementById("cuenta-historial").value.trim();
  if (!cuenta) {
    alert("Ingrese un n√∫mero de cuenta.");
    return;
  }
  const tbody = document.getElementById("cuerpo-historial-cuenta");
  tbody.innerHTML = "<tr><td colspan='5'>Cargando...</td></tr>";
  const filtradas = transacciones.filter(t => t.cuenta === cuenta);
  tbody.innerHTML = "";
  if (filtradas.length === 0) {
    tbody.innerHTML = "<tr><td colspan='5'>No hay transacciones para esta cuenta.</td></tr>";
    return;
  }
  filtradas.forEach(t => {
    const tr = document.createElement("tr");
    let clase = "";
    if (t.tipo === "Dep√≥sito") clase = "transaccion-deposito";
    else if (t.tipo === "Retiro") clase = "transaccion-retiro";
    else if (t.tipo === "Pago de Servicio") clase = "transaccion-pago";
    else if (t.tipo === "Cambio de Divisa") clase = "transaccion-cambio";
    tr.className = clase;
    tr.innerHTML = `
      <td>${t.fecha}</td>
      <td>${t.tipo}</td>
      <td>${t.monto.toFixed(2)}</td>
      <td>${t.moneda}</td>
      <td>${t.referencia}</td>
    `;
    tbody.appendChild(tr);
  });
}

function realizarAvanceEfectivo() {
  let numeroTarjeta = document.getElementById("numero-tarjeta-avance").value.trim();
  numeroTarjeta = numeroTarjeta.replace(/\s/g, '');
  const monto = parseFloat(document.getElementById("monto-avance").value);
  const descripcion = document.getElementById("descripcion-avance").value.trim();
  const resultadoDiv = document.getElementById("resultado-avance-tarjeta");

  // Validaciones
  if (!numeroTarjeta || numeroTarjeta.length !== 16) {
    mostrarResultado("error", "‚ùå Por favor, ingrese un n√∫mero de tarjeta v√°lido (16 d√≠gitos).", resultadoDiv);
    return;
  }
  if (isNaN(monto) || monto <= 0) {
    mostrarResultado("error", "‚ùå Por favor, ingrese un monto v√°lido mayor a cero.", resultadoDiv);
    return;
  }
  if (!descripcion) {
    mostrarResultado("error", "‚ùå Por favor, ingrese una descripci√≥n para el avance.", resultadoDiv);
    return;
  }

  // Buscar la tarjeta
  const transaction = db.transaction(["tarjetas"], "readwrite");
  const store = transaction.objectStore("tarjetas");
  const request = store.openCursor();
  let tarjetaEncontrada = null;

  request.onsuccess = function(e) {
    const cursor = e.target.result;
    if (cursor) {
      const tarjeta = cursor.value;
      const tarjetaNumero = tarjeta.numero ? tarjeta.numero.replace(/\s/g, '') : '';
      if (tarjetaNumero === numeroTarjeta) {
        tarjetaEncontrada = tarjeta;
      }
      cursor.continue();
    } else {
      if (tarjetaEncontrada) {
        procesarAvanceEfectivo(tarjetaEncontrada, monto, descripcion, resultadoDiv);
      } else {
        mostrarResultado("error", "‚ùå Tarjeta no encontrada. Verifique el n√∫mero ingresado.", resultadoDiv);
      }
    }
  };

  request.onerror = function(e) {
    console.error("Error al buscar tarjeta:", e);
    mostrarResultado("error", "‚ùå Error al buscar la tarjeta en la base de datos.", resultadoDiv);
  };
}

window.addEventListener('beforeunload', function (e) {
  if (usuarioSesion && !cajaCerrada) {
    const mensaje = "‚ö†Ô∏è Debe cerrar la caja antes de salir del sistema.";
    e.returnValue = mensaje;
    return mensaje;
  }
});

function imprimirRecibo(tipo, datos) {
  // Dimensiones en cm convertidas a p√≠xeles (asumiendo 96 DPI ‚âà 37.8 px/cm)
  const anchoCm = 20.5;
  const altoCm = 9.2;
  const anchoPx = Math.round(anchoCm * 37.8); // ‚âà 775 px
  const altoPx = Math.round(altoCm * 37.8);   // ‚âà 348 px

  let formaPago = "";
  if (datos.formaPago) {
    if (datos.formaPago.efectivo !== undefined) {
      formaPago += `     Efectivo: ${datos.formaPago.efectivo ? "S√≠" : "No"}\n`;
    }
    if (datos.formaPago.cheque !== undefined) {
      formaPago += `     Cheque: ${datos.formaPago.cheque ? "S√≠" : "No"}\n`;
    }
    if (datos.formaPago.retiro !== undefined) {
      formaPago += `     Retiro a cuenta: ${datos.formaPago.retiro ? "S√≠" : "No"}\n`;
    }
  } else {
    // Valor por defecto si no se especifica
    formaPago = "     Efectivo: S√≠\n     Cheque: No\n     Retiro a cuenta: No\n";
  }

  const contenido = `
    <html>
    <head>
      <meta charset="UTF-8">
      <title>Recibo - ${tipo}</title>
      <style>
        body {
          width: ${anchoPx}px;
          height: ${altoPx}px;
          margin: 0;
          padding: 10px;
          font-family: 'Courier New', monospace;
          font-size: 12px;
          line-height: 1.4;
          color: black;
          box-sizing: border-box;
        }
        .centrado {
          text-align: center;
          margin-bottom: 10px;
        }
        .negrita {
          font-weight: bold;
        }
        .nota {
          font-size: 10px;
          margin-top: 8px;
          line-height: 1.3;
        }
      </style>
    </head>
    <body>
      <div class="centrado">
        <div class="negrita">SIMUBANK</div>
        <div>Tu banco educativo por excelencia</div>
      </div>

      <div><strong>Concepto del recibo:</strong> ${tipo}</div>
      <div><strong>N√∫mero de cuenta o de tarjeta:</strong> ${datos.cuenta || '‚Äî'}</div>
      <div><strong>Nombre del cliente:</strong> ${datos.titular || '‚Äî'}</div>
      <div><strong>Moneda:</strong> ${datos.moneda || '‚Äî'}</div>
      <div><strong>Total transacci√≥n:</strong> ${(datos.moneda || '') + ' ' + parseFloat(datos.monto || 0).toFixed(2)}</div>
      <div><strong>Fecha y hora:</strong> ${datos.fecha || '‚Äî'}</div>
      <div><strong>Oficina y cajero:</strong> ${datos.sucursal || '‚Äî'} / ${usuarioSesion?.nombre || '‚Äî'}</div>

      <div><strong>Forma de pago:</strong></div>
      <pre style="margin: 0; font-family: inherit; font-size: 12px;">${formaPago}</pre>

      <div class="nota">
        Nota: Los pagos realizados de lunes a viernes luego de las 6:00 p.m., s√°bados, domingos y feriados son aplicados al siguiente d√≠a laborable.
      </div>
    </body>
    </html>
  `;

  const ventana = window.open("", "Recibo", `width=${anchoPx},height=${altoPx},resizable=yes`);
  ventana.document.write(contenido);
  ventana.document.close();

  ventana.onload = () => {
    const imprimir = confirm("¬øDesea imprimir el recibo?");
    if (imprimir) {
      ventana.print();
    }
    // Opcional: ventana.close(); si deseas cerrar tras imprimir
  };
}


// Bloquear clic derecho
document.addEventListener('contextmenu', function(e) {
  e.preventDefault();
  alert("‚ö†Ô∏è El men√∫ contextual est√° deshabilitado.");
});

// Bloquear teclas F12, Ctrl+Shift+I, Ctrl+U, Ctrl+Shift+J
document.addEventListener('keydown', function(e) {
  // F12
  if (e.key === 'F12') {
    e.preventDefault();
    alert("‚ö†Ô∏è Las herramientas de desarrollo est√°n deshabilitadas.");
    return false;
  }
  // Ctrl+Shift+I (Windows/Linux) o Cmd+Opt+I (Mac) - Inspeccionar
  if (e.ctrlKey && e.shiftKey && e.key === 'I') {
    e.preventDefault();
    alert("‚ö†Ô∏è Las herramientas de desarrollo est√°n deshabilitadas.");
    return false;
  }
  // Ctrl+U (Ver c√≥digo fuente)
  if (e.ctrlKey && e.key === 'u') {
    e.preventDefault();
    alert("‚ö†Ô∏è Ver el c√≥digo fuente est√° deshabilitado.");
    return false;
  }
  // Ctrl+Shift+J (Consola en algunos navegadores)
  if (e.ctrlKey && e.shiftKey && e.key === 'J') {
    e.preventDefault();
    alert("‚ö†Ô∏è La consola est√° deshabilitada.");
    return false;
  }
});

async function cambiarContrasena() {
  // Pedir nueva contrase√±a
  const nuevaPass = prompt("üîí Ingrese su nueva contrase√±a:");
  if (nuevaPass === null) return;
  if (nuevaPass.length < 6) {
    alert("‚ùå La contrase√±a debe tener al menos 6 caracteres.");
    return;
  }

  const confirmPass = prompt("üîí Confirme su nueva contrase√±a:");
  if (confirmPass === null || confirmPass !== nuevaPass) {
    alert("‚ùå Las contrase√±as no coinciden.");
    return;
  }

  // Pedir credenciales del administrador
  const adminUser = prompt("üîê Usuario del administrador (solo 'admin'):");
  if (adminUser !== "admin") {
    alert("‚ùå Solo el usuario 'admin' puede autorizar cambios de contrase√±a.");
    return;
  }

  const adminPass = prompt("üîê Contrase√±a del administrador:");
  if (adminPass === null) return;

  try {
    const adminHash = await hashPassword(adminPass);
    const trans = db.transaction(["usuarios"], "readonly");
    const store = trans.objectStore("usuarios");
    const adminReq = store.index("usuario").get("admin");
    const admin = await new Promise((res) => {
      adminReq.onsuccess = () => res(adminReq.result);
      adminReq.onerror = () => res(null);
    });

    if (!admin || admin.password !== adminHash) {
      alert("‚ùå Credenciales del administrador incorrectas.");
      return;
    }

    // Hashear nueva contrase√±a del cajero
    const nuevaHash = await hashPassword(nuevaPass);

    // Actualizar en la base de datos
    const updateTrans = db.transaction(["usuarios"], "readwrite");
    const updateStore = updateTrans.objectStore("usuarios");
    const userReq = updateStore.index("usuario").get(usuarioSesion.usuario);
    const user = await new Promise((res) => {
      userReq.onsuccess = () => res(userReq.result);
      userReq.onerror = () => res(null);
    });

    if (!user) {
      alert("‚ùå Error: usuario no encontrado.");
      return;
    }

    user.password = nuevaHash;
    updateStore.put(user);

    updateTrans.oncomplete = () => {
      alert("‚úÖ Contrase√±a cambiada exitosamente.");
    };
  } catch (err) {
    console.error("Error al cambiar la contrase√±a:", err);
    alert("‚ùå Error interno al procesar el cambio.");
  }
}

function realizarTransferenciaTab() {
  const origenInput = document.getElementById("cuenta-origen");
  const destinoInput = document.getElementById("cuenta-destino");
  const montoInput = document.getElementById("monto-transferencia");
  const monedaSelect = document.getElementById("moneda-transferencia");

  // Asignar valores al formulario global (usado por realizarTransferencia)
  document.getElementById("cuenta-origen").value = origenInput.value;
  document.getElementById("cuenta-destino").value = destinoInput.value;
  document.getElementById("monto-transferencia").value = montoInput.value;
  document.getElementById("moneda-transferencia").value = monedaSelect.value;

  const original = document.getElementById("resultado-transferencia");
  const temp = document.getElementById("resultado-transferencia"); // mismo contenedor, pero limpiaremos aqu√≠

  // Reiniciar mensaje
  original.innerHTML = "";
  original.className = "alert hidden";

  // Ejecutar transferencia
  realizarTransferencia();

  // Observar si aparece un mensaje de √©xito para limpiar
  const observer = new MutationObserver(() => {
    if (!original.classList.contains("hidden")) {
      if (original.classList.contains("success")) {
        // ‚úÖ Limpiar campos de la pesta√±a
        origenInput.value = "";
        destinoInput.value = "";
        montoInput.value = "";
        monedaSelect.value = "RD$";
      }
      observer.disconnect();
    }
  });

  observer.observe(original, { attributes: true, attributeFilter: ['class'] });
}

// NUEVA FUNCI√ìN: Cargar pr√©stamos con cuotas pr√≥ximas o vencidas
async function cargarPrestamosACobrar() {
  const hoy = new Date();
  const container = document.getElementById("lista-prestamos-acobrar");
  container.innerHTML = "<p>Cargando pr√©stamos pendientes...</p>";

  try {
    const trans = db.transaction(["prestamos"], "readonly");
    const store = trans.objectStore("prestamos");
    const request = store.openCursor();
    const cuotasProximas = []; // Solo una cuota por pr√©stamo

    request.onsuccess = function(e) {
      const cursor = e.target.result;
      if (cursor) {
        const p = cursor.value;
        if (p.estado === "Aprobado" && Array.isArray(p.cuotas)) {
          // Filtrar cuotas no pagadas
          const cuotasPendientes = p.cuotas.filter(c => !c.pagada);
          if (cuotasPendientes.length > 0) {
            // Encontrar la cuota con fecha de vencimiento m√°s cercana
            const cuotaMasCercana = cuotasPendientes.reduce((masCercana, actual) => {
              const fechaMasCercana = new Date(masCercana.fechaVencimiento);
              const fechaActual = new Date(actual.fechaVencimiento);
              return fechaActual < fechaMasCercana ? actual : masCercana;
            });
            cuotasProximas.push({
              prestamo: p,
              cuota: cuotaMasCercana
            });
          }
        }
        cursor.continue();
      } else {
        // Ordenar por fecha de vencimiento (m√°s cercana primero)
        cuotasProximas.sort((a, b) => {
          return new Date(a.cuota.fechaVencimiento) - new Date(b.cuota.fechaVencimiento);
        });

        if (cuotasProximas.length === 0) {
          container.innerHTML = "<div class='alert'>No hay cuotas pendientes.</div>";
        } else {
          let html = `<div class="alert success">Se encontraron ${cuotasProximas.length} pr√©stamos con cuotas pr√≥ximas a vencer.</div>`;
          cuotasProximas.forEach(item => {
            const fechaVenc = new Date(item.cuota.fechaVencimiento);
            const vencida = fechaVenc < hoy;
            const color = vencida ? "#f8d7da" : "#d1ecf1";
            const estado = vencida ? "‚ö†Ô∏è VENCIDA" : "üìÖ Pr√≥xima";

            html += `
              <div class="cuota-item" style="background: ${color}; border-left-color: ${vencida ? '#dc3545' : '#17a2b8'}; margin: 10px 0; padding: 12px; border-radius: 6px;">
                <strong>${estado}</strong><br>
                <strong>Pr√©stamo:</strong> ${item.prestamo.codigo}<br>
                <strong>Cliente:</strong> ${item.prestamo.nombre}<br>
                <strong>Cuota #${item.cuota.numero}</strong> ‚Äî Vence: ${item.cuota.fechaVencimiento}<br>
                <strong>Monto:</strong> RD$ ${item.cuota.monto.toFixed(2)}<br>
                <button onclick="buscarPrestamoPorId(${item.prestamo.id})" style="margin-top: 8px; background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 4px;">
                  Ir a Cobro
                </button>
              </div>
            `;
          });
          container.innerHTML = html;
        }
      }
    };

    request.onerror = function() {
      container.innerHTML = "<div class='alert error'>Error al cargar los pr√©stamos.</div>";
    };
  } catch (err) {
    console.error("Error en cargarPrestamosACobrar:", err);
    container.innerHTML = "<div class='alert error'>Error interno al cargar los pr√©stamos.</div>";
  }
}

// Funci√≥n auxiliar para navegar al cobro de un pr√©stamo espec√≠fico
function buscarPrestamoPorId(id) {
  const trans = db.transaction(["prestamos"], "readonly");
  const store = trans.objectStore("prestamos");
  const req = store.get(id);
  req.onsuccess = function() {
    const prestamo = req.result;
    if (prestamo) {
      // Simular b√∫squeda en el m√≥dulo de cobro
      document.getElementById("buscar-prestamo").value = prestamo.codigo;
      mostrarTab('cobro');
      setTimeout(() => buscarPrestamo(), 300);
    }
  };
}

function parsearFechaDDMMYYYY(fechaStr) {
  const partes = fechaStr.split('/');
  if (partes.length !== 3) return null;
  const [dia, mes, anio] = partes.map(Number);
  // Mes en JS es 0-indexado
  return new Date(anio, mes - 1, dia);
}

// Mostrar pesta√±as dentro del m√≥dulo de inversiones
function mostrarTabInversion(tabName) {
  document.querySelectorAll("#gestion-inversiones .tab-content").forEach(t => t.classList.remove("active"));
  document.querySelectorAll("#gestion-inversiones .tab-btn").forEach(t => t.classList.remove("active"));
  document.getElementById(`tab-inversion-${tabName}`).classList.add("active");
  const index = { apertura: 0, consulta: 1 }[tabName];
  document.querySelectorAll("#gestion-inversiones .tab-btn")[index].classList.add("active");
}

// Abrir inversi√≥n
document.getElementById("form-inversion").addEventListener("submit", async function(e) {
  e.preventDefault();
  const nombre = document.getElementById("nombre-inversion").value.trim();
  const cuenta = document.getElementById("cuenta-vinculada").value.trim();
  const moneda = document.getElementById("moneda-inversion").value;
  const monto = parseFloat(document.getElementById("monto-inversion").value);
  const plazo = parseInt(document.getElementById("plazo-inversion").value);
  const tasa = parseFloat(document.getElementById("tasa-interes").value);
  const vencimiento = document.getElementById("fecha-vencimiento").value;

// üëá PEGA TU C√ìDIGO AQU√ç
const hoy = new Date();
const vencimientoDate = new Date(vencimiento);
if (vencimientoDate <= hoy) {
  mostrarResultado("error", "‚ùå La fecha de vencimiento debe ser futura.", document.getElementById("resultado-inversion"));
  return;
}

if (!nombre || !cuenta || isNaN(monto) || monto <= 0 || isNaN(tasa) || tasa <= 0 || !vencimiento) {
  mostrarResultado("error", "‚ùå Complete todos los campos correctamente.", document.getElementById("resultado-inversion"));
  return;
}

  if (!nombre || !cuenta || isNaN(monto) || monto <= 0 || isNaN(tasa) || tasa <= 0 || !vencimiento) {
    mostrarResultado("error", "‚ùå Complete todos los campos correctamente.", document.getElementById("resultado-inversion"));
    return;
  }

  // Verificar que la cuenta exista
  const cuentaTrans = db.transaction(["cuentas"], "readonly");
  const cuentaStore = cuentaTrans.objectStore("cuentas");
  const cuentaReq = cuentaStore.index("numeroCuenta").get(cuenta);
  cuentaReq.onsuccess = async function() {
    if (!cuentaReq.result) {
      mostrarResultado("error", "‚ùå La cuenta vinculada no existe.", document.getElementById("resultado-inversion"));
      return;
    }

    // Generar ID √∫nico para inversi√≥n
    const invTrans = db.transaction(["inversiones"], "readwrite");
    const invStore = invTrans.objectStore("inversiones");
    const countReq = invStore.count();
    countReq.onsuccess = function() {
      const codigo = `SBINV${String(countReq.result + 1).padStart(5, '0')}`;

      const inversion = {
        codigo,
        nombre,
        cuentaVinculada: cuenta,
        moneda,
        monto,
        plazoDias: plazo,
        tasaAnual: tasa,
        fechaInicio: new Date().toISOString().split("T")[0],
        fechaVencimiento: vencimiento,
        estado: "Activa"
      };

      invStore.add(inversion);
      invTrans.oncomplete = () => {
  // Calcular inter√©s y total
  const interes = monto * (tasa / 100) * (plazo / 360);
  const total = monto + interes;

  // Mostrar modal con el certificado
  mostrarModalCertificado({
    codigo,
    nombre,
    cuenta,
    moneda,
    monto,
    plazo,
    tasa,
    fechaInicio: new Date().toLocaleDateString(),
    fechaVencimiento: new Date(vencimiento).toLocaleDateString(),
    interes,
    total
  });

  // Limpiar formulario
  document.getElementById("form-inversion").reset();
  document.getElementById("fecha-vencimiento").value = "";
};
    };
  };
});

// Cargar tasa global en el formulario de apertura al cambiar la moneda
function cargarTasaGlobalEnFormulario() {
  const monedaSeleccionada = document.getElementById("moneda-inversion").value;
  const campoTasa = document.getElementById("tasa-interes");
  if (window.tasasInversion && window.tasasInversion[monedaSeleccionada]) {
    campoTasa.value = window.tasasInversion[monedaSeleccionada];
  } else {
    campoTasa.value = ""; // o un valor por defecto, ej: "8.5"
  }
}

function actualizarFechaVencimiento() {
  const plazoDias = parseInt(document.getElementById("plazo-inversion").value);
  const fechaVencimientoInput = document.getElementById("fecha-vencimiento");

  if (!plazoDias || plazoDias <= 0) {
    fechaVencimientoInput.value = "";
    return;
  }

  const hoy = new Date();
  const vencimiento = new Date(hoy);
  vencimiento.setDate(hoy.getDate() + plazoDias);

  // Formatear como YYYY-MM-DD para el input type="date"
  const year = vencimiento.getFullYear();
  const month = String(vencimiento.getMonth() + 1).padStart(2, '0');
  const day = String(vencimiento.getDate()).padStart(2, '0');
  fechaVencimientoInput.value = `${year}-${month}-${day}`;
}

// (a) Renovar inversi√≥n (misma configuraci√≥n o con ajustes)
function renovarInversion(inversion) {
  const { codigo, nombre, cuentaVinculada, moneda, monto, plazoDias, tasaAnual, fechaVencimiento } = inversion;

  // Preguntar si desea renovar con ganancias
  const incluirGanancias = confirm("¬øDesea reinvertir el capital + intereses generados?");
  const interes = monto * (tasaAnual / 100) * (plazoDias / 360);
  const nuevoMonto = incluirGanancias ? monto + interes : monto;

  // Permitir ajustar par√°metros
  const nuevoPlazo = parseInt(prompt("Plazo en d√≠as (ej: 30, 60, 90, 180, 360):", plazoDias)) || plazoDias;
  const nuevaTasa = parseFloat(prompt("Tasa de inter√©s anual (%):", tasaAnual)) || tasaAnual;

  if (nuevoPlazo <= 0 || nuevaTasa <= 0) {
    alert("‚ùå Valores inv√°lidos. La renovaci√≥n fue cancelada.");
    return;
  }

  const hoy = new Date();
  const nuevaFechaVencimiento = new Date(hoy);
  nuevaFechaVencimiento.setDate(hoy.getDate() + nuevoPlazo);
  const fechaVencimientoStr = nuevaFechaVencimiento.toISOString().split("T")[0];

  // Generar nuevo c√≥digo
  const invTrans = db.transaction(["inversiones"], "readwrite");
  const invStore = invTrans.objectStore("inversiones");
  const countReq = invStore.count();
  countReq.onsuccess = function() {
    const nuevoCodigo = `SBINV${String(countReq.result + 1).padStart(5, '0')}`;
    const nuevaInversion = {
      codigo: nuevoCodigo,
      nombre,
      cuentaVinculada,
      moneda,
      monto: nuevoMonto,
      plazoDias: nuevoPlazo,
      tasaAnual: nuevaTasa,
      fechaInicio: hoy.toISOString().split("T")[0],
      fechaVencimiento: fechaVencimientoStr,
      estado: "Activa"
    };
    invStore.add(nuevaInversion);
    invTrans.oncomplete = () => {
      const nuevoInteres = nuevoMonto * (nuevaTasa / 100) * (nuevoPlazo / 360);
      const nuevoTotal = nuevoMonto + nuevoInteres;
      mostrarModalCertificado({
        codigo: nuevoCodigo,
        nombre,
        cuenta: cuentaVinculada,
        moneda,
        monto: nuevoMonto,
        plazo: nuevoPlazo,
        tasa: nuevaTasa,
        fechaInicio: hoy.toLocaleDateString(),
        fechaVencimiento: nuevaFechaVencimiento.toLocaleDateString(),
        interes: nuevoInteres,
        total: nuevoTotal
      });
      alert(`‚úÖ Inversi√≥n ${codigo} renovada exitosamente como ${nuevoCodigo}.`);
    };
  };
}

// (b) Retiro anticipado con penalizaci√≥n
function retirarInversionAnticipadamente(inversion) {
  const { codigo, cuentaVinculada, moneda, monto, plazoDias, tasaAnual, fechaInicio, fechaVencimiento } = inversion;

  const hoy = new Date();
  const inicio = new Date(fechaInicio);
  const vencimiento = new Date(fechaVencimiento);
  const diasTranscurridos = Math.floor((hoy - inicio) / (1000 * 60 * 60 * 24));
  const diasTotales = Math.floor((vencimiento - inicio) / (1000 * 60 * 60 * 24));

  if (diasTranscurridos <= 0) {
    alert("‚ùå No se puede retirar antes del inicio de la inversi√≥n.");
    return;
  }

  // Calcular inter√©s proporcional
  const interesProporcional = monto * (tasaAnual / 100) * (diasTranscurridos / 360);
  const montoBruto = monto + interesProporcional;
  const penalizacion = interesProporcional * 0.02; // 2% del inter√©s generado
  const montoNeto = montoBruto - penalizacion;

  if (!confirm(`‚ö†Ô∏è Retiro anticipado con penalizaci√≥n:\n\nMonto bruto: ${moneda} ${montoBruto.toFixed(2)}\nPenalizaci√≥n (2% del inter√©s): ${moneda} ${penalizacion.toFixed(2)}\nMonto neto: ${moneda} ${montoNeto.toFixed(2)}\n\n¬øDesea continuar?`)) {
    return;
  }

  // Actualizar saldo de la cuenta vinculada
  const cuentaTrans = db.transaction(["cuentas"], "readwrite");
  const cuentaStore = cuentaTrans.objectStore("cuentas");
  const cuentaReq = cuentaStore.index("numeroCuenta").get(cuentaVinculada);
  cuentaReq.onsuccess = function() {
    const cuenta = cuentaReq.result;
    if (!cuenta) {
      alert("‚ùå Cuenta vinculada no encontrada.");
      return;
    }
    cuenta.saldo += montoNeto;
    cuentaStore.put(cuenta);

    // Marcar inversi√≥n como cerrada
    const invTrans = db.transaction(["inversiones"], "readwrite");
    const invStore = invTrans.objectStore("inversiones");
    const invReq = invStore.index("codigo").get(codigo);
    invReq.onsuccess = function() {
      const inv = invReq.result;
      if (inv) {
        inv.estado = "Cerrada (Retiro anticipado)";
        invStore.put(inv);
      }
    };

    // Registrar transacci√≥n
    const transaccion = {
      cajero: usuarioSesion.usuario,
      cuenta: cuentaVinculada,
      tipo: "Retiro Anticipado Inversi√≥n",
      monto: montoNeto,
      moneda: moneda,
      referencia: `Retiro anticipado inversi√≥n ${codigo} con penalizaci√≥n`,
      fecha: new Date().toLocaleString()
    };
    guardarTransaccion(transaccion, null, "");

    // Actualizar caja (si la moneda es RD$)
    if (moneda === "RD$") {
      usuarioSesion.balanceRD += montoNeto;
      const userTrans = db.transaction(["usuarios"], "readwrite");
      const userStore = userTrans.objectStore("usuarios");
      const userIndex = userStore.index("usuario");
      const userReq = userIndex.get(usuarioSesion.usuario);
      userReq.onsuccess = function() {
        const user = userReq.result;
        if (user) {
          user.balanceRD = usuarioSesion.balanceRD;
          userStore.put(user);
          calcularEfectivoDisponible();
        }
      };
    }

    alert(`‚úÖ Retiro anticipado procesado.\nMonto neto depositado: ${moneda} ${montoNeto.toFixed(2)}`);
  };
}

// (c) Transferir intereses a otra cuenta
function transferirIntereses(inversion) {
  const { codigo, cuentaVinculada, moneda, monto, plazoDias, tasaAnual, fechaVencimiento } = inversion;

  const vencimiento = new Date(fechaVencimiento);
  const hoy = new Date();
  if (hoy < vencimiento) {
    alert("‚ÑπÔ∏è La inversi√≥n a√∫n no ha vencido. Solo se pueden transferir intereses al vencimiento.");
    return;
  }

  const interes = monto * (tasaAnual / 100) * (plazoDias / 360);
  const cuentaDestino = prompt("Ingrese el n√∫mero de cuenta destino (debe ser del mismo cliente):");
  if (!cuentaDestino) return;

  // Validar que la cuenta destino exista y pertenezca al mismo cliente
  const trans = db.transaction(["cuentas"], "readonly");
  const store = trans.objectStore("cuentas");
  const reqOrigen = store.index("numeroCuenta").get(cuentaVinculada);
  const reqDestino = store.index("numeroCuenta").get(cuentaDestino);
  reqOrigen.onsuccess = function() {
    const origen = reqOrigen.result;
    reqDestino.onsuccess = function() {
      const destino = reqDestino.result;
      if (!destino) {
        alert("‚ùå Cuenta destino no encontrada.");
        return;
      }
      if (origen.cedula !== destino.cedula) {
        alert("‚ùå La cuenta destino no pertenece al mismo cliente.");
        return;
      }
      if (destino.moneda !== moneda) {
        alert(`‚ùå La cuenta destino debe ser en ${moneda}.`);
        return;
      }

      // Actualizar saldo de la cuenta destino
      const updateTrans = db.transaction(["cuentas"], "readwrite");
      const updateStore = updateTrans.objectStore("cuentas");
      destino.saldo += interes;
      updateStore.put(destino);

      // Marcar inversi√≥n como pagada (solo intereses transferidos)
      const invTrans = db.transaction(["inversiones"], "readwrite");
      const invStore = invTrans.objectStore("inversiones");
      const invReq = invStore.index("codigo").get(codigo);
      invReq.onsuccess = function() {
        const inv = invReq.result;
        if (inv) {
          inv.estado = "Intereses transferidos";
          invStore.put(inv);
        }
      };

      // Registrar transacci√≥n
      const transaccion = {
        cajero: usuarioSesion.usuario,
        cuenta: cuentaDestino,
        tipo: "Transferencia Intereses Inversi√≥n",
        monto: interes,
        moneda: moneda,
        referencia: `Intereses de inversi√≥n ${codigo} transferidos a ${cuentaDestino}`,
        fecha: new Date().toLocaleString()
      };
      guardarTransaccion(transaccion, null, "");

      alert(`‚úÖ Intereses (${moneda} ${interes.toFixed(2)}) transferidos a la cuenta ${cuentaDestino}.`);
    };
  };
}

// Modificar la funci√≥n de consulta para incluir botones de acci√≥n
function consultarCertificadoInversion() {
  const cuenta = document.getElementById("cuenta-consulta-inversion").value.trim();
  const resultadoDiv = document.getElementById("resultado-certificado");
  if (!cuenta) {
    alert("Ingrese el n√∫mero de cuenta vinculada.");
    return;
  }
  const trans = db.transaction(["inversiones"], "readonly");
  const store = trans.objectStore("inversiones");
  const index = store.index("cuentaVinculada");
  const request = index.openCursor(IDBKeyRange.only(cuenta));
  const inversiones = [];
  request.onsuccess = function(e) {
    const cursor = e.target.result;
    if (cursor) {
      inversiones.push(cursor.value);
      cursor.continue();
    } else {
      if (inversiones.length === 0) {
        resultadoDiv.classList.add("hidden");
        alert("No se encontraron inversiones para esta cuenta.");
        return;
      }
      let html = `<h4>Certificados de Inversi√≥n</h4>`;
      inversiones.forEach(inv => {
        const interes = inv.monto * (inv.tasaAnual / 100) * (inv.plazoDias / 360);
        const total = inv.monto + interes;
        const vencida = new Date() > new Date(inv.fechaVencimiento);
        const activa = inv.estado === "Activa";

        html += `
          <div style="border: 1px solid #0056b3; padding: 15px; margin: 10px 0; border-radius: 8px; background: #f8f9fa;">
            <strong>C√≥digo:</strong> ${inv.codigo}<br>
            <strong>Titular:</strong> ${inv.nombre}<br>
            <strong>Cuenta:</strong> ${inv.cuentaVinculada}<br>
            <strong>Moneda:</strong> ${inv.moneda}<br>
            <strong>Monto Invertido:</strong> ${inv.moneda} ${inv.monto.toFixed(2)}<br>
            <strong>Plazo:</strong> ${inv.plazoDias} d√≠as<br>
            <strong>Tasa Anual:</strong> ${inv.tasaAnual}%<br>
            <strong>Inter√©s Estimado:</strong> ${inv.moneda} ${interes.toFixed(2)}<br>
            <strong>Total al Vencimiento:</strong> ${inv.moneda} ${total.toFixed(2)}<br>
            <strong>Vencimiento:</strong> ${inv.fechaVencimiento}<br>
            <strong>Estado:</strong> ${inv.estado}<br><br>
        `;

        if (activa) {
          html += `<button onclick="renovarInversion(${JSON.stringify(inv).replace(/"/g, '&quot;')})" style="margin-right: 8px; background: #28a745; color: white; border: none; padding: 6px 10px; border-radius: 4px;">üîÑ Renovar</button>`;
          html += `<button onclick="retirarInversionAnticipadamente(${JSON.stringify(inv).replace(/"/g, '&quot;')})" style="margin-right: 8px; background: #dc3545; color: white; border: none; padding: 6px 10px; border-radius: 4px;">üí∏ Retiro anticipado</button>`;
        }
        if (vencida && activa) {
          html += `<button onclick="transferirIntereses(${JSON.stringify(inv).replace(/"/g, '&quot;')})" style="background: #17a2b8; color: white; border: none; padding: 6px 10px; border-radius: 4px;">üì§ Transferir intereses</button>`;
        }

        html += `</div>`;
      });
      resultadoDiv.innerHTML = html;
      resultadoDiv.classList.remove("hidden");
    }
  };
}

// (a) Informe de rendimiento de inversiones
function generarInformeRendimientoInversiones() {
  const resultadoDiv = document.getElementById("resultado-informe-inversiones");
  if (!resultadoDiv) {
    alert("‚ùå Contenedor de resultados no encontrado.");
    return;
  }

  const trans = db.transaction(["inversiones"], "readonly");
  const store = trans.objectStore("inversiones");
  const request = store.getAll();
  request.onsuccess = function() {
    const inversiones = request.result.filter(inv => inv.estado !== "Cerrada (Retiro anticipado)");
    if (inversiones.length === 0) {
      resultadoDiv.innerHTML = "<div class='alert'>No hay inversiones registradas.</div>";
      resultadoDiv.classList.remove("hidden");
      return;
    }

    // Agrupar por mes/a√±o de vencimiento
    const rendimientoPorMes = {};
    let totalInteres = 0;
    let totalMonto = 0;

    inversiones.forEach(inv => {
      const fechaVenc = new Date(inv.fechaVencimiento);
      const mesAnio = `${fechaVenc.getFullYear()}-${String(fechaVenc.getMonth() + 1).padStart(2, '0')}`;
      const interes = inv.monto * (inv.tasaAnual / 100) * (inv.plazoDias / 360);
      totalInteres += interes;
      totalMonto += inv.monto;

      if (!rendimientoPorMes[mesAnio]) {
        rendimientoPorMes[mesAnio] = { totalInteres: 0, totalMonto: 0, cantidad: 0 };
      }
      rendimientoPorMes[mesAnio].totalInteres += interes;
      rendimientoPorMes[mesAnio].totalMonto += inv.monto;
      rendimientoPorMes[mesAnio].cantidad += 1;
    });

    let html = `<h4>üìä Informe de Rendimiento de Inversiones</h4>`;
    html += `<p><strong>Total Invertido:</strong> RD$ ${totalMonto.toFixed(2)}</p>`;
    html += `<p><strong>Rendimiento Total Estimado:</strong> RD$ ${totalInteres.toFixed(2)}</p>`;
    html += `<p><strong>Rendimiento Promedio:</strong> ${(totalInteres / totalMonto * 100).toFixed(2)}%</p>`;
    html += `<h5>Desglose Mensual</h5><table style="width:100%; border-collapse: collapse; margin-top: 10px;">`;
    html += `<thead><tr style="background:#f1f1f1;"><th>Mes</th><th>Inversiones</th><th>Monto</th><th>Inter√©s</th><th>Rendimiento</th></tr></thead><tbody>`;

    Object.entries(rendimientoPorMes)
      .sort(([a], [b]) => a.localeCompare(b))
      .forEach(([mes, datos]) => {
        const rend = (datos.totalInteres / datos.totalMonto * 100).toFixed(2);
        html += `<tr>
          <td>${mes}</td>
          <td>${datos.cantidad}</td>
          <td>RD$ ${datos.totalMonto.toFixed(2)}</td>
          <td>RD$ ${datos.totalInteres.toFixed(2)}</td>
          <td>${rend}%</td>
        </tr>`;
      });

    html += `</tbody></table>`;
    resultadoDiv.innerHTML = html;
    resultadoDiv.classList.remove("hidden");
  };
}

// (b) Proyecci√≥n de vencimientos
function mostrarProyeccionVencimientos() {
  const resultadoDiv = document.getElementById("resultado-proyeccion-vencimientos");
  if (!resultadoDiv) {
    alert("‚ùå Contenedor de proyecci√≥n no encontrado.");
    return;
  }

  const hoy = new Date();
  const limite = new Date();
  limite.setDate(hoy.getDate() + 90); // Pr√≥ximos 90 d√≠as

  const trans = db.transaction(["inversiones"], "readonly");
  const store = trans.objectStore("inversiones");
  const request = store.getAll();
  request.onsuccess = function() {
    const inversiones = request.result
      .filter(inv => {
        const venc = new Date(inv.fechaVencimiento);
        return venc >= hoy && venc <= limite && inv.estado === "Activa";
      })
      .sort((a, b) => new Date(a.fechaVencimiento) - new Date(b.fechaVencimiento));

    if (inversiones.length === 0) {
      resultadoDiv.innerHTML = "<div class='alert'>No hay vencimientos programados en los pr√≥ximos 90 d√≠as.</div>";
      resultadoDiv.classList.remove("hidden");
      return;
    }

    let html = `<h4>üìÖ Proyecci√≥n de Vencimientos (Pr√≥ximos 90 d√≠as)</h4>`;
    html += `<table style="width:100%; border-collapse: collapse; margin-top: 10px;">`;
    html += `<thead><tr style="background:#f1f1f1;"><th>Fecha</th><th>C√≥digo</th><th>Cliente</th><th>Monto</th><th>Inter√©s</th><th>Total</th></tr></thead><tbody>`;

    inversiones.forEach(inv => {
      const interes = inv.monto * (inv.tasaAnual / 100) * (inv.plazoDias / 360);
      const total = inv.monto + interes;
      html += `<tr>
        <td>${inv.fechaVencimiento}</td>
        <td>${inv.codigo}</td>
        <td>${inv.nombre}</td>
        <td>${inv.moneda} ${inv.monto.toFixed(2)}</td>
        <td>${inv.moneda} ${interes.toFixed(2)}</td>
        <td>${inv.moneda} ${total.toFixed(2)}</td>
      </tr>`;
    });

    html += `</tbody></table>`;
    resultadoDiv.innerHTML = html;
    resultadoDiv.classList.remove("hidden");
  };
}

// (c) Exportar certificado de inversi√≥n como PDF
// (c) Exportar certificado de inversi√≥n como PDF
function exportarCertificadoInversionPDF(inversionData) {
  // Verificar si jsPDF est√° disponible a trav√©s del objeto global jspdf
  if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
    alert("‚ùå jsPDF no est√° cargado correctamente. Verifique la conexi√≥n a internet o la integridad del script.");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // Encabezado
  doc.setFontSize(18);
  doc.text("Certificado de Inversi√≥n", 105, 20, { align: "center" });
  doc.setFontSize(12);
  doc.text("Simubank - Sistema de Gesti√≥n Bancaria", 105, 28, { align: "center" });
  doc.setLineWidth(0.5);
  doc.line(15, 32, 195, 32);

  // Datos del certificado
  const yStart = 40;
  const lineHeight = 8;
  let y = yStart;

  const fields = [
    { label: "C√≥digo:", value: inversionData.codigo },
    { label: "Titular:", value: inversionData.nombre },
    { label: "Cuenta Vinculada:", value: inversionData.cuenta },
    { label: "Moneda:", value: inversionData.moneda },
    { label: "Monto Invertido:", value: `${inversionData.moneda} ${parseFloat(inversionData.monto).toFixed(2)}` },
    { label: "Plazo:", value: `${inversionData.plazo} d√≠as` },
    { label: "Tasa de Inter√©s Anual:", value: `${parseFloat(inversionData.tasa).toFixed(2)}%` },
    { label: "Inter√©s Estimado:", value: `${inversionData.moneda} ${parseFloat(inversionData.interes).toFixed(2)}` },
    { label: "Total al Vencimiento:", value: `${inversionData.moneda} ${parseFloat(inversionData.total).toFixed(2)}` },
    { label: "Fecha de Inicio:", value: inversionData.fechaInicio },
    { label: "Fecha de Vencimiento:", value: inversionData.fechaVencimiento }
  ];

  fields.forEach(field => {
    doc.setFont("helvetica", "bold");
    doc.text(field.label, 20, y);
    doc.setFont("helvetica", "normal");
    doc.text(field.value, 80, y);
    y += lineHeight;
  });

  // Pie de p√°gina
  y += 10;
  doc.setFont("helvetica", "italic");
  doc.setFontSize(10);
  doc.text("Documento generado electr√≥nicamente. No requiere firma.", 105, y, { align: "center" });

  // Guardar PDF
  const filename = `certificado_inversion_${inversionData.codigo}.pdf`;
  doc.save(filename);
}

// Modificar la funci√≥n mostrarModalCertificado para incluir bot√≥n de exportaci√≥n
function mostrarModalCertificado(datos) {
  const modalHtml = `
    <div id="modal-certificado" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 2000;">
      <div class="modal-content" style="background: white; padding: 30px; border-radius: 10px; width: 500px; max-width: 90%; text-align: left; font-family: 'Courier New', monospace;">
        <h3 style="text-align: center; color: #003366;">üìÑ Certificado de Inversi√≥n</h3>
        <hr>
        <p><strong>C√≥digo:</strong> ${datos.codigo}</p>
        <p><strong>Titular:</strong> ${datos.nombre}</p>
        <p><strong>Cuenta Vinculada:</strong> ${datos.cuenta}</p>
        <p><strong>Moneda:</strong> ${datos.moneda}</p>
        <p><strong>Monto Invertido:</strong> ${datos.moneda} ${parseFloat(datos.monto).toFixed(2)}</p>
        <p><strong>Plazo:</strong> ${datos.plazo} d√≠as</p>
        <p><strong>Tasa de Inter√©s Anual:</strong> ${parseFloat(datos.tasa).toFixed(2)}%</p>
        <p><strong>Inter√©s Estimado:</strong> ${datos.moneda} ${parseFloat(datos.interes).toFixed(2)}</p>
        <p><strong>Total al Vencimiento:</strong> ${datos.moneda} ${parseFloat(datos.total).toFixed(2)}</p>
        <p><strong>Fecha de Inicio:</strong> ${datos.fechaInicio}</p>
        <p><strong>Fecha de Vencimiento:</strong> ${datos.fechaVencimiento}</p>
        <hr>
        <div style="text-align: center; margin-top: 20px;">
          <button onclick="imprimirCertificado()" style="padding: 10px 20px; background: #0056b3; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">üñ®Ô∏è Imprimir</button>
          <button onclick="exportarCertificadoInversionPDF(${JSON.stringify(datos).replace(/"/g, '&quot;')})" style="padding: 10px 20px; background: #d9534f; color: white; border: none; border-radius: 5px; cursor: pointer;">üìÑ Exportar PDF</button>
          <button onclick="cerrarModalCertificado()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">Cerrar</button>
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

let chartTipoTransacciones = null;
let chartMonedas = null;
let chartEvolucion = null;

// Funci√≥n para mostrar el dashboard
function actualizarDashboard() {
  cargarDatosDashboard(); // carga el d√≠a de hoy por defecto
}

function cargarDashboardPorFecha() {
  const inputFecha = document.getElementById("fecha-dashboard").value;
  if (!inputFecha) {
    alert("Por favor, seleccione una fecha.");
    return;
  }
  const fechaFormateada = new Date(inputFecha).toLocaleDateString(); // Ej: "5/4/2025"
  cargarDatosDashboard(fechaFormateada);
}


function cargarDatosDashboard(fechaSeleccionada = null) {
  const fechaHoy = new Date().toLocaleDateString();
  const fechaFiltro = fechaSeleccionada || fechaHoy;

  // Actualizar el campo de fecha si es "hoy"
  if (!fechaSeleccionada) {
    const hoyISO = new Date().toISOString().split('T')[0];
    document.getElementById("fecha-dashboard").value = hoyISO;
  }

  // 1. Cargar transacciones del d√≠a seleccionado
  const transaccionesFiltradas = transacciones.filter(t => t.fecha.includes(fechaFiltro));

  // 2. Actualizar m√©tricas
  document.getElementById("total-transacciones-hoy").textContent = transaccionesFiltradas.length;
  // Calcular montos por moneda
const montosPorMoneda = { "RD$": 0, "USD": 0, "EUR": 0 };

transaccionesFiltradas.forEach(t => {
  // Transacciones normales (dep√≥sitos, retiros, pagos, etc.)
  if (montosPorMoneda.hasOwnProperty(t.moneda)) {
    montosPorMoneda[t.moneda] += t.monto;
  }

  // Transacciones de cambio de divisa: afectan montos en USD/EUR
  if (t.tipo === "Cambio de Divisa") {
    const divisa = t.divisa; // "USD" o "EUR"
    const cantidad = t.cantidadDivisa || 0;

    if (divisa === "USD" || divisa === "EUR") {
      // Si el cliente compra/vende divisa, se considera flujo en esa moneda
      montosPorMoneda[divisa] += cantidad;
    }
  }
});

// Actualizar los elementos del DOM
document.getElementById("monto-total-rd").textContent = `RD$ ${montosPorMoneda["RD$"].toFixed(2)}`;
document.getElementById("monto-total-usd").textContent = `USD ${montosPorMoneda["USD"].toFixed(2)}`;
document.getElementById("monto-total-eur").textContent = `EUR ${montosPorMoneda["EUR"].toFixed(2)}`;

  // 3. Generar gr√°ficos
  generarGraficosPorFecha(transaccionesFiltradas);

  // 4. Cargar otros contadores (√©stos no dependen de la fecha, pero los dejamos)
  cargarDatosPrestamos();
  cargarDatosTarjetas();
  cargarDatosCuentas();
}

// Actualizar las tarjetas de m√©tricas
function actualizarEstadisticasTransacciones(transacciones) {
  // Total de transacciones hoy
  document.getElementById("total-transacciones-hoy").textContent = transacciones.length;
  
  // Monto total hoy (solo RD$)
  const montoTotal = transacciones
    .filter(t => t.moneda === "RD$")
    .reduce((total, t) => total + t.monto, 0);
  document.getElementById("monto-total-hoy").textContent = `RD$ ${montoTotal.toFixed(2)}`;
}

function generarGraficosPorFecha(transacciones) {
  // --- Tipos de transacci√≥n ---
  const tipos = {};
  transacciones.forEach(t => {
    tipos[t.tipo] = (tipos[t.tipo] || 0) + 1;
  });

  // --- Monedas ---
 const monedas = { "RD$": 0, "USD": 0, "EUR": 0 };
transacciones.forEach(t => {
  // Contar por moneda principal (dep√≥sitos, retiros, pagos, etc.)
  if (monedas.hasOwnProperty(t.moneda)) {
    monedas[t.moneda]++;
  }

  // Contar tambi√©n operaciones de "Cambio de Divisa" como transacci√≥n en USD/EUR
  if (t.tipo === "Cambio de Divisa" && t.divisa && (t.divisa === "USD" || t.divisa === "EUR")) {
    monedas[t.divisa]++;
  }
});

  // --- √öltimos 7 d√≠as (independiente de la fecha seleccionada, opcional) ---
  const ultimos7Dias = obtenerTransaccionesUltimos7Dias();

  const colores = ['#007bff', '#28a745', '#dc3545', '#ffc107', '#17a2b8', '#6f42c1'];

  // Gr√°fico circular: tipos
  const ctxTipo = document.getElementById('chart-tipo-transacciones').getContext('2d');
  if (chartTipoTransacciones) chartTipoTransacciones.destroy();
  if (Object.keys(tipos).length === 0) {
    chartTipoTransacciones = new Chart(ctxTipo, {
      type: 'bar',
      data: { labels: ['Sin datos'], datasets: [{ data: [0], backgroundColor: ['#ccc'] }] },
      options: { plugins: { title: { display: true, text: 'Sin transacciones' } } }
    });
  } else {
    chartTipoTransacciones = new Chart(ctxTipo, {
      type: 'pie',
      data: {
        labels: Object.keys(tipos),
        datasets: [{ data: Object.values(tipos), backgroundColor: colores.slice(0, Object.keys(tipos).length) }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' },
          title: { display: true, text: 'Distribuci√≥n por Tipo' }
        }
      }
    });
  }

  // Gr√°fico de barras: monedas
  const ctxMonedas = document.getElementById('chart-monedas').getContext('2d');
  if (chartMonedas) chartMonedas.destroy();
  if (Object.keys(monedas).length === 0) {
    chartMonedas = new Chart(ctxMonedas, {
      type: 'bar',
      data: { labels: ['Sin datos'], datasets: [{ data: [0], backgroundColor: ['#ccc'] }] },
      options: { plugins: { title: { display: true, text: 'Sin transacciones' } } }
    });
  } else {
    chartMonedas = new Chart(ctxMonedas, {
      type: 'bar',
      data: {
        labels: Object.keys(monedas),
        datasets: [{ label: 'Transacciones', data: Object.values(monedas), backgroundColor: colores.slice(0, Object.keys(monedas).length) }]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });
  }

  // Gr√°fico de evoluci√≥n (se mantiene igual, con los √∫ltimos 7 d√≠as)
  const ctxEvolucion = document.getElementById('chart-evolucion').getContext('2d');
  if (chartEvolucion) chartEvolucion.destroy();
  chartEvolucion = new Chart(ctxEvolucion, {
    type: 'line',
    data: {
      labels: ultimos7Dias.labels,
      datasets: [{
        label: 'Transacciones por D√≠a',
        data: ultimos7Dias.data,
        borderColor: '#007bff',
        backgroundColor: 'rgba(0, 123, 255, 0.1)',
        borderWidth: 2,
        tension: 0.3,
        fill: true
      }]
    },
    options: {
      responsive: true,
      scales: { y: { beginAtZero: true } }
    }
  });
}

// Obtener transacciones de los √∫ltimos 7 d√≠as para el gr√°fico de evoluci√≥n
function obtenerTransaccionesUltimos7Dias() {
  const hoy = new Date();
  const ultimos7Dias = [];
  
  // Generar array con los √∫ltimos 7 d√≠as
  for (let i = 6; i >= 0; i--) {
    const fecha = new Date();
    fecha.setDate(hoy.getDate() - i);
    ultimos7Dias.push(fecha.toLocaleDateString());
  }
  
  // Contar transacciones por d√≠a
  const transaccionesPorDia = {};
  ultimos7Dias.forEach(dia => {
    transaccionesPorDia[dia] = 0;
  });
  
  // Contar transacciones
  const transaction = db.transaction(["transacciones"], "readonly");
  const store = transaction.objectStore("transacciones");
  const request = store.openCursor();
  
  request.onsuccess = function(e) {
    const cursor = e.target.result;
    if (cursor) {
      const transaccion = cursor.value;
      if (ultimos7Dias.includes(transaccion.fecha.split(',')[0])) {
        const fecha = transaccion.fecha.split(',')[0];
        transaccionesPorDia[fecha] = (transaccionesPorDia[fecha] || 0) + 1;
      }
      cursor.continue();
    } else {
      // Cuando terminamos, actualizamos el gr√°fico
      if (chartEvolucion) {
        chartEvolucion.data.labels = ultimos7Dias;
        chartEvolucion.data.datasets[0].data = ultimos7Dias.map(dia => transaccionesPorDia[dia]);
        chartEvolucion.update();
      }
    }
  };
  
  return {
    labels: ultimos7Dias,
    data: ultimos7Dias.map(dia => transaccionesPorDia[dia])
  };
}

// Cargar datos de pr√©stamos activos
function cargarDatosPrestamos() {
  const transaction = db.transaction(["prestamos"], "readonly");
  const store = transaction.objectStore("prestamos");
  const index = store.index("estado");
  const request = index.getAll("Aprobado");
  
  request.onsuccess = function() {
    const prestamosAprobados = request.result;
    document.getElementById("prestamos-activos").textContent = prestamosAprobados.length;
  };
}

// Cargar datos de tarjetas aprobadas
function cargarDatosTarjetas() {
  const transaction = db.transaction(["tarjetas"], "readonly");
  const store = transaction.objectStore("tarjetas");
  const index = store.index("estado");
  const request = index.getAll("Aprobada");
  
  request.onsuccess = function() {
    const tarjetasAprobadas = request.result;
    document.getElementById("tarjetas-aprobadas").textContent = tarjetasAprobadas.length;
  };
}

// Cargar datos de cuentas activas
function cargarDatosCuentas() {
  const transaction = db.transaction(["cuentas"], "readonly");
  const store = transaction.objectStore("cuentas");
  const request = store.count();
  
  request.onsuccess = function() {
    const totalCuentas = request.result;
    document.getElementById("cuentas-activas").textContent = totalCuentas;
  };
}

// Actualizar dashboard cada 30 segundos
setInterval(() => {
  if (document.getElementById("dashboard").classList.contains("active")) {
    actualizarDashboard();
  }
}, 30000);

// Cargar tarjetas con saldo pendiente (saldo > 0 y estado = Aprobada)
async function cargarTarjetasACobrar() {
  const container = document.getElementById("lista-tarjetas-acobrar");
  container.innerHTML = "<p>Cargando tarjetas pendientes de cobro...</p>";

  try {
    const trans = db.transaction(["tarjetas"], "readonly");
    const store = trans.objectStore("tarjetas");
    const request = store.openCursor();
    const tarjetasPendientes = [];

    request.onsuccess = function(e) {
      const cursor = e.target.result;
      if (cursor) {
        const t = cursor.value;
        // Solo incluir tarjetas aprobadas con saldo pendiente
        if (t.estado === "Aprobada" && (parseFloat(t.saldo) > 0)) {
          tarjetasPendientes.push(t);
        }
        cursor.continue();
      } else {
        if (tarjetasPendientes.length === 0) {
          container.innerHTML = "<div class='alert'>‚úÖ No hay tarjetas con saldo pendiente.</div>";
        } else {
          let html = `<div class="alert success">Se encontraron ${tarjetasPendientes.length} tarjetas con saldo pendiente.</div>`;
          tarjetasPendientes.forEach(t => {
            const numMask = "**** **** **** " + t.numero.slice(-4);
            html += `
              <div class="cuota-item" style="background:#fff3cd; border-left-color:#ffc107; margin:10px 0; padding:12px; border-radius:6px;">
                <strong>Tarjeta:</strong> ${numMask}<br>
                <strong>Titular:</strong> ${t.nombreTitular}<br>
                <strong>L√≠mite:</strong> RD$ ${parseFloat(t.limite).toFixed(2)}<br>
                <strong>Saldo Pendiente:</strong> <span style="color:#d9534f; font-weight:bold;">RD$ ${parseFloat(t.saldo).toFixed(2)}</span><br>
                <strong>Emisi√≥n:</strong> ${new Date(t.fechaEmision).toLocaleDateString()}<br>
                <button onclick="realizarCobroTarjetaPorId('${t.numero}')" style="margin-top:8px; background:#28a745; color:white; border:none; padding:5px 10px; border-radius:4px;">
                  üí≥ Registrar Cobro
                </button>
              </div>
            `;
          });
          container.innerHTML = html;
        }
      }
    };
    request.onerror = () => {
      container.innerHTML = "<div class='alert error'>‚ùå Error al cargar las tarjetas a cobrar.</div>";
    };
  } catch (err) {
    console.error("Error en cargarTarjetasACobrar:", err);
    container.innerHTML = "<div class='alert error'>‚ùå Error interno al cargar las tarjetas.</div>";
  }
}

// Funci√≥n auxiliar para ir al cobro (rellena el campo y cambia a la pesta√±a de cobro)
function realizarCobroTarjetaPorId(numeroTarjeta) {
  document.getElementById("numero-tarjeta-cobro").value = numeroTarjeta.replace(/\s/g, '');
  mostrarTabTarjeta('cobro');
}

function toggleCuentaCobroTarjeta() {
  const metodo = document.getElementById("metodo-cobro-tarjeta").value;
  const campoCuenta = document.getElementById("campo-cuenta-cobro");
  if (metodo === "cuenta") {
    campoCuenta.classList.remove("hidden");
  } else {
    campoCuenta.classList.add("hidden");
  }
}

function toggleCamposMetodoPago() {
  const metodo = document.getElementById("metodo-pago-servicio").value;
  const campoCuenta = document.getElementById("campo-cuenta-pago");
  const campoTarjeta = document.getElementById("campo-tarjeta-pago");

  campoCuenta.classList.add("hidden");
  campoTarjeta.classList.add("hidden");

  if (metodo === "cuenta") {
    campoCuenta.classList.remove("hidden");
  } else if (metodo === "tarjeta") {
    campoTarjeta.classList.remove("hidden");
  }
}
    </script>
  </div>
</body>
</html>
